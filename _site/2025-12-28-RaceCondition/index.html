<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>Race Conditions.</title>

  
  <meta name="author" content="German">
  

  <meta name="description" content="Race Condition notes from OST2 course.">

  

  

  
  <link rel="alternate" type="application/rss+xml" title="Home" href="http://localhost:4000/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  
    
      <link rel="stylesheet" href="/assets/css/custom-dark.css">
    
  

  
  
  

  

  
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="Race Conditions.">
  <meta property="og:description" content="Race Condition notes from OST2 course.">

  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="German">
  <meta property="og:article:published_time" content="2025-12-28T00:00:00-05:00">
  <meta property="og:url" content="http://localhost:4000/2025-12-28-RaceCondition/">
  <link rel="canonical" href="http://localhost:4000/2025-12-28-RaceCondition/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@Qvintvs1">
  <meta name="twitter:creator" content="@Qvintvs1">

  <meta property="twitter:title" content="Race Conditions.">
  <meta property="twitter:description" content="Race Condition notes from OST2 course.">

  

  

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("script[type='math/tex; mode=display']").forEach(function(el) {
      el.outerHTML = "\\[" + el.textContent + "\\]";
    });
    document.querySelectorAll("script[type='math/tex']").forEach(function(el) {
      el.outerHTML = "\\(" + el.textContent + "\\)";
    });
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
    script.async = true;
    document.head.appendChild(script);
  });
</script>


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="http://localhost:4000/">Home</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Program</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/Cpage">C</a>
                  <a class="dropdown-item" href="/DHARMApage">Dharma</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Web2</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/BURPSUITEpage">Burp</a>
                  <a class="dropdown-item" href="/THMpage">Thm</a>
                  <a class="dropdown-item" href="/HackTheBoxpage">Htb</a>
                  <a class="dropdown-item" href="/PEN200page">BasicPentesting</a>
                  <a class="dropdown-item" href="/REDTEAMBASICSpage">RedTeam</a>
                  <a class="dropdown-item" href="/BLUETEAMBASICSpage">Blueteam</a>
                  <a class="dropdown-item" href="/REDESpage">Net</a>
                  <a class="dropdown-item" href="/2022-11-17-GitBasics">Git</a>
                  <a class="dropdown-item" href="/CSOFTpage">MemCorrupt</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ZKP</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/MATHpage">Math</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
                  <a class="dropdown-item" href="/NOIRpage">Noir</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Assembly</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/ASSEMpage">x86</a>
            </div>
          </li>
        
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "P vs NP.", \
          "category" : "math", \
          "url"      : "/2026-01-11-PvsNP/", \
          "date"     : "January 11, 2026" \
        }, \
       \
        { \
          "title"    : "Race Conditions.", \
          "category" : "csoft", \
          "url"      : "/2025-12-28-RaceCondition/", \
          "date"     : "December 28, 2025" \
        }, \
       \
        { \
          "title"    : "Introducción al Cálculo", \
          "category" : "matemáticas", \
          "url"      : "/2025-12-25-MathTest/", \
          "date"     : "December 25, 2025" \
        }, \
       \
        { \
          "title"    : "Uninitialize Data Access.", \
          "category" : "csoft", \
          "url"      : "/2025-12-23-UDA/", \
          "date"     : "December 23, 2025" \
        }, \
       \
        { \
          "title"    : "Control Flow.", \
          "category" : "assem", \
          "url"      : "/2025-12-12-ControlFlow/", \
          "date"     : "December 12, 2025" \
        }, \
       \
        { \
          "title"    : "Other Integer Issues.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-OtherIntegerIssues/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Integer Overflow/Underflow.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-IntegerOverflow-Underflow/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Passing Parameters.", \
          "category" : "assem", \
          "url"      : "/2025-12-04-Passing-Parameters/", \
          "date"     : "December  4, 2025" \
        }, \
       \
        { \
          "title"    : "Stackframe; Local variables, Arrays and Structures.", \
          "category" : "assem", \
          "url"      : "/2025-12-01-LocalVars_Arrays_structs/", \
          "date"     : "December  1, 2025" \
        }, \
       \
        { \
          "title"    : "Out-Of-Bounds Write.", \
          "category" : "csoft", \
          "url"      : "/2025-11-26-Out-Of-Bounds-Write/", \
          "date"     : "November 26, 2025" \
        }, \
       \
        { \
          "title"    : "Calling Functions.", \
          "category" : "assem", \
          "url"      : "/2025-11-21-CallingFunctions/", \
          "date"     : "November 21, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Heap Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-18-HBO/", \
          "date"     : "November 18, 2025" \
        }, \
       \
        { \
          "title"    : "Basic Instructions.", \
          "category" : "assem", \
          "url"      : "/2025-11-17-AssemblyBasicRegisters/", \
          "date"     : "November 17, 2025" \
        }, \
       \
        { \
          "title"    : "Computer Registers.", \
          "category" : "assem", \
          "url"      : "/2025-11-08-ComputerRegisters/", \
          "date"     : "November  8, 2025" \
        }, \
       \
        { \
          "title"    : "CVE-2021-20294.", \
          "category" : "csoft", \
          "url"      : "/2025-11-07-CVE-2021-20294/", \
          "date"     : "November  7, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Stack Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-06-LSBO/", \
          "date"     : "November  6, 2025" \
        }, \
       \
        { \
          "title"    : "Text Editor.", \
          "category" : "C", \
          "url"      : "/2025-08-11-Text-Editor/", \
          "date"     : "August 11, 2025" \
        }, \
       \
        { \
          "title"    : "Garbage Collector.", \
          "category" : "C", \
          "url"      : "/2025-07-11-GarbageCollector/", \
          "date"     : "July 11, 2025" \
        }, \
       \
        { \
          "title"    : "Hashtables.", \
          "category" : "C", \
          "url"      : "/2025-06-13-HashTable/", \
          "date"     : "June 13, 2025" \
        }, \
       \
        { \
          "title"    : "Building my own malloc in C.", \
          "category" : "C", \
          "url"      : "/2025-06-09-BuildingOwnMalloc/", \
          "date"     : "June  9, 2025" \
        }, \
       \
        { \
          "title"    : "Malloc Tutorial", \
          "category" : "C", \
          "url"      : "/2025-06-06-MallocTutorial/", \
          "date"     : "June  6, 2025" \
        }, \
       \
        { \
          "title"    : "SharedLibraries&amp;FunctionHooking", \
          "category" : "C", \
          "url"      : "/2025-04-26-SharedLibraries&FunctionHooking/", \
          "date"     : "April 26, 2025" \
        }, \
       \
        { \
          "title"    : "File Descritors", \
          "category" : "C", \
          "url"      : "/2025-03-04-FileDescriptors/", \
          "date"     : "March  4, 2025" \
        }, \
       \
        { \
          "title"    : "Network Programming", \
          "category" : "C", \
          "url"      : "/2025-02-22-Network_Programming/", \
          "date"     : "February 22, 2025" \
        }, \
       \
        { \
          "title"    : "2. Constants and Literals in C.", \
          "category" : "C", \
          "url"      : "/2024-12-10-2.ConstantsinC-copy/", \
          "date"     : "December 10, 2024" \
        }, \
       \
        { \
          "title"    : "1. Basics of C", \
          "category" : "C", \
          "url"      : "/2024-12-02-1.BasicsOfC/", \
          "date"     : "December  2, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "DHA", \
          "url"      : "/2024-09-24-Dharma_Tutorial/", \
          "date"     : "September 24, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "fuzz", \
          "url"      : "/2024-03-22-Dharma_Tutorial-copy/", \
          "date"     : "March 22, 2024" \
        }, \
       \
        { \
          "title"    : "Mi experiencia con el OSCP", \
          "category" : "pen", \
          "url"      : "/2023-11-19-PEN200_Experience/", \
          "date"     : "November 19, 2023" \
        }, \
       \
        { \
          "title"    : "Client Side", \
          "category" : "pen", \
          "url"      : "/2023-11-17-17.Client_Side_Attacks/", \
          "date"     : "November 17, 2023" \
        }, \
       \
        { \
          "title"    : "Deep Packet Tunneling", \
          "category" : "pen", \
          "url"      : "/2023-11-16-16.Tunneling_Through_Deep_Packet_Inspection/", \
          "date"     : "November 16, 2023" \
        }, \
       \
        { \
          "title"    : "Report", \
          "category" : "pen", \
          "url"      : "/2023-11-15-15.Making_Reports/", \
          "date"     : "November 15, 2023" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "pen", \
          "url"      : "/2023-11-14-14.Metasploit/", \
          "date"     : "November 14, 2023" \
        }, \
       \
        { \
          "title"    : "Password Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-13-13.Password_Attacks/", \
          "date"     : "November 13, 2023" \
        }, \
       \
        { \
          "title"    : "Active Directory Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-12-12.Active_Directory_Attacks/", \
          "date"     : "November 12, 2023" \
        }, \
       \
        { \
          "title"    : "Port Forwarding", \
          "category" : "pen", \
          "url"      : "/2023-11-11-11.Port_Forwarding/", \
          "date"     : "November 11, 2023" \
        }, \
       \
        { \
          "title"    : "Privilege Escalation", \
          "category" : "pen", \
          "url"      : "/2023-11-10-10.Privilege_Escalation/", \
          "date"     : "November 10, 2023" \
        }, \
       \
        { \
          "title"    : "File Transfers", \
          "category" : "pen", \
          "url"      : "/2023-11-09-9.File_Tranfers/", \
          "date"     : "November  9, 2023" \
        }, \
       \
        { \
          "title"    : "Buffer Overflows", \
          "category" : "pen", \
          "url"      : "/2023-11-08-8.Buffer_Overflows/", \
          "date"     : "November  8, 2023" \
        }, \
       \
        { \
          "title"    : "Vulnerability Scanning.", \
          "category" : "pen", \
          "url"      : "/2023-11-07-7.Vulnerability_Scanning/", \
          "date"     : "November  7, 2023" \
        }, \
       \
        { \
          "title"    : "Information Gathering", \
          "category" : "pen", \
          "url"      : "/2023-11-06-6.Active_Information_Gathering/", \
          "date"     : "November  6, 2023" \
        }, \
       \
        { \
          "title"    : "Windows", \
          "category" : "pen", \
          "url"      : "/2023-11-05-5.Windows/", \
          "date"     : "November  5, 2023" \
        }, \
       \
        { \
          "title"    : "Networking", \
          "category" : "pen", \
          "url"      : "/2023-11-04-4.Networking/", \
          "date"     : "November  4, 2023" \
        }, \
       \
        { \
          "title"    : "Scripting", \
          "category" : "pen", \
          "url"      : "/2023-11-03-3.Scripting/", \
          "date"     : "November  3, 2023" \
        }, \
       \
        { \
          "title"    : "Practical Tools", \
          "category" : "pen", \
          "url"      : "/2023-11-02-2.PracticalTools/", \
          "date"     : "November  2, 2023" \
        }, \
       \
        { \
          "title"    : "Linux", \
          "category" : "pen", \
          "url"      : "/2023-11-01-1.Linux/", \
          "date"     : "November  1, 2023" \
        }, \
       \
        { \
          "title"    : "Easy", \
          "category" : "hack", \
          "url"      : "/2022-12-01-Easy/", \
          "date"     : "December  1, 2022" \
        }, \
       \
        { \
          "title"    : "Git Basics", \
          "category" : "", \
          "url"      : "/2022-11-17-GitBasics/", \
          "date"     : "November 17, 2022" \
        }, \
       \
        { \
          "title"    : "Tier I", \
          "category" : "hack", \
          "url"      : "/2022-11-10-Tier_1/", \
          "date"     : "November 10, 2022" \
        }, \
       \
        { \
          "title"    : "Tier 0", \
          "category" : "hack", \
          "url"      : "/2022-11-09-Tier_0/", \
          "date"     : "November  9, 2022" \
        }, \
       \
        { \
          "title"    : "7.BufferOverflow.", \
          "category" : "thm", \
          "url"      : "/2022-11-02-7.BufferOverflow/", \
          "date"     : "November  2, 2022" \
        }, \
       \
        { \
          "title"    : "6.Offensive Pentesting", \
          "category" : "thm", \
          "url"      : "/2022-11-01-6.OffensivePentesting/", \
          "date"     : "November  1, 2022" \
        }, \
       \
        { \
          "title"    : "5.RedTeam", \
          "category" : "thm", \
          "url"      : "/2022-10-30-5.RedTeam/", \
          "date"     : "October 30, 2022" \
        }, \
       \
        { \
          "title"    : "4.Windows", \
          "category" : "thm", \
          "url"      : "/2022-10-22-4.Windows/", \
          "date"     : "October 22, 2022" \
        }, \
       \
        { \
          "title"    : "3.Junior Penetrationtester path", \
          "category" : "thm", \
          "url"      : "/2022-09-02-3.JRPenetrationTester/", \
          "date"     : "September  2, 2022" \
        }, \
       \
        { \
          "title"    : "2.Complete Begginer path.", \
          "category" : "thm", \
          "url"      : "/2022-08-07-2.CompleteBegginer/", \
          "date"     : "August  7, 2022" \
        }, \
       \
        { \
          "title"    : "1.Pre-Security path.", \
          "category" : "thm", \
          "url"      : "/2022-07-11-1Pre-Security/", \
          "date"     : "July 11, 2022" \
        }, \
       \
        { \
          "title"    : "0.Scripting for pentesters.", \
          "category" : "thm", \
          "url"      : "/2022-07-10-0.Scripting_for_pentesters/", \
          "date"     : "July 10, 2022" \
        }, \
       \
        { \
          "title"    : "Burp Certified Practitioner Practice Exam.", \
          "category" : "burp", \
          "url"      : "/2022-03-30-PracticeExam/", \
          "date"     : "March 30, 2022" \
        }, \
       \
        { \
          "title"    : "22. OAuth Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-27-22.OAuth_authentication/", \
          "date"     : "March 27, 2022" \
        }, \
       \
        { \
          "title"    : "21. HTTP Request Smuggling.", \
          "category" : "burp", \
          "url"      : "/2022-03-26-21.HTTP_request_smuggling/", \
          "date"     : "March 26, 2022" \
        }, \
       \
        { \
          "title"    : "20. HTTP Host Header Attacks.", \
          "category" : "burp", \
          "url"      : "/2022-03-25-20.HTTP_Host_header_attacks/", \
          "date"     : "March 25, 2022" \
        }, \
       \
        { \
          "title"    : "19. Web Cache Poisoning.", \
          "category" : "burp", \
          "url"      : "/2022-03-24-19.Web_cache_poisoning/", \
          "date"     : "March 24, 2022" \
        }, \
       \
        { \
          "title"    : "18. Server-Side Template Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-23-18.Serve-side_template_injection/", \
          "date"     : "March 23, 2022" \
        }, \
       \
        { \
          "title"    : "17. Insecure Deserialization.", \
          "category" : "burp", \
          "url"      : "/2022-03-22-17.Insecure_deserialization/", \
          "date"     : "March 22, 2022" \
        }, \
       \
        { \
          "title"    : "16. WebSockets.", \
          "category" : "burp", \
          "url"      : "/2022-03-21-16.WebSockets/", \
          "date"     : "March 21, 2022" \
        }, \
       \
        { \
          "title"    : "15.DOM-based XSS vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-20-15-DOM-based_vulnerabilities/", \
          "date"     : "March 20, 2022" \
        }, \
       \
        { \
          "title"    : "14. Clickjacking.", \
          "category" : "burp", \
          "url"      : "/2022-03-19-14.Clickjacking/", \
          "date"     : "March 19, 2022" \
        }, \
       \
        { \
          "title"    : "13. Cross-Origin Resource Sharing.", \
          "category" : "burp", \
          "url"      : "/2022-03-18-13.Cross-origin_resource_sharing_(CORS)/", \
          "date"     : "March 18, 2022" \
        }, \
       \
        { \
          "title"    : "12. Cross-Site Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-17-12.Cross-site_request_forgery_(CSRF)/", \
          "date"     : "March 17, 2022" \
        }, \
       \
        { \
          "title"    : "11. Cross-Site Scripting.", \
          "category" : "burp", \
          "url"      : "/2022-03-16-11.Cross-site_scripting_(XSS)/", \
          "date"     : "March 16, 2022" \
        }, \
       \
        { \
          "title"    : "10. XXE Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-15-10.XXE_injection/", \
          "date"     : "March 15, 2022" \
        }, \
       \
        { \
          "title"    : "9. Server-Side Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-14-9.Server-side_request_forgery/", \
          "date"     : "March 14, 2022" \
        }, \
       \
        { \
          "title"    : "8. File Upload.", \
          "category" : "burp", \
          "url"      : "/2022-03-13-8.File_upload_vulnerabilities/", \
          "date"     : "March 13, 2022" \
        }, \
       \
        { \
          "title"    : "7. Access Control.", \
          "category" : "burp", \
          "url"      : "/2022-03-12-7.Access_control/", \
          "date"     : "March 12, 2022" \
        }, \
       \
        { \
          "title"    : "6. Information Disclosure.", \
          "category" : "burp", \
          "url"      : "/2022-03-11-6.Information_disclosure/", \
          "date"     : "March 11, 2022" \
        }, \
       \
        { \
          "title"    : "5. Bussiness Logic Vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-10-5.Business_logic_vulnerabilities/", \
          "date"     : "March 10, 2022" \
        }, \
       \
        { \
          "title"    : "4. Command Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-09-4.Command_Injection/", \
          "date"     : "March  9, 2022" \
        }, \
       \
        { \
          "title"    : "3. Directory Traversal.", \
          "category" : "burp", \
          "url"      : "/2022-03-08-3.Directory_Traversal/", \
          "date"     : "March  8, 2022" \
        }, \
       \
        { \
          "title"    : "2. Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-07-2.Authentication/", \
          "date"     : "March  7, 2022" \
        }, \
       \
        { \
          "title"    : "1. SQLInjection", \
          "category" : "burp", \
          "url"      : "/2022-03-06-1.SQLInjection/", \
          "date"     : "March  6, 2022" \
        }, \
       \
        { \
          "title"    : "Seguridad Perimetral", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Seguridad_Perimetral/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Hardening de sistemas", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Hardening_de_sistemas/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Bandit", \
          "category" : "otw", \
          "url"      : "/2022-02-08-Bandit/", \
          "date"     : "February  8, 2022" \
        }, \
       \
        { \
          "title"    : "Proxy", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Proxys/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Protocolos Relevantes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Protocolos_Importantes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Curso Básico Redes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Precurso_Redes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "IPs", \
          "category" : "redes", \
          "url"      : "/2022-02-07-IPs/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Movimientos Laterales", \
          "category" : "redteam", \
          "url"      : "/2022-02-06-Introducci%C3%B3n_a_movimientos_laterales/", \
          "date"     : "February  6, 2022" \
        }, \
       \
        { \
          "title"    : "Evasión de Defensas", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Evasi%C3%B3n_de_Defensas/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Escalada de privilegios", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Escalada_de_privilegios/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "redteam", \
          "url"      : "/2022-02-04-Metasploit_B%C3%A1sico/", \
          "date"     : "February  4, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a aplicaciones Android", \
          "category" : "redteam", \
          "url"      : "/2022-02-03-Ataques_aplicaciones_android/", \
          "date"     : "February  3, 2022" \
        }, \
       \
        { \
          "title"    : "Ataque a aplicaciones web.", \
          "category" : "redteam", \
          "url"      : "/2022-02-02-Ataques_a_aplicaciones_web/", \
          "date"     : "February  2, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a Infraestructuras y Redes", \
          "category" : "redteam", \
          "url"      : "/2022-02-01-Ataques_a_Infraestructuras_y_Redes/", \
          "date"     : "February  1, 2022" \
        }, \
       \
        { \
          "title"    : "Análisis de Objetivos", \
          "category" : "redteam", \
          "url"      : "/2022-01-28-An%C3%A1lisis_de_Objetivos/", \
          "date"     : "January 28, 2022" \
        }, \
       \
       \
        { \
          "title"    : "Assembly and Architecture Introduction.", \
          "category" : "page", \
          "url"      : "/ASSEMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Blueteam Basics", \
          "category" : "page", \
          "url"      : "/BLUETEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PortSwigger BurpSuite Course", \
          "category" : "page", \
          "url"      : "/BURPSUITEpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C-Family Software Memory Corruption Vulnerabilities", \
          "category" : "page", \
          "url"      : "/CSOFTpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C &amp; Systems Fundamentals.", \
          "category" : "page", \
          "url"      : "/Cpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Dharma Fuzzer language", \
          "category" : "page", \
          "url"      : "/DHARMApage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Exploiting &amp; Reversing", \
          "category" : "page", \
          "url"      : "/EXPREVpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Fuzzing JavaScript Engine", \
          "category" : "page", \
          "url"      : "/Fuzzpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "HackTheBox", \
          "category" : "page", \
          "url"      : "/HackTheBoxpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/MATHpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PEN200 notes", \
          "category" : "page", \
          "url"      : "/PEN200page/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Proyectos", \
          "category" : "page", \
          "url"      : "/PROJECTSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Networking Basics", \
          "category" : "page", \
          "url"      : "/REDESpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "RedTeam Basics", \
          "category" : "page", \
          "url"      : "/REDTEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Retired Machines", \
          "category" : "page", \
          "url"      : "/RetiredMachinespage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/THMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "About me", \
          "category" : "page", \
          "url"      : "/aboutme/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "THM", \
          "category" : "page", \
          "url"      : "/preOSCPpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/tags/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page2/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page3/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page4/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page5/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page6/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page7/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page8/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page9/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page10/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page11/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page12/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page13/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page14/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page15/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page16/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page17/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page18/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page19/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page20/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>Race Conditions.</h1>
          
            
              <h2 class="post-subheading">Race Condition notes from OST2 course.</h2>
            
          

          
            <span class="post-meta">Posted on December 28, 2025</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <h3 id="1-definition">1. Definition.</h3>

<h4 id="11-race-condition-definition">1.1. Race Condition definition.</h4>

<p><em>Race Condition</em> is a term than refers to a set of bugs which arises when the behavior of a system depends on the relative timing or ordering of events, and that timing isn’t properly controlled. The “race” is between two or more operations that need to happen in a specific order to produce correct results, but the system fails in guaranteeing that order.</p>

<p>A race condition emerges from a gap between checking a condition and acting on it. During that window—however brief—the state can change, invalidating the assumption your code just made.</p>

<p>Consider the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="s">"/tmp/data"</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Window of vulnerability here</span>
    <span class="n">open_and_read</span><span class="p">(</span><span class="s">"/tmp/data"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the gap between checking and opening the file, some other process can interfere with it as a shared object.</p>

<p>We difference between two types of races condition in this course:</p>

<ul>
  <li><strong>TOCTOU (Time-of-Check to Time-of-Use)</strong> — the example above. You check something, then use it, assuming the check remains valid.</li>
  <li><strong>Double Fetch</strong> — A double fetch occurs when kernel code reads the same user-space memory location twice, assuming the value remains constant between reads. Since user-space memory is under attacker control, a malicious thread can modify the value between the two fetches, breaking the kernel’s assumptions.</li>
</ul>

<p>The following diagram shows the TOCTOU race condition in-detail:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        PROCESS 1 (Victim)                    SHARED                   PROCESS 2 (Attacker)
              │                               RESOURCE (file)                 │
    Time      │                                  │                            │
      │       │                                  │                            │
      │       │  ┌─────────┐                     │                            │
      │       │  │ Verify()│                     │                            │
      │       │  │  Read ──────────────────────► │                            │
      │       │  └─────────┘                     │                            │
      │       │                                  │                            │
      │       │                                  |                            |
      │       │                                  │                            │
      │       │                                  │                            │
      │       │                                  |                            │
      │       │                                  |                            │
      │       │                                  |                            │
      │       │                                  │          Write             │
      │       │                                  │   ◄───────────────────     │
      │       │                                  │   (Attacker changes        │
      │       │                                  │    the resource)           │
      │       │                                  │                            │
      │       │              Write               │                            │ 
      │       │    ◄─────────────────────────    │  (Now operates on          │
      │       │                                  │   attacker-controlled      │
      │       │                                  │   resource!)               │
      │       │                                  │                            │
      │       │   TIME OF USE                    │                            │
      ▼       ▼                                  ▼                            ▼
</code></pre></div></div>

<p>If is well compassed, the writter can change the resource between the check and the use.</p>

<p><br /></p>

<h3 id="2-exercises">2. Exercises.</h3>

<h4 id="21-cve-2021-4207">2.1. CVE-2021-4207.</h4>

<p>QEMU is an emulation and virtualization system. In the context of this bug, it’s being used as a virtualization system, specifically via the use of the paravirtualized framebuffer video accelerator device, QXL. Paravirtualization is when you don’t run an unmodified OS within the hypervisor, but instead run a modified one, that is aware of the hypervisor, and takes actions to make virtualization easier.</p>

<p>In the context of this attack, the guest VM is the attacker, and the QEMU hypervisor is the target. The attacker wants to break out of the virtualization, and gain code execution on the enclosing host, by exploiting a vulnerability in QEMU.</p>

<p>Consider the following C code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QEMUCursor</span> <span class="o">*</span><span class="nf">cursor_alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">QEMUCursor</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">datasize</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">QEMUCursor</span><span class="p">)</span> <span class="o">+</span> <span class="n">datasize</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">qxl_unpack_chunks</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCIQXLDevice</span> <span class="o">*</span><span class="n">qxl</span><span class="p">,</span> <span class="n">QXLDataChunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">group_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">max_chunks</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">qxl_phys2virt</span><span class="p">(</span><span class="n">qxl</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">group_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">max_chunks</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_chunks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//XENO: cursor points to Guest OS shared memory, and is thus ACID</span>
<span class="k">static</span> <span class="n">QEMUCursor</span> <span class="o">*</span><span class="nf">qxl_cursor</span><span class="p">(</span><span class="n">PCIQXLDevice</span> <span class="o">*</span><span class="n">qxl</span><span class="p">,</span> <span class="n">QXLCursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">group_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">QEMUCursor</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">and_mask</span><span class="p">,</span> <span class="o">*</span><span class="n">xor_mask</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">cursor_alloc</span><span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">hot_x</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">hot_spot_x</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">hot_y</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">hot_spot_y</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">SPICE_CURSOR_TYPE_MONO</span><span class="p">:</span>
        <span class="cm">/* Assume that the full cursor is available in a single chunk. */</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cursor_get_mono_bpl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: bad monochrome cursor %ux%u with size %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                    <span class="n">__func__</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">and_mask</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
        <span class="n">xor_mask</span> <span class="o">=</span> <span class="n">and_mask</span> <span class="o">+</span> <span class="n">cursor_get_mono_bpl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
        <span class="n">cursor_set_mono</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">,</span> <span class="n">xor_mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">and_mask</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">qxl</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cursor_print_ascii_art</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">"qxl/mono"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SPICE_CURSOR_TYPE_ALPHA</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
        <span class="n">qxl_unpack_chunks</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">qxl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">,</span> <span class="n">group_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">qxl</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cursor_print_ascii_art</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">"qxl/alpha"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: not implemented: type %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                <span class="n">__func__</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>

<span class="nl">fail:</span>
    <span class="n">cursor_put</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Check that the cursor resource is fetched twice in the code.</p>

<ul>
  <li>
    <p>First, as parameters in the cursor_alloc() function, which returns a pointer to a cursor structu which some fields had been filled through the passed parameters:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">QEMUCursor</span> <span class="o">*</span><span class="nf">cursor_alloc</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">QEMUCursor</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">datasize</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

      <span class="n">c</span> <span class="o">=</span> <span class="n">g_malloc0</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">QEMUCursor</span><span class="p">)</span> <span class="o">+</span> <span class="n">datasize</span><span class="p">);</span>
      <span class="n">c</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
      <span class="n">c</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
      <span class="n">c</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="n">QEMUCursor</span> <span class="o">*</span><span class="nf">qxl_cursor</span><span class="p">(</span><span class="n">PCIQXLDevice</span> <span class="o">*</span><span class="n">qxl</span><span class="p">,</span> <span class="n">QXLCursor</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">group_id</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">QEMUCursor</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
      <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">and_mask</span><span class="p">,</span> <span class="o">*</span><span class="n">xor_mask</span><span class="p">;</span>
      <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

      <span class="n">c</span> <span class="o">=</span> <span class="n">cursor_alloc</span><span class="p">(</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
      <span class="c1">//...</span>
</code></pre></div>    </div>

    <p><br /></p>
  </li>
  <li>
    <p>Later, the code enters in a switch statement in which again access some cursor’s specific fields to fill a variable (size), and then all along with the previously crafted ‘c’ structure, it call qxl_unpack_chunks() function:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">//...</span>
  <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
  <span class="n">qxl_unpack_chunks</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">qxl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">chunk</span><span class="p">,</span> <span class="n">group_id</span><span class="p">);</span>
  <span class="c1">//...</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>This as a fact of matters constitutes a double fectch’s race condition vulnerability.</p>

<p>The code is accesing twice an user-controlled resources (cursor height and weight) assuming that this resource value is constant between the calls and in is relating those two value in the execution flow:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">qxl_unpack_chunks</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCIQXLDevice</span> <span class="o">*</span><span class="n">qxl</span><span class="p">,</span> <span class="n">QXLDataChunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">group_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">max_chunks</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">bytes</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="n">MIN</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">qxl_phys2virt</span><span class="p">(</span><span class="n">qxl</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">next_chunk</span><span class="p">,</span> <span class="n">group_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">max_chunks</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_chunks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Inside the function above, a memcpy() operation, which is including <em>bytes</em> bytes of chunk-&gt;data (cursor user-controlled data field) on dest + offset. Thus, since bytes comes from our second fetch of the controlled parameters <em>heigh</em> and <em>weight</em> and <em>dest + offset</em> is the c structure, previously allocated with the first fetch, there can be a missleading between the allocation space and the number of bytes being copied leading to a heap-buffer overflow.</p>

<p>Note that this do not enters on the TOCTOU group of Race Conditions since no check is being made, just the same value fetched twice on the same procedure.</p>

<p><br /></p>

<h4 id="22-cve-2020-7460">2.2. CVE-2020-7460.</h4>

<p>System calls are a mechanism for kernelspace to perform an action on userspace’s behalf. FreeBSD implements the sendmsg() system call, to send messages from sockets:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">ssize_t</span> <span class="nf">sendmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</code></pre></div></div>

<p>The <em>struct msghdr *msg parameter</em> has <em>void *msg_control</em> and <em>socklen_t msg_controllen</em> fields, which represent an ancillary data buffer in userspace that the kernel should process in <em>freebsd32_copyin_control()</em>. The anticipated layout of this memory is shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                          msg_control buffer                                 │
├───────────┬───────────┬───────────┬───────────┬───────────┬─────────────────┤
│  cmsg_len │  cmsg_len │  cmsg_len │  cmsg_len │  cmsg_len │    cmsg_len     │
│  (header) │   bytes   │  (header) │   bytes   │  (header) │     bytes       │
│           │  (data)   │           │  (data)   │           │    (data)       │
└───────────┴─────┬─────┴───────────┴─────┬─────┴───────────┴────────┬────────┘
                  │                       │                          │
                  ▼                       ▼                          ▼
            data length            data length                 data length
          derived from           derived from                derived from
             cmsg_len               cmsg_len                    cmsg_len
</code></pre></div></div>

<p>Consider now the following C code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//XENO: buf is an ACID address/contents userspace buffer, buflen is also ACID</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">freebsd32_copyin_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbuf</span> <span class="o">**</span><span class="n">mp</span><span class="p">,</span> <span class="n">caddr_t</span> <span class="n">buf</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">md</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">msglen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="n">buflen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="n">MCLBYTES</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="cm">/*
	 * Iterate over the buffer and get the length of each message
	 * in there. This has 32-bit alignment and padding. Use it to
	 * determine the length of these messages when using 64-bit
	 * alignment and padding.
	 */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">copyin</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msglen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msglen</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="n">msglen</span> <span class="o">=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">msglen</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">+=</span> <span class="n">msglen</span><span class="p">;</span>
		<span class="n">msglen</span> <span class="o">+=</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">))</span> <span class="o">-</span>
		    <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MCLBYTES</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">m_get</span><span class="p">(</span><span class="n">M_WAITOK</span><span class="p">,</span> <span class="n">MT_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MLEN</span><span class="p">)</span>
		<span class="n">MCLGET</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">M_WAITOK</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">m_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">md</span> <span class="o">=</span> <span class="n">mtod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">copyin</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msglen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">md</span><span class="p">;</span>
		<span class="n">msglen</span> <span class="o">=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>

		<span class="cm">/* Modify the message length to account for alignment. */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">md</span> <span class="o">=</span> <span class="n">msglen</span> <span class="o">+</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">))</span> <span class="o">-</span>
		    <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>

		<span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">md</span> <span class="o">+</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>

		<span class="n">msglen</span> <span class="o">-=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">copyin</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">md</span> <span class="o">+</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">msglen</span><span class="p">;</span>
			<span class="n">buflen</span> <span class="o">-=</span> <span class="n">msglen</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">m_free</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the code there are two fetches of data from the buffer:</p>

<ul>
  <li>
    <p>First, from the while loop, the program takes data from the userspace shared memory buffer onto the <em>msglen</em> memory address. In this first while loop, this extracted data ends up in the <em>len</em> variable which later will be part of the <em>m</em>’s structure length field <em>m-&gt;m_len = len;</em>:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span> <span class="o">=</span> <span class="n">copyin</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msglen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msglen</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
          <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">))</span>
          <span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
      <span class="n">msglen</span> <span class="o">=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">msglen</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span>
          <span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
      <span class="n">idx</span> <span class="o">+=</span> <span class="n">msglen</span><span class="p">;</span>
      <span class="n">msglen</span> <span class="o">+=</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">))</span> <span class="o">-</span>
          <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
      <span class="n">len</span> <span class="o">+=</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MCLBYTES</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>

  <span class="n">m</span> <span class="o">=</span> <span class="n">m_get</span><span class="p">(</span><span class="n">M_WAITOK</span><span class="p">,</span> <span class="n">MT_CONTROL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MLEN</span><span class="p">)</span>
      <span class="n">MCLGET</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">M_WAITOK</span><span class="p">);</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">m_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">md</span> <span class="o">=</span> <span class="n">mtod</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, a second while loop enters in which a second fetch happens and the potential modified data from the shared buffer endsup in <em>msglen</em>:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error</span> <span class="o">=</span> <span class="n">copyin</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="n">msglen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">md</span><span class="p">;</span>
      <span class="c1">//...</span>
      <span class="n">msglen</span> <span class="o">-=</span> <span class="n">FREEBSD32_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmsghdr</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">error</span> <span class="o">=</span> <span class="n">copyin</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">md</span> <span class="o">+</span> <span class="n">CMSG_ALIGN</span><span class="p">(</span><span class="n">msglen</span><span class="p">);</span>
          <span class="n">buf</span> <span class="o">+=</span> <span class="n">msglen</span><span class="p">;</span>
          <span class="n">buflen</span> <span class="o">-=</span> <span class="n">msglen</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Let’s observe carefully that in the first fetch a memory space gets alloced in md, later the data gets again retrieved from the buffer and is used to write data on the previous allocated space, if the first fetch allocates a small memory region, the second fetch could lead to a overcopy leading to a heapbuffer overflow.</p>

<p><br /></p>

<h4 id="23-cve-2021-34514-blackswan">2.3. CVE-2021-34514. “BlackSwan”.</h4>

<p>ALPC (Advanced Local Procedure Call) is a mechanism for communicating userspace to userspace, userspace to kernelspace, or kernelspace to kernelspace. Unlike the original LPC technology, ALPC is asynchronous, to improve performance through parallelism. Another performance improvement is using shared memory, to reduce data copy frequency.</p>

<p>Let’s check the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Heavily simplified pseudocode for the vulnerable function</span>
<span class="kt">void</span> <span class="nf">AlpcpCompleteDispatchMessage</span><span class="p">(</span><span class="n">_ALPC_DISPATCH_CONTEXT</span> <span class="o">*</span><span class="n">DispatchContext</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_ALPC_PORT</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">_KALPC_MESSAGE</span> <span class="o">*</span><span class="n">message</span><span class="p">;</span>
	<span class="n">_ALPC_COMPLETION_LIST</span> <span class="o">*</span><span class="n">completionList</span><span class="p">;</span>
	<span class="n">_ALPC_MESSAGE_ATTRIBUTES</span> <span class="o">*</span><span class="n">attributes</span><span class="p">;</span>
	<span class="n">_PORT_MESSAGE</span> <span class="o">*</span><span class="n">userMappedMessage</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">userMappedMessageData</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">completionBufferOffset</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">bufferLength</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">alignmentPadding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">DispatchContext</span><span class="o">-&gt;</span><span class="n">TargetPort</span><span class="p">;</span>
	<span class="n">message</span> <span class="o">=</span> <span class="n">DispatchContext</span><span class="o">-&gt;</span><span class="n">Message</span><span class="p">;</span>
	<span class="n">completionList</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">CompletionList</span><span class="p">;</span>
	<span class="n">bufferLength</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">PortMessage</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">s1</span><span class="p">.</span><span class="n">TotalLength</span><span class="p">;</span>
	<span class="n">bufferLength</span> <span class="o">+=</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeSize</span> <span class="o">+</span> <span class="n">alignmentPadding</span><span class="p">;</span>

	<span class="c1">// Finds free space in the completion list</span>
	<span class="n">completionBufferOffset</span> <span class="o">=</span> <span class="n">AlpcpAllocateCompletionBuffer</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bufferLength</span><span class="p">);</span>

	<span class="n">userMappedMessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">_PORT_MESSAGE</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">Data</span> <span class="o">+</span>
                                                       <span class="n">completionBufferOffset</span><span class="p">);</span>

	<span class="c1">// Message header is copied into shared user memory</span>
	<span class="o">*</span><span class="n">userMappedMessage</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">PortMessage</span><span class="p">;</span>
	<span class="n">userMappedMessageData</span> <span class="o">=</span> <span class="n">userMappedMessage</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="c1">// Copy message body into shared user memory</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">DataUserVa</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">){</span>
		<span class="n">AlpcpReadMessageData</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">userMappedMessageData</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">AlpcpGetDataFromUserVaSafe</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">userMappedMessageData</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeFlags</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="c1">// Calulate offset and copy attributes into shared user memory</span>
		<span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ALPC_MESSAGE_ATTRIBUTES</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span> <span class="p">(</span><span class="n">uintptr</span> <span class="n">t</span><span class="p">)</span> <span class="n">userMappedMessage</span> <span class="o">+</span>	<span class="n">userMappedMessage</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">s1</span><span class="p">.</span><span class="n">TotalLength</span> <span class="o">+</span> <span class="n">alignmentPadding</span><span class="p">);</span>

		<span class="n">attributes</span><span class="o">-&gt;</span><span class="n">AllocatedAttributes</span> <span class="o">=</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeFlags</span><span class="p">;</span>
		<span class="n">attributes</span><span class="o">-&gt;</span><span class="n">ValidAttributes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">AlpcpExposeAttributes</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeFlags</span><span class="p">,</span> <span class="n">attributes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Consider that the code is essentially using the information from the parameter to first allocate space for the message in what would be the first fetch:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bufferLength</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">PortMessage</span><span class="p">.</span><span class="n">u1</span><span class="p">.</span><span class="n">s1</span><span class="p">.</span><span class="n">TotalLength</span><span class="p">;</span> <span class="c1">//1st fetch</span>
<span class="n">bufferLength</span> <span class="o">+=</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeSize</span> <span class="o">+</span> <span class="n">alignmentPadding</span><span class="p">;</span>

<span class="c1">// Finds free space in the completion list</span>
<span class="n">completionBufferOffset</span> <span class="o">=</span> <span class="n">AlpcpAllocateCompletionBuffer</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bufferLength</span><span class="p">);</span>

<span class="n">userMappedMessage</span> <span class="o">=</span> <span class="p">(</span><span class="n">_PORT_MESSAGE</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">Data</span> <span class="o">+</span> <span class="n">completionBufferOffset</span><span class="p">);</span>
</code></pre></div></div>

<p>Is worth to mention that what is passed as a parameter is a memory address to a shared memory region and what is being assignated in the stackframe of the function are fields from the structure pointed by te address passed as a parameter, this are, essentially more address in the form of “address + offset”. This means that, despite this address being stored in the stackframe, this address referes to contents lying in a memory region the user controls and thus are suscetible to change between fetchs (race condition).</p>

<p>Then, the message is copied onto the alloced region in a second fetch:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Message header is copied into shared user memory</span>
<span class="o">*</span><span class="n">userMappedMessage</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">PortMessage</span><span class="p">;</span>
<span class="n">userMappedMessageData</span> <span class="o">=</span> <span class="n">userMappedMessage</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>

<span class="c1">// Copy message body into shared user memory</span>
<span class="k">if</span> <span class="p">(</span><span class="n">message</span><span class="o">-&gt;</span><span class="n">DataUserVa</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">){</span>
    <span class="n">AlpcpReadMessageData</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">userMappedMessageData</span><span class="p">);</span> <span class="c1">//2nd fetch</span>
<span class="p">}</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="n">AlpcpGetDataFromUserVaSafe</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">userMappedMessageData</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As we say before, the contents of the buffer may be changed between fetches, leading first to an underallocation and later changing the contents to lead to an overcopy trigerring a heap-buffer overflow.</p>

<p>There is also another posibility since there is a third fetch:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeFlags</span> <span class="o">!=</span> <span class="mh">0x0</span><span class="p">)</span>	<span class="p">{</span>
    <span class="c1">// Calulate offset and copy attributes into shared user memory</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ALPC_MESSAGE_ATTRIBUTES</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span> <span class="p">(</span><span class="n">uintptr</span> <span class="n">t</span><span class="p">)</span> <span class="n">userMappedMessage</span> <span class="o">+</span> <span class="n">userMappedMessage</span><span class="o">-&gt;</span><span class="n">u1</span><span class="p">.</span><span class="n">s1</span><span class="p">.</span><span class="n">TotalLength</span> <span class="o">+</span> <span class="n">alignmentPadding</span><span class="p">);</span>

    <span class="n">attributes</span><span class="o">-&gt;</span><span class="n">AllocatedAttributes</span> <span class="o">=</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeFlags</span><span class="p">;</span>
    <span class="n">attributes</span><span class="o">-&gt;</span><span class="n">ValidAttributes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">AlpcpExposeAttributes</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">completionList</span><span class="o">-&gt;</span><span class="n">AttributeFlags</span><span class="p">,</span> <span class="n">attributes</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#csoft">csoft</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=Race+Conditions.&url=http%3A%2F%2Flocalhost%3A4000%2F2025-12-28-RaceCondition%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2025-12-28-RaceCondition%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2025-12-28-RaceCondition%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2025-12-25-MathTest/" data-toggle="tooltip" data-placement="top" title="Introducción al Cálculo">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2026-01-11-PvsNP/" data-toggle="tooltip" data-placement="top" title="P vs NP.">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/Qv1nTv5" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/Qvintvs1" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/german-sanmillan-68b308229/" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        German
        &nbsp;&bull;&nbsp;
      
      2026

      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>


  
  
    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
