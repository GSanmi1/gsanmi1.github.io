<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>Text Editor.</title>

  
  <meta name="author" content="German">
  

  <meta name="description" content="Simple text exitor written in C.">

  

  

  
  <link rel="alternate" type="application/rss+xml" title="Home" href="http://localhost:4000/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  
    
      <link rel="stylesheet" href="/assets/css/custom-dark.css">
    
  

  
  
  

  

  
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="Text Editor.">
  <meta property="og:description" content="Simple text exitor written in C.">

  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="German">
  <meta property="og:article:published_time" content="2025-08-11T00:00:00-04:00">
  <meta property="og:url" content="http://localhost:4000/2025-08-11-Text-Editor/">
  <link rel="canonical" href="http://localhost:4000/2025-08-11-Text-Editor/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@Qvintvs1">
  <meta name="twitter:creator" content="@Qvintvs1">

  <meta property="twitter:title" content="Text Editor.">
  <meta property="twitter:description" content="Simple text exitor written in C.">

  

  

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("script[type='math/tex; mode=display']").forEach(function(el) {
      el.outerHTML = "\\[" + el.textContent + "\\]";
    });
    document.querySelectorAll("script[type='math/tex']").forEach(function(el) {
      el.outerHTML = "\\(" + el.textContent + "\\)";
    });
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
    script.async = true;
    document.head.appendChild(script);
  });
</script>


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="http://localhost:4000/">Home</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Program</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/Cpage">C</a>
                  <a class="dropdown-item" href="/DHARMApage">Dharma</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Web2</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/BURPSUITEpage">Burp</a>
                  <a class="dropdown-item" href="/THMpage">Thm</a>
                  <a class="dropdown-item" href="/HackTheBoxpage">Htb</a>
                  <a class="dropdown-item" href="/PEN200page">BasicPentesting</a>
                  <a class="dropdown-item" href="/REDTEAMBASICSpage">RedTeam</a>
                  <a class="dropdown-item" href="/BLUETEAMBASICSpage">Blueteam</a>
                  <a class="dropdown-item" href="/REDESpage">Net</a>
                  <a class="dropdown-item" href="/2022-11-17-GitBasics">Git</a>
                  <a class="dropdown-item" href="/CSOFTpage">MemCorrupt</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ZKP</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/MATHpage">Math</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
                  <a class="dropdown-item" href="/NOIRpage">Noir</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Assembly</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/ASSEMpage">x86</a>
            </div>
          </li>
        
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "P vs NP.", \
          "category" : "math", \
          "url"      : "/2026-01-11-PvsNP/", \
          "date"     : "January 11, 2026" \
        }, \
       \
        { \
          "title"    : "Race Conditions.", \
          "category" : "csoft", \
          "url"      : "/2025-12-28-RaceCondition/", \
          "date"     : "December 28, 2025" \
        }, \
       \
        { \
          "title"    : "Introducción al Cálculo", \
          "category" : "matemáticas", \
          "url"      : "/2025-12-25-MathTest/", \
          "date"     : "December 25, 2025" \
        }, \
       \
        { \
          "title"    : "Uninitialize Data Access.", \
          "category" : "csoft", \
          "url"      : "/2025-12-23-UDA/", \
          "date"     : "December 23, 2025" \
        }, \
       \
        { \
          "title"    : "Control Flow.", \
          "category" : "assem", \
          "url"      : "/2025-12-12-ControlFlow/", \
          "date"     : "December 12, 2025" \
        }, \
       \
        { \
          "title"    : "Other Integer Issues.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-OtherIntegerIssues/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Integer Overflow/Underflow.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-IntegerOverflow-Underflow/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Passing Parameters.", \
          "category" : "assem", \
          "url"      : "/2025-12-04-Passing-Parameters/", \
          "date"     : "December  4, 2025" \
        }, \
       \
        { \
          "title"    : "Stackframe; Local variables, Arrays and Structures.", \
          "category" : "assem", \
          "url"      : "/2025-12-01-LocalVars_Arrays_structs/", \
          "date"     : "December  1, 2025" \
        }, \
       \
        { \
          "title"    : "Out-Of-Bounds Write.", \
          "category" : "csoft", \
          "url"      : "/2025-11-26-Out-Of-Bounds-Write/", \
          "date"     : "November 26, 2025" \
        }, \
       \
        { \
          "title"    : "Calling Functions.", \
          "category" : "assem", \
          "url"      : "/2025-11-21-CallingFunctions/", \
          "date"     : "November 21, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Heap Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-18-HBO/", \
          "date"     : "November 18, 2025" \
        }, \
       \
        { \
          "title"    : "Basic Instructions.", \
          "category" : "assem", \
          "url"      : "/2025-11-17-AssemblyBasicRegisters/", \
          "date"     : "November 17, 2025" \
        }, \
       \
        { \
          "title"    : "Computer Registers.", \
          "category" : "assem", \
          "url"      : "/2025-11-08-ComputerRegisters/", \
          "date"     : "November  8, 2025" \
        }, \
       \
        { \
          "title"    : "CVE-2021-20294.", \
          "category" : "csoft", \
          "url"      : "/2025-11-07-CVE-2021-20294/", \
          "date"     : "November  7, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Stack Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-06-LSBO/", \
          "date"     : "November  6, 2025" \
        }, \
       \
        { \
          "title"    : "Text Editor.", \
          "category" : "C", \
          "url"      : "/2025-08-11-Text-Editor/", \
          "date"     : "August 11, 2025" \
        }, \
       \
        { \
          "title"    : "Garbage Collector.", \
          "category" : "C", \
          "url"      : "/2025-07-11-GarbageCollector/", \
          "date"     : "July 11, 2025" \
        }, \
       \
        { \
          "title"    : "Hashtables.", \
          "category" : "C", \
          "url"      : "/2025-06-13-HashTable/", \
          "date"     : "June 13, 2025" \
        }, \
       \
        { \
          "title"    : "Building my own malloc in C.", \
          "category" : "C", \
          "url"      : "/2025-06-09-BuildingOwnMalloc/", \
          "date"     : "June  9, 2025" \
        }, \
       \
        { \
          "title"    : "Malloc Tutorial", \
          "category" : "C", \
          "url"      : "/2025-06-06-MallocTutorial/", \
          "date"     : "June  6, 2025" \
        }, \
       \
        { \
          "title"    : "SharedLibraries&amp;FunctionHooking", \
          "category" : "C", \
          "url"      : "/2025-04-26-SharedLibraries&FunctionHooking/", \
          "date"     : "April 26, 2025" \
        }, \
       \
        { \
          "title"    : "File Descritors", \
          "category" : "C", \
          "url"      : "/2025-03-04-FileDescriptors/", \
          "date"     : "March  4, 2025" \
        }, \
       \
        { \
          "title"    : "Network Programming", \
          "category" : "C", \
          "url"      : "/2025-02-22-Network_Programming/", \
          "date"     : "February 22, 2025" \
        }, \
       \
        { \
          "title"    : "2. Constants and Literals in C.", \
          "category" : "C", \
          "url"      : "/2024-12-10-2.ConstantsinC-copy/", \
          "date"     : "December 10, 2024" \
        }, \
       \
        { \
          "title"    : "1. Basics of C", \
          "category" : "C", \
          "url"      : "/2024-12-02-1.BasicsOfC/", \
          "date"     : "December  2, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "DHA", \
          "url"      : "/2024-09-24-Dharma_Tutorial/", \
          "date"     : "September 24, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "fuzz", \
          "url"      : "/2024-03-22-Dharma_Tutorial-copy/", \
          "date"     : "March 22, 2024" \
        }, \
       \
        { \
          "title"    : "Mi experiencia con el OSCP", \
          "category" : "pen", \
          "url"      : "/2023-11-19-PEN200_Experience/", \
          "date"     : "November 19, 2023" \
        }, \
       \
        { \
          "title"    : "Client Side", \
          "category" : "pen", \
          "url"      : "/2023-11-17-17.Client_Side_Attacks/", \
          "date"     : "November 17, 2023" \
        }, \
       \
        { \
          "title"    : "Deep Packet Tunneling", \
          "category" : "pen", \
          "url"      : "/2023-11-16-16.Tunneling_Through_Deep_Packet_Inspection/", \
          "date"     : "November 16, 2023" \
        }, \
       \
        { \
          "title"    : "Report", \
          "category" : "pen", \
          "url"      : "/2023-11-15-15.Making_Reports/", \
          "date"     : "November 15, 2023" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "pen", \
          "url"      : "/2023-11-14-14.Metasploit/", \
          "date"     : "November 14, 2023" \
        }, \
       \
        { \
          "title"    : "Password Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-13-13.Password_Attacks/", \
          "date"     : "November 13, 2023" \
        }, \
       \
        { \
          "title"    : "Active Directory Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-12-12.Active_Directory_Attacks/", \
          "date"     : "November 12, 2023" \
        }, \
       \
        { \
          "title"    : "Port Forwarding", \
          "category" : "pen", \
          "url"      : "/2023-11-11-11.Port_Forwarding/", \
          "date"     : "November 11, 2023" \
        }, \
       \
        { \
          "title"    : "Privilege Escalation", \
          "category" : "pen", \
          "url"      : "/2023-11-10-10.Privilege_Escalation/", \
          "date"     : "November 10, 2023" \
        }, \
       \
        { \
          "title"    : "File Transfers", \
          "category" : "pen", \
          "url"      : "/2023-11-09-9.File_Tranfers/", \
          "date"     : "November  9, 2023" \
        }, \
       \
        { \
          "title"    : "Buffer Overflows", \
          "category" : "pen", \
          "url"      : "/2023-11-08-8.Buffer_Overflows/", \
          "date"     : "November  8, 2023" \
        }, \
       \
        { \
          "title"    : "Vulnerability Scanning.", \
          "category" : "pen", \
          "url"      : "/2023-11-07-7.Vulnerability_Scanning/", \
          "date"     : "November  7, 2023" \
        }, \
       \
        { \
          "title"    : "Information Gathering", \
          "category" : "pen", \
          "url"      : "/2023-11-06-6.Active_Information_Gathering/", \
          "date"     : "November  6, 2023" \
        }, \
       \
        { \
          "title"    : "Windows", \
          "category" : "pen", \
          "url"      : "/2023-11-05-5.Windows/", \
          "date"     : "November  5, 2023" \
        }, \
       \
        { \
          "title"    : "Networking", \
          "category" : "pen", \
          "url"      : "/2023-11-04-4.Networking/", \
          "date"     : "November  4, 2023" \
        }, \
       \
        { \
          "title"    : "Scripting", \
          "category" : "pen", \
          "url"      : "/2023-11-03-3.Scripting/", \
          "date"     : "November  3, 2023" \
        }, \
       \
        { \
          "title"    : "Practical Tools", \
          "category" : "pen", \
          "url"      : "/2023-11-02-2.PracticalTools/", \
          "date"     : "November  2, 2023" \
        }, \
       \
        { \
          "title"    : "Linux", \
          "category" : "pen", \
          "url"      : "/2023-11-01-1.Linux/", \
          "date"     : "November  1, 2023" \
        }, \
       \
        { \
          "title"    : "Easy", \
          "category" : "hack", \
          "url"      : "/2022-12-01-Easy/", \
          "date"     : "December  1, 2022" \
        }, \
       \
        { \
          "title"    : "Git Basics", \
          "category" : "", \
          "url"      : "/2022-11-17-GitBasics/", \
          "date"     : "November 17, 2022" \
        }, \
       \
        { \
          "title"    : "Tier I", \
          "category" : "hack", \
          "url"      : "/2022-11-10-Tier_1/", \
          "date"     : "November 10, 2022" \
        }, \
       \
        { \
          "title"    : "Tier 0", \
          "category" : "hack", \
          "url"      : "/2022-11-09-Tier_0/", \
          "date"     : "November  9, 2022" \
        }, \
       \
        { \
          "title"    : "7.BufferOverflow.", \
          "category" : "thm", \
          "url"      : "/2022-11-02-7.BufferOverflow/", \
          "date"     : "November  2, 2022" \
        }, \
       \
        { \
          "title"    : "6.Offensive Pentesting", \
          "category" : "thm", \
          "url"      : "/2022-11-01-6.OffensivePentesting/", \
          "date"     : "November  1, 2022" \
        }, \
       \
        { \
          "title"    : "5.RedTeam", \
          "category" : "thm", \
          "url"      : "/2022-10-30-5.RedTeam/", \
          "date"     : "October 30, 2022" \
        }, \
       \
        { \
          "title"    : "4.Windows", \
          "category" : "thm", \
          "url"      : "/2022-10-22-4.Windows/", \
          "date"     : "October 22, 2022" \
        }, \
       \
        { \
          "title"    : "3.Junior Penetrationtester path", \
          "category" : "thm", \
          "url"      : "/2022-09-02-3.JRPenetrationTester/", \
          "date"     : "September  2, 2022" \
        }, \
       \
        { \
          "title"    : "2.Complete Begginer path.", \
          "category" : "thm", \
          "url"      : "/2022-08-07-2.CompleteBegginer/", \
          "date"     : "August  7, 2022" \
        }, \
       \
        { \
          "title"    : "1.Pre-Security path.", \
          "category" : "thm", \
          "url"      : "/2022-07-11-1Pre-Security/", \
          "date"     : "July 11, 2022" \
        }, \
       \
        { \
          "title"    : "0.Scripting for pentesters.", \
          "category" : "thm", \
          "url"      : "/2022-07-10-0.Scripting_for_pentesters/", \
          "date"     : "July 10, 2022" \
        }, \
       \
        { \
          "title"    : "Burp Certified Practitioner Practice Exam.", \
          "category" : "burp", \
          "url"      : "/2022-03-30-PracticeExam/", \
          "date"     : "March 30, 2022" \
        }, \
       \
        { \
          "title"    : "22. OAuth Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-27-22.OAuth_authentication/", \
          "date"     : "March 27, 2022" \
        }, \
       \
        { \
          "title"    : "21. HTTP Request Smuggling.", \
          "category" : "burp", \
          "url"      : "/2022-03-26-21.HTTP_request_smuggling/", \
          "date"     : "March 26, 2022" \
        }, \
       \
        { \
          "title"    : "20. HTTP Host Header Attacks.", \
          "category" : "burp", \
          "url"      : "/2022-03-25-20.HTTP_Host_header_attacks/", \
          "date"     : "March 25, 2022" \
        }, \
       \
        { \
          "title"    : "19. Web Cache Poisoning.", \
          "category" : "burp", \
          "url"      : "/2022-03-24-19.Web_cache_poisoning/", \
          "date"     : "March 24, 2022" \
        }, \
       \
        { \
          "title"    : "18. Server-Side Template Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-23-18.Serve-side_template_injection/", \
          "date"     : "March 23, 2022" \
        }, \
       \
        { \
          "title"    : "17. Insecure Deserialization.", \
          "category" : "burp", \
          "url"      : "/2022-03-22-17.Insecure_deserialization/", \
          "date"     : "March 22, 2022" \
        }, \
       \
        { \
          "title"    : "16. WebSockets.", \
          "category" : "burp", \
          "url"      : "/2022-03-21-16.WebSockets/", \
          "date"     : "March 21, 2022" \
        }, \
       \
        { \
          "title"    : "15.DOM-based XSS vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-20-15-DOM-based_vulnerabilities/", \
          "date"     : "March 20, 2022" \
        }, \
       \
        { \
          "title"    : "14. Clickjacking.", \
          "category" : "burp", \
          "url"      : "/2022-03-19-14.Clickjacking/", \
          "date"     : "March 19, 2022" \
        }, \
       \
        { \
          "title"    : "13. Cross-Origin Resource Sharing.", \
          "category" : "burp", \
          "url"      : "/2022-03-18-13.Cross-origin_resource_sharing_(CORS)/", \
          "date"     : "March 18, 2022" \
        }, \
       \
        { \
          "title"    : "12. Cross-Site Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-17-12.Cross-site_request_forgery_(CSRF)/", \
          "date"     : "March 17, 2022" \
        }, \
       \
        { \
          "title"    : "11. Cross-Site Scripting.", \
          "category" : "burp", \
          "url"      : "/2022-03-16-11.Cross-site_scripting_(XSS)/", \
          "date"     : "March 16, 2022" \
        }, \
       \
        { \
          "title"    : "10. XXE Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-15-10.XXE_injection/", \
          "date"     : "March 15, 2022" \
        }, \
       \
        { \
          "title"    : "9. Server-Side Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-14-9.Server-side_request_forgery/", \
          "date"     : "March 14, 2022" \
        }, \
       \
        { \
          "title"    : "8. File Upload.", \
          "category" : "burp", \
          "url"      : "/2022-03-13-8.File_upload_vulnerabilities/", \
          "date"     : "March 13, 2022" \
        }, \
       \
        { \
          "title"    : "7. Access Control.", \
          "category" : "burp", \
          "url"      : "/2022-03-12-7.Access_control/", \
          "date"     : "March 12, 2022" \
        }, \
       \
        { \
          "title"    : "6. Information Disclosure.", \
          "category" : "burp", \
          "url"      : "/2022-03-11-6.Information_disclosure/", \
          "date"     : "March 11, 2022" \
        }, \
       \
        { \
          "title"    : "5. Bussiness Logic Vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-10-5.Business_logic_vulnerabilities/", \
          "date"     : "March 10, 2022" \
        }, \
       \
        { \
          "title"    : "4. Command Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-09-4.Command_Injection/", \
          "date"     : "March  9, 2022" \
        }, \
       \
        { \
          "title"    : "3. Directory Traversal.", \
          "category" : "burp", \
          "url"      : "/2022-03-08-3.Directory_Traversal/", \
          "date"     : "March  8, 2022" \
        }, \
       \
        { \
          "title"    : "2. Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-07-2.Authentication/", \
          "date"     : "March  7, 2022" \
        }, \
       \
        { \
          "title"    : "1. SQLInjection", \
          "category" : "burp", \
          "url"      : "/2022-03-06-1.SQLInjection/", \
          "date"     : "March  6, 2022" \
        }, \
       \
        { \
          "title"    : "Seguridad Perimetral", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Seguridad_Perimetral/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Hardening de sistemas", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Hardening_de_sistemas/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Bandit", \
          "category" : "otw", \
          "url"      : "/2022-02-08-Bandit/", \
          "date"     : "February  8, 2022" \
        }, \
       \
        { \
          "title"    : "Proxy", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Proxys/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Protocolos Relevantes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Protocolos_Importantes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Curso Básico Redes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Precurso_Redes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "IPs", \
          "category" : "redes", \
          "url"      : "/2022-02-07-IPs/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Movimientos Laterales", \
          "category" : "redteam", \
          "url"      : "/2022-02-06-Introducci%C3%B3n_a_movimientos_laterales/", \
          "date"     : "February  6, 2022" \
        }, \
       \
        { \
          "title"    : "Evasión de Defensas", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Evasi%C3%B3n_de_Defensas/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Escalada de privilegios", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Escalada_de_privilegios/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "redteam", \
          "url"      : "/2022-02-04-Metasploit_B%C3%A1sico/", \
          "date"     : "February  4, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a aplicaciones Android", \
          "category" : "redteam", \
          "url"      : "/2022-02-03-Ataques_aplicaciones_android/", \
          "date"     : "February  3, 2022" \
        }, \
       \
        { \
          "title"    : "Ataque a aplicaciones web.", \
          "category" : "redteam", \
          "url"      : "/2022-02-02-Ataques_a_aplicaciones_web/", \
          "date"     : "February  2, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a Infraestructuras y Redes", \
          "category" : "redteam", \
          "url"      : "/2022-02-01-Ataques_a_Infraestructuras_y_Redes/", \
          "date"     : "February  1, 2022" \
        }, \
       \
        { \
          "title"    : "Análisis de Objetivos", \
          "category" : "redteam", \
          "url"      : "/2022-01-28-An%C3%A1lisis_de_Objetivos/", \
          "date"     : "January 28, 2022" \
        }, \
       \
       \
        { \
          "title"    : "Assembly and Architecture Introduction.", \
          "category" : "page", \
          "url"      : "/ASSEMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Blueteam Basics", \
          "category" : "page", \
          "url"      : "/BLUETEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PortSwigger BurpSuite Course", \
          "category" : "page", \
          "url"      : "/BURPSUITEpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C-Family Software Memory Corruption Vulnerabilities", \
          "category" : "page", \
          "url"      : "/CSOFTpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C &amp; Systems Fundamentals.", \
          "category" : "page", \
          "url"      : "/Cpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Dharma Fuzzer language", \
          "category" : "page", \
          "url"      : "/DHARMApage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Exploiting &amp; Reversing", \
          "category" : "page", \
          "url"      : "/EXPREVpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Fuzzing JavaScript Engine", \
          "category" : "page", \
          "url"      : "/Fuzzpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "HackTheBox", \
          "category" : "page", \
          "url"      : "/HackTheBoxpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/MATHpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PEN200 notes", \
          "category" : "page", \
          "url"      : "/PEN200page/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Proyectos", \
          "category" : "page", \
          "url"      : "/PROJECTSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Networking Basics", \
          "category" : "page", \
          "url"      : "/REDESpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "RedTeam Basics", \
          "category" : "page", \
          "url"      : "/REDTEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Retired Machines", \
          "category" : "page", \
          "url"      : "/RetiredMachinespage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/THMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "About me", \
          "category" : "page", \
          "url"      : "/aboutme/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "THM", \
          "category" : "page", \
          "url"      : "/preOSCPpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/tags/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page2/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page3/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page4/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page5/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page6/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page7/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page8/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page9/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page10/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page11/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page12/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page13/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page14/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page15/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page16/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page17/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page18/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page19/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page20/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>Text Editor.</h1>
          
            
              <h2 class="post-subheading">Simple text exitor written in C.</h2>
            
          

          
            <span class="post-meta">Posted on August 11, 2025</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <h3 id="creating-a-text-editor-kilo">Creating a text editor: kilo.</h3>

<p>We are going to write a text editor in C. We are using the following Make file:</p>

<div class="language-make highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">kilo</span><span class="o">:</span> <span class="nf">kilo.c </span>
	<span class="p">$(</span>CC<span class="p">)</span> kilo.c <span class="nt">-o</span> kilo <span class="nt">-Wall</span> <span class="nt">-Wextra</span> <span class="nt">-pedantic</span> <span class="nt">-std</span><span class="o">=</span>c99
</code></pre></div></div>

<ol>
  <li>We are declaring that we want to build ‘kilo’ binary from ‘kilo.c’.</li>
  <li>
    <p>We are declaring the build command through the follwoing statements:</p>

    <ul>
      <li>$(CC) is a variable that make expands automatically to ‘cc’.</li>
      <li>‘Wall’ stands for “all Warnings”, and gets the compiler to warn you when it sees code in your program that might not technically be wrong, but is considered bad or questionable usage of the C language.</li>
      <li>‘Wextra’ and ‘pedantic’ turn on even more warnings.</li>
      <li>‘std=c99’ specifies the exact version of the C language standard we’re using.</li>
    </ul>
  </li>
</ol>

<p>This can be launched by writting ‘make’ in the terminal on the same folder. Is worth to mention that: It may output make: `kilo’ is up to date.. It can tell that the current version of kilo.c has already been compiled by looking at each file’s last-modified timestamp. If kilo was last modified after kilo.c was last modified, then make assumes that kilo.c has already been compiled, and so it doesn’t bother running the compilation command. If kilo.c was last modified after kilo was, then make recompiles kilo.c</p>

<p>This text exitor has been made using the following <a href="https://viewsourcecode.org/snaptoken/kilo/">guide</a>
<br /></p>

<h3 id="1-entering-raw-mode">1. Entering Raw Mode.</h3>

<h4 id="11-explaining-raw-mode">1.1. Explaining Raw Mode.</h4>

<p>In a text editor, <em>raw mode</em> disables the terminal’s standard input processing, allowing the application (the text editor) to directly receive and process each keystroke without any automatic handling like echoing or line buffering. This gives the editor complete control over input, enabling features like real-time cursor movement and custom keybindings.</p>

<p>Let’s start with the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code is including <em>unistd.h</em> file (which provides access to the POSIX API, the Linux OS API) and uses the <em>read()</em> syscall to read byte to byte from the standard input (STDIN_FILENO), this is our keyboard: file descriptor 0, into <em>c</em> variable and continuing until there is no more bytes to read. The <em>read()</em> function returns the number of bytes read, so in this case, the while loop continue undefinitively until no more data is available and 0 is returned.</p>

<p>If we make the file and try to run it, the terminal gets stucked listening to the standard input. The terminal by default starts in <em>cannonical mode</em>, this means that the terminal doesn’t send the standard input buffer until a signal is triggered (usually, the user press Enter key). This is pretty useful to go backwards a line and fix errors or delete characters but it doesn’t fit well in a text editor enviroment as we want to process each key as soon as is pressed. In summary, we want to achieve <em>raw mode</em> which is quite complex.</p>

<p><br /></p>

<h4 id="12-turning-off-echoing-modifying-terminals-attributes">1.2. Turning off echoing. Modifying terminal’s attributes.</h4>

<p>The ‘ECHO’ feature causes each typed key to be printed to the terminal. For obvious reasons, this is not ideal if we are trying to build an interface to enter a text editor and we should disable it. There are some programs that disable this feature like SUDO.</p>

<p>We can sett terminal’s attributes by:</p>

<ol>
  <li>Using <em>tcgetattr()</em> to read the current attributes into a termios struct.</li>
  <li>Modifying the struct by hand.</li>
  <li>Passing the modified struct to <em>tcsetattr()</em> to write the new terminal attributes back out.</li>
</ol>

<p>All of this implemented in a function after including <em>termios.h</em> header file:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">enableRawMode</span><span class="p">(){</span> 
    <span class="c1">//Define the termios struct and dump on it the attributes of the terminal referred to the STDIN filde.</span>
    <span class="k">struct</span> <span class="n">termios</span> <span class="n">raw</span><span class="p">;</span>
    <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>

    <span class="c1">//We change the value asigning to it the same value except for the negative of the ECHO one.</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span><span class="p">);</span>
    
    <span class="c1">//Then we apply the attributes of the raw struct to the STDIN filde of the terminal.</span>
    <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">'q'</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <em>enableRawMode()</em> function does exactly what we describe above.</p>

<ul>
  <li>First, we define the <em>termios</em> struct and filled up with the attributes of the STDIN filde of our terminal (STDIN_FILENO).</li>
  <li>
    <p>Then, the ECHO feature is a bitflag on <em>c_lflag</em> (local flags) field so we change it asigning to it the same value plus the negative value of the ECHO key; ~(ECHO).</p>

    <p>We should slow down in this step, <em>c_lflag</em> is a bitmask: It’s an integer where each bit represents a different terminal feature (ECHO, ICANON, ISIG, etc.), so, since the ECHO constant is defined in <em>termios.h</em> as a specific bit pattern that corresponds to the echo functionality, then only the ECHO feature is turned off and everything else remains the same.</p>

    <p>We can understand this in an ilustrative way by compiling and executing the following code:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
  <span class="kt">void</span> <span class="nf">print_binary</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">printf</span><span class="p">(</span><span class="s">"%d"</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="s">" "</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">print_termios_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">termios</span> <span class="o">*</span><span class="n">raw</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"=== TERMIOS STRUCTURE ANALYSIS ===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_iflag: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_iflag</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_oflag: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_oflag</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_cflag: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_lflag: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== c_lflag DETAILED ANALYSIS ===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_lflag value: %u</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_lflag binary: "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== INDIVIDUAL FLAGS IN c_lflag ===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ECHO flag value: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ECHO</span><span class="p">,</span> <span class="n">ECHO</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ECHO binary:     "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">ECHO</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"ICANON flag value: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ICANON</span><span class="p">,</span> <span class="n">ICANON</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ICANON binary:     "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">ICANON</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"ISIG flag value: %u (0x%x)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ISIG</span><span class="p">,</span> <span class="n">ISIG</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ISIG binary:       "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">ISIG</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">=== FLAG STATUS ===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ECHO is %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ECHO</span><span class="p">)</span> <span class="o">?</span> <span class="s">"ON"</span> <span class="o">:</span> <span class="s">"OFF"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ICANON is %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ICANON</span><span class="p">)</span> <span class="o">?</span> <span class="s">"ON"</span> <span class="o">:</span> <span class="s">"OFF"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ISIG is %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">raw</span><span class="o">-&gt;</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ISIG</span><span class="p">)</span> <span class="o">?</span> <span class="s">"ON"</span> <span class="o">:</span> <span class="s">"OFF"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">struct</span> <span class="n">termios</span> <span class="n">original</span><span class="p">,</span> <span class="n">modified</span><span class="p">;</span>
        
      <span class="c1">// Get current terminal settings</span>
      <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">original</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"ORIGINAL TERMINAL SETTINGS:</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_termios_flags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">original</span><span class="p">);</span>
        
      <span class="c1">// Make a copy to modify</span>
      <span class="n">modified</span> <span class="o">=</span> <span class="n">original</span><span class="p">;</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">=== BITWISE OPERATION DEMONSTRATION ===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"We want to turn OFF the ECHO flag using: c_lflag &amp;= ~(ECHO)</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"Step 1: Original c_lflag</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"c_lflag:     "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Step 2: ECHO flag</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ECHO:        "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">ECHO</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ECHO</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Step 3: ~(ECHO) - bitwise NOT of ECHO</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"~(ECHO):     "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="o">~</span><span class="n">ECHO</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">ECHO</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Step 4: c_lflag &amp; ~(ECHO) - AND operation</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ECHO</span><span class="p">;</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Result:      "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
        
      <span class="c1">// Actually perform the operation</span>
      <span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">MODIFIED TERMINAL SETTINGS (ECHO turned OFF):</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">print_termios_flags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modified</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n\n</span><span class="s">=== TURNING ECHO BACK ON ===</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"To turn ECHO back ON, we use: c_lflag |= ECHO</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"Current c_lflag: "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"ECHO flag:       "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">ECHO</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ECHO</span><span class="p">);</span>
        
      <span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">|=</span> <span class="n">ECHO</span><span class="p">;</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"After OR:        "</span><span class="p">);</span>
      <span class="n">print_binary</span><span class="p">(</span><span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">" (%u)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span><span class="p">);</span>
        
      <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">FINAL RESULT (ECHO turned back ON):</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"ECHO is %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">modified</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;</span> <span class="n">ECHO</span><span class="p">)</span> <span class="o">?</span> <span class="s">"ON"</span> <span class="o">:</span> <span class="s">"OFF"</span><span class="p">);</span>
        
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>    </div>

    <p>This will show the complete structure of the raw termios struct and the logic of the ECHO flag.</p>

    <pre><code class="language-less">  c_lflag: 35387 (0x8a3b)
  c_lflag binary: 1000 1010 0011 1011
  ECHO flag value: 8 (0x8)
  ECHO binary: 0000 0000 0000 1000 (8)
  ~(ECHO) binary: 1111 1111 1111 0111 (65527)
  Result:      1000 1010 0011 0011 (35379)
</code></pre>

    <p>So we are seeing the integer, then the binary representation in bits and the bit corresponding to the ECHO functionality is the first bit of the four quart, we get the binary mask of the negative ECHO and combine with the c_lflag by performing an AND (&amp;) operation.</p>
  </li>
</ul>

<p><br /></p>

<h4 id="13-disable-raw-mode-at-exit">1.3. Disable raw mode at exit.</h4>

<p>After the program quits, depending on your shell, you may find your terminal is still not echoing what you type. We can just press Ctrl-C to start a fresh line of input to your shell, and type in ‘reset’ and press ‘Enter’. This resets your terminal back to normal in most cases.</p>

<p>However, the ideal scenario is to restore the terminal’s original attributes when our program exists. For that, we will save a copu of the termios struct in teh original state and use <em>tcsetattr()</em> to reapply it to the terminal.</p>

<p>For that, we:</p>

<ul>
  <li>Include the <em>stdlib.h</em> header file, which provides access to various general-purpose functions, including memory allocation, process control, conversions, and random number generation.</li>
  <li>Then, we modify the <em>enableRawMode()</em> function subtly:
    <ul>
      <li>First with <em>tcgetattr()</em> we store the original attributes of the terminal in <em>orig_termios</em> struct.</li>
      <li>Then, we use the <em>exit handler</em> <em>atexit()</em> which calls the specified function (in this case disableRawMode, which applys original setting and is predefined) when programs exists. This form, we ensure whenever enableRawMode() is called and changes to the terminal are made, original state is restored at the end of the program.</li>
      <li>Lastly, we form another termios struct, modify manually and apply the changes with tcsetattr().</li>
    </ul>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">disableRawMode</span><span class="p">(){</span>
    <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">enableRawMode</span><span class="p">(){</span> 
    <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">);</span>
    <span class="n">atexit</span><span class="p">(</span><span class="n">disableRawMode</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">termios</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">orig_termios</span><span class="p">;</span>
    <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span><span class="p">);</span>
    <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">'q'</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="14-turn-off-canonical-mode">1.4. Turn off canonical mode.</h4>

<p>Along with ECHO flag, in stdlib there is also the ICANON constant that hanfles the cannonical mode, remember that this mode makes the terminal to hold the stdin buffer until the ENTER signal is send:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span><span class="p">);</span>
</code></pre></div></div>
<p>Applying logic ~(ECHO | ICANON) == ~(ECHO) &amp;&amp; ~(ICANON), so we are setting the c_lflag with ECHO and ICANON with negative values.</p>

<p>With this change, the input buffer of the terminal gets send as soon as gets filled with data, this means we will finally be reading input byte-by-byte, instead of line-by-line after user press ENTER.</p>

<p><br /></p>

<h4 id="14-display-keypresses">1.4. Display keypresses.</h4>

<p>To get an inner understanding of how raw mode works, we can print out every byte we read, to see that first, it dont get printed over the stdout (if we dont say so) and that is not necesary to press enter to send the stdin buffer into the program.</p>

<p>Let’s consider the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">disableRawMode</span><span class="p">(){</span>
    <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">enableRawMode</span><span class="p">(){</span> 
    <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">);</span>
    <span class="n">atexit</span><span class="p">(</span><span class="n">disableRawMode</span><span class="p">);</span>

    <span class="k">struct</span> <span class="n">termios</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">orig_termios</span><span class="p">;</span>
    <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>
    <span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span><span class="o">|</span><span class="n">ICANON</span><span class="p">);</span>
    <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">'q'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d ('%c')</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the code before, we include two new libraries:</p>

<ul>
  <li><strong>stdio.h</strong>: that provides functions to handle input/output data to the program.</li>
  <li><strong>ctype.g</strong>: that provides functions for testing and mapping characters.</li>
</ul>

<p>Stdio does not need presentation, but <em>ctype.h</em> header file declares several functions that are useful for testing and mapping characters. From this library, we import <em>iscntrl()</em> tests whether a character is a control character. Control characters are nonprintable characters that we don’t want to print to the screen. ASCII codes 0–31 are all control characters, and 127 is also a control character. ASCII codes 32–126 are all printable. (Check out the ASCII table to see all of the characters.)</p>

<p><em>printf()</em> can print multiple representations of a byte. %d tells it to format the byte as a decimal number (its ASCII code), and %c tells it to write out the byte directly, as a character.</p>

<p>This is a very useful program. It shows us how various keypresses translate into the bytes we read. Most ordinary keys translate directly into the characters they represent. But try seeing what happens when you press the arrow keys, or Escape, or Page Up, or Page Down, or Home, or End, or Backspace, or Delete, or Enter. Try key combinations with Ctrl, like Ctrl-A, Ctrl-B, etc:</p>

<pre><code class="language-less">$ ./rawmode
27
91 ('[')
65 ('A')
27
91 ('[')
67 ('C')
27
91 ('[')
66 ('B')
27
91 ('[')
68 ('D')
32 (' ')
127
97 ('a')
</code></pre>

<p><br /></p>

<h4 id="15-turnoff-ctrl-c-and-ctrl-z-signals">1.5. Turnoff Ctrl-C and Ctrl-Z signals.</h4>

<p>By default, ‘Ctrl-C’ and ‘Ctrl-Z’ send both SIGINT (terminate program) and SIGTSTP (suspend program) signals, both of them handled by the ISIG constant in c_lflag of the termios struct and we can disable it as we did above:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">);</span>
</code></pre></div></div>

<p>This lines disables those signals that, for now on can be read as 3 and 26 bytes.</p>

<p><br /></p>

<h4 id="16-disabling-ctrl-s-and-ctrl-q">1.6. Disabling Ctrl-S and Ctrl-Q.</h4>

<p>By default, Ctrl-S and Ctrl-Q are used for <em>software flow control</em> (). Ctrl-S stops data from being transmitted to the terminal until you press Ctrl-Q. This means that, in the code before, if you press Ctrl-S, then the program keep listening to the STDIN but stop sending to the program the incoming input until you press Ctrl-Q, then the buffer gets freed and introduces the data at once.</p>

<p>This feature is now contemplated in the IXON constant of the <em>c_iflag</em> (input flag):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IXON</span><span class="p">);</span>
</code></pre></div></div>

<p>Now Ctrl-S can be read as a 19 byte and Ctrl-Q can be read as a 17 byte.</p>

<p><br /></p>

<h4 id="17-disabling-ctrl-v">1.7. Disabling Ctrl-v</h4>

<p>On some systems, when you type Ctrl-V, the terminal waits for you to type another character and then sends that character literally. For example, before we disabled Ctrl-C, you might’ve been able to type Ctrl-V and then Ctrl-C to input a 3 byte.</p>

<p>We can turn off this feature using the IEXTEN flag in c_lflag.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">IEXTEN</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">);</span>
</code></pre></div></div>

<p>Ctrl-V can now be read as a 22 byte, and Ctrl-O as a 15 byte.</p>

<p><br /></p>

<h4 id="18-fix-ctrl-m">1.8. Fix Ctrl-M.</h4>

<p>If you run the program now and go through the whole alphabet while holding down Ctrl, you should see that we have every letter except M. Ctrl-M is weird: it’s being read as 10, when we expect it to be read as 13, since it is the 13th letter of the alphabet, and Ctrl-J already produces a 10. What else produces 10? The Enter key does.</p>

<p>It turns out that the terminal is helpfully translating any carriage returns (13, ‘\r’) inputted by the user into newlines (10, ‘\n’). Let’s turn off this feature by switching off the ICRLN constant on <em>c_iflag</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICRNL</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>
</code></pre></div></div>

<p>Now Ctrl-M is read as a 13 (carriage return), and the Enter key is also read as a 13.</p>

<p><br /></p>

<h4 id="19-turn-off-all-output-processing">1.9. Turn off all output processing.</h4>

<p>Also, as the terminal translates all ‘\r’ input to ‘\n’ it also translates all ‘\n’ outpud as ‘\r\n’. The terminal requires both of these characters in order to start a new line of text. The carriage return moves the cursor back to the beginning of the current line, and the newline moves the cursor down a line, scrolling the screen if necessary.</p>

<p>We will turn off all output processing features by turning off the OPOST cosntant of the c_oflag.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OPOST</span><span class="p">);</span>
</code></pre></div></div>

<p>In practice, the “\n” to “\r\n” translation is likely the only output processing feature turned on by default.</p>

<p>If you run the program now, you’ll see that the newline characters we’re printing are only moving the cursor down, and not to the left side of the screen:</p>

<pre><code class="language-less">$ ./kilo
115 ('s')
         115 ('s')
                  100 ('d')
                           97 ('a')
                                   115 ('s')
                                            100 ('d')
</code></pre>

<p>To fix that, let’s add carriage returns to our printf() statements:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">'q'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d ('%c')</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From now on, we’ll have to write out the full “\r\n” whenever we want to start a new line.</p>

<p><br /></p>

<h4 id="110-miscellaneous-flags">1.10. Miscellaneous flags.</h4>

<p>This step probably won’t have any observable effect for you, because these flags are either already turned off, or they don’t really apply to modern terminal emulators. But at one time or another, switching them off was considered (by someone) to be part of enabling “raw mode”, so we carry on the tradition (of whoever that someone was) in our program:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raw</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">INPCK</span> <span class="o">|</span> <span class="n">ISTRIP</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>
<span class="n">raw</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CS8</span><span class="p">);</span>
</code></pre></div></div>

<p>As far as I can tell:</p>

<ul>
  <li>When BRKINT is turned on, a break condition will cause a SIGINT signal to be sent to the program, like pressing Ctrl-C.</li>
  <li>INPCK enables parity checking, which doesn’t seem to apply to modern terminal emulators.</li>
  <li>ISTRIP causes the 8th bit of each input byte to be stripped, meaning it will set it to 0. This is probably already turned off.</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>CS8 is not a flag, it is a bit mask with multiple bits, which we set using the bitwise-OR (</td>
          <td>) operator unlike all the flags we are turning off. It sets the character size (CS) to 8 bits per byte. On my system, it’s already set that way.</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<p><br /></p>

<h4 id="111-a-timeout-for-read">1.11. A timeout for read().</h4>

<p>Currently, read() will wait indefinitely for input from the keyboard before it returns. What if we want to do something like animate something on the screen while waiting for user input? We can set a timeout, so that read() returns if it doesn’t get any input for a certain amount of time.</p>

<p>VMIN and VTIME come from <em>termios.h</em> header file. They are indexes into the c_cc field, which stands for “control characters”, an array of bytes that control various terminal settings.</p>

<ul>
  <li>
    <p>VMIN value sets the minimum number of bytes of input needed before read() can return. We set it to 0 so that read() returns as soon as there is any input to be read.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>VTIME value sets the maximum amount of time to wait before read() returns. It is in tenths of a second, so we set it to 1/10 of a second, or 100 milliseconds. If read() times out, it will return 0, which makes sense because its usual return value is the number of bytes read.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">enableRawMode</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">);</span>
  <span class="n">atexit</span><span class="p">(</span><span class="n">disableRawMode</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">orig_termios</span><span class="p">;</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">INPCK</span> <span class="o">|</span> <span class="n">ISTRIP</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OPOST</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CS8</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">IEXTEN</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d ('%c')</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'q'</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, the code acts as follows:</p>

<ul>
  <li>It implements a while loop in which we sett the char ‘c’ with ‘\0’ value and then read into ‘c’.</li>
  <li>Since we setup a timeout (VTIME), it will listen for a second and returns the number of bytes read</li>
  <li>Then the loops continues and print the ‘c’ char.</li>
</ul>

<p>If we let the terminal go untouched, it will spawn a 0 for a second until we keypress something to continue inmediately after.</p>

<p><br /></p>

<h4 id="112-error-handling">1.12. Error handling.</h4>

<p>After all the changes applied, enableRawMode() now gets fully into rawmode. Let’s add some error handling.</p>

<p>Most C library functions that fail will set the global <em>errno</em> (from errno.h) variable and prints a descriptive error for it. perror() (from stdio.h) looks at the <em>errno</em> global variable and printfs a descriptive error for it.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">perror</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After print the error, we exit the program.</p>

<p>Now, we have to modify our code to implement this error handling, for that, we know that all the variables returns an error code if something goes wrong, so we can match that code and trigger our error function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;ctype.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="c1"> //Error library</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="c1"> //Input-output library</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;termios.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span> 
  <span class="n">perror</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">disableRawMode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">//Error handling</span>
    <span class="n">die</span><span class="p">(</span><span class="s">"tcsetattr"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">enableRawMode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">orig_termios</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"tcgetattr"</span><span class="p">);</span> <span class="c1">//Error handling</span>
  <span class="n">atexit</span><span class="p">(</span><span class="n">disableRawMode</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">orig_termios</span><span class="p">;</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">INPCK</span> <span class="o">|</span> <span class="n">ISTRIP</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OPOST</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CS8</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">IEXTEN</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"tcsetattr"</span><span class="p">);</span> <span class="c1">//Error handling</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span> <span class="c1">//EAGAIN (Resource temporarily unavailable). Handle empty input operation.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"%d ('%c')</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'q'</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>On the last part, we also add a second condition, ‘errno != EAGAIN’, this is to prevent that read() trying to read an empty resource triggers an error since this is not a code error.
<br /></p>

<h3 id="2-raw-inputoutput">2. Raw Input/Output.</h3>

<h4 id="21-press-ctrl-q-to-quit">2.1. Press Ctrl-Q to quit.</h4>

<p>We see that ‘Ctrl’ key combined with the alphabetic keys seemed to map to bytes 1–26. We can use this to detect Ctrl key combinations and map them to different operations in our editor.</p>

<p>Our editor closes when we press ‘Q’, but the ideal sceneario is to close when we press ‘Ctrl + Q’. This input the value 17 to the program but a line like:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">17</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>Would be incomprehensive, so for clearity purposes we define the following macro:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define CTRL_KEY(k) ((k) &amp; 0x1f)
</span></code></pre></div></div>

<p>This macro just performs an AND operation over the bytes of an arbitrary key with the mask 0001111 (0x1f in hexadecimal, in C, you generally specify bitmasks using hexadecimal, since C doesn’t have binary literals, and hexadecimal is more concise and readable once you get used to it.). This operation sets the upper 3 bits of the character to 0 mirroring what Ctrl key does in the terminal.</p>

<p>Now, we can replace the quit sentence with a more comprehensive line:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="22-refractor-keyboard-input">2.2. Refractor keyboard input.</h4>

<p>Now we are going to make a function for low-level keypress reading and another function for mapping keypress to editor operations:</p>

<ul>
  <li><strong>editorReadKey()</strong>: This function’s job is to wait for one keypress, and return it. Later, we’ll expand this function to handle escape sequences, which involves reading multiple bytes that represent a single keypress, as is the case with the arrow keys.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="nf">editorReadKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

  <span class="c1">//Assign the read output to nread at the time, read waits for user's input.</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>editorProcessKeypress()</strong>: This functions waits for a keypress, and then handles it. Later, it will map various Ctrl key combinations and other special keys to different editor functions, and insert any alphanumeric and other printable keys’ characters into the text that is being edited.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="23-clear-the-screen">2.3. Clear the screen.</h4>

<p>Now we are going to start the renderization of the editor’s user interface after each keypress. Let’s start by clearing the terminal. In order to do that, we implement the following function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In summary, we are writing 4 bytes out to the terminal. The thing we are writting is called ‘ANSI escape sequence’; this a special code that controls terminal behavior instead of displaying text.</p>

<p>The first byte is ‘\x1b’, which is the escape character, or 27 in decimal. (Try and remember \x1b, we will be using it a lot.) The other three bytes are ‘[2J’.</p>

<ul>
  <li>The ‘[’ character is included because the escape character always is continued with ‘[’.</li>
  <li>The J is the command we are triggering which clears the screen.</li>
  <li>The 2 is the argument of the J command, which tells J to clear the entire Screen. (1 would clear the screen up to where the cursor is, and 0 would clear the screen from the cursor up to the end of the screen. Also, 0 is the default argument for J).</li>
</ul>

<p><br /></p>

<h4 id="24-reposition-the-cursor">2.4. Reposition the cursor.</h4>

<p>The ‘&lt;esc&gt;[2J’ command left the cursor at the bottom of the screen. Let’s reposition it at the top-left corner so that we’re ready to draw the editor interface from top to bottom.</p>

<p>The following line reposition the cursor on the left-top side:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
</code></pre></div></div>

<p>This again launch the escape sequence: ‘\x1b[’ followed by the command ‘H’ (Cursor Position) which have two argument, the raw and the column to position the cursor which happen to be by the default 1, the position ‘[1,1]’ happens to be the first row and column starting by the top and the left so we don’t add arguments.</p>

<p><br /></p>

<h4 id="25-clear-the-screen-on-exit">2.5. Clear the screen on exit.</h4>

<p>Let’s clear the screen and reposition the cursor when our program exits. If an error occurs in the middle of rendering the screen, we don’t want a bunch of garbage left over on the screen, and we don’t want the error to be printed wherever the cursor happens to be at that point.</p>

<p>So we add the two lines defined before in our <em>die()</em> function.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">die</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">perror</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Also, when we exit:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Is worth to mention that we could use <em>atexit()</em> to clear the screen when our program exits, but then the error message printed by <em>die()</em> would get erased right after printing it.</p>

<p><br /></p>

<h4 id="26-tildes">2.6. Tildes.</h4>

<p>Let’s draw a column of tildes (~) on the left hand side of the screen, like vim does. In our text editor, we’ll draw a tilde at the beginning of any lines that come after the end of the file being edited.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"~</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">//We remember that since we remove OPOST from c_oflag, '\n' is now '\r\n'.</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">();</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function <em>editorDrawRows()</em> writes over the terminal 3 bytes ‘~\r\n’ which is in fact a tilde ‘~’ and a salt line.</p>

<p>We reproduce this over 24 lines, then we include this function on the <em>editorRefreshScreen()</em> function to get</p>

<p><br /></p>

<h4 id="27-global-state">2.7. Global State.</h4>

<p>Our next goal is to get the size of the terminal, so we know how many rows to draw in editorDrawRows(). But first, let’s set up a global struct that will contain our editor state, which we’ll use to store the width and height of the terminal. For now, let’s just put our orig_termios global into the struct:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">editorConfig</span> <span class="n">E</span><span class="p">;</span>
</code></pre></div></div>

<p>Now we change our code to apply this change to the <em>disableRawMode()</em> and <em>enableRawMode()</em> function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">disableRawMode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">orig_termios</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">die</span><span class="p">(</span><span class="s">"tcsetattr"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">enableRawMode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcgetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">orig_termios</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"tcgetattr"</span><span class="p">);</span>
  <span class="n">atexit</span><span class="p">(</span><span class="n">disableRawMode</span><span class="p">);</span><span class="mi">1</span>

  <span class="k">struct</span> <span class="n">termios</span> <span class="n">raw</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">orig_termios</span><span class="p">;</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_iflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BRKINT</span> <span class="o">|</span> <span class="n">ICRNL</span> <span class="o">|</span> <span class="n">INPCK</span> <span class="o">|</span> <span class="n">ISTRIP</span> <span class="o">|</span> <span class="n">IXON</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_oflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OPOST</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CS8</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_lflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ECHO</span> <span class="o">|</span> <span class="n">ICANON</span> <span class="o">|</span> <span class="n">IEXTEN</span> <span class="o">|</span> <span class="n">ISIG</span><span class="p">);</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VMIN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">raw</span><span class="p">.</span><span class="n">c_cc</span><span class="p">[</span><span class="n">VTIME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">tcsetattr</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">TCSAFLUSH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">raw</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"tcsetattr"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we fail to get or set the original atributes from the <em>editorConfig</em> struct, we display an error alluding to <em>E.orig_termios</em>.</p>

<p><br /></p>

<h4 id="28-window-size-the-easy-way">2.8. Window size, the easy way.</h4>

<p>On most systems, you should be able to get the size of the terminal by simply calling <em>ioctl()</em> with the <em>TIOCGWINSZ</em> (Terminal IOCtl (Input/Output Control) Get WINdow SiZe) request.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">getWindowSize</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">rows</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">winsize</span> <span class="n">ws</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">cols</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span><span class="p">;</span>
    <span class="o">*</span><span class="n">rows</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_row</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This syscall is defined in <em>sys/ioctl.h</em> header for device-specific input/output operations (a device in linux is any object from we can read or we can write in, typically /dev/). With the <em>TIOCGWINSZ</em> request code it will dump the parameters of the deviced select by the first argument (the terminal in this case) on the structure ‘ws’. Then, we get the number of columns and rows from the terminal.</p>

<p>On failure, ioctl() returns -1.</p>

<p>Now, we can fill the terminal exactly with the dimension of the terminal window.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">getWindowSize</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">rows</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">winsize</span> <span class="n">ws</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">cols</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span><span class="p">;</span>
    <span class="o">*</span><span class="n">rows</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_row</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"~</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="n">initEditor</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="n">editorProcessKeypress</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="29-windows-size-the-hard-way">2.9. Windows size, the hard way.</h4>

<p>ioctl() isn’t guaranteed to be able to request the window size on all systems, so we are going to provide a fallback method of getting the window size.</p>

<p>The strategy is to position the cursor at the bottom-right of the screen, then use escape sequences that let us query the position of the cursor. That tells us how many rows and columns there must be on the screen.</p>

<p>First, if the <em>ioctl()</em> syscalls fails, we use two ANSI escape sequences:</p>

<ul>
  <li>’\x1b[999C’; Which uses the C command after the escape sequence to move 999 positions to the right.</li>
  <li>’\x1b[999C’; Which uses the B command after the escape sequence to move 999 positions down.</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">||</span> <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[999C</span><span class="se">\x1b</span><span class="s">[999B"</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>With this is almost sure that the cursos will end to the right and down as much as posible, then we only have to query the cursor position.</p>

<p>The reason we don’t use the ‘999;999H’ command is that the documentation doesn’t specify what happens when you try to move the cursor off-screen, but the C and B commands are specifically documented to stop the cursor from going past the edge of the screen</p>

<p>When you run the program, you should see the cursor is positioned at the bottom-right corner of the screen, and then when you press a key you’ll see the error message printed by die() after it clears the screen.</p>

<p>Now we get, the cursor position. The <em>n</em> command (Device Status Report) can be used to query the terminal for status information. We want to give it an argument of 6 to ask for the cursor position:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">getCursorPosition</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">rows</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">//Enter ANSI escape sequence to the terminal.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[6n"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="c1">//Read terminal's response and the ANSI escape sequence reply to buf.</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'R'</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

  <span class="c1">//Check the format of the string stored on buf.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\x1b'</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'['</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="c1">//Use sscanf() to enter those values on rows and cols.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">"%d;%d"</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">getWindowSize</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">rows</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cols</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">winsize</span> <span class="n">ws</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">TIOCGWINSZ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ws</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[999C</span><span class="se">\x1b</span><span class="s">[999B"</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">getCursorPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">cols</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_col</span><span class="p">;</span>
    <span class="o">*</span><span class="n">rows</span> <span class="o">=</span> <span class="n">ws</span><span class="p">.</span><span class="n">ws_row</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First, <em>getWindowSize()</em> (which is called with the pointers of rows and cols in order to be able to modify this variables with the result) attempt to use <em>ioctl()</em> syscall, if fails calls <em>getCursorPosition()</em> and pass to it the pointers it selves.</p>

<ul>
  <li>
    <p>This function try to write the following ANSI escape sequence “6n” to the terminal asking for the cursor position:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[6n"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>The terminal replies to the STDIN with another escape sequence something “\x1b[24;80R”. We read this reply with read() function and store it in <em>buf[i]</em>:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'R'</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="n">i</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>This loop reads from the STDIN to <em>buf[]</em> until the R char appears and then breaks, then sets the last slot as the string terminator char: ‘\0’.</p>
  </li>
  <li>
    <p>Lastly, we check the format of the escape sequence string in <em>buf[]</em></p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'\x1b'</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'['</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>And use <em>sscanf()</em> to read two integers separate by a semicolon (“%d;%d”), from the buf[2] position of the array and store each integer in rows and cols respectively:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">"%d;%d"</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>sscanf() reads buf starting from the third slot (buf[2]) and expect to encounter to integers separate by a semicolon “%d;%d”. Then introduce each integer in each variables (rows and cols).</p>
  </li>
</ul>

<p><br /></p>

<h4 id="210-append-buffer">2.10. Append buffer.</h4>

<p>It’s not a good idea to make a whole bunch of small write()’s every time we refresh the screen. It would be better to do one big write(), to make sure the whole screen updates at once. Otherwise there could be small unpredictable pauses between write()’s, which would cause an annoying flicker effect.</p>

<p>We want to replace all our write() calls with code that appends the string to a buffer, and then write() this buffer out at the end. Unfortunately, C doesn’t have dynamic strings, so we’ll create our own dynamic string type that supports one operation: appending.</p>

<p>Let’s start defining the abuf struct under it.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ABUF_INIT {NULL, 0}
</span>
<span class="k">struct</span> <span class="n">abuf</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Now, we define the abAppend() operation, abFree():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#define ABUF_INIT {NULL, 0}
</span>
<span class="k">struct</span> <span class="n">abuf</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">abAppend</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">[</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">ab</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
  <span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">abFree</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In summary:</p>

<ul>
  <li>First, we define the struct which consist in a pointer to char (string) and an integer which is presumibly the length of the string.</li>
  <li>
    <p>Then, we define a function that appends to a struct like before a new. For that:</p>

    <ul>
      <li>Gets the buff to append, the new string and the length of the new string.</li>
      <li>
        <p>Then, with realloc, we ask for a block of memory that is the size of the current string plus the size of the string we are appending:</p>

        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> <span class="c1">//Check realloc work properly.</span>
</code></pre></div>        </div>

        <p>This gets the pointer ‘b’ from the struct and redefine the alloced space for ‘b’ with the space before plus the len of the new string.</p>
      </li>
      <li>
        <p>Now, copy over the new alloced region the contents of the new string using memcpy and change the fields fo the struct:</p>

        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">[</span><span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="n">ab</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
<span class="n">ab</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p>This effectively place the string on the buffer in a bigger region and append to it the new string.</p>

<p>On the other hand, abFree() is a destructor that deallocates teh dynamic memory used by an abuf.</p>

<p>Now we can introduce this functionality in <em>editorDrawRows()</em> and <em>editorRefreshScreen()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">//Define struct.</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>

  <span class="c1">//Append escape sequence to clear screen.</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

  <span class="c1">//Append escape sequence to move the cursor top-left.</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">//Append the tildes.</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>

  <span class="c1">//Append the cursor again to the top-left </span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="c1">//Then, write the appended buffer to the terminal and free.</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="211-hide-the-cursor-when-repainting">2.11. Hide the cursor when repainting.</h4>

<p>Let’s hide the cursor before refreshing the screen, and show it again immediately after the refresh finishes. In order to do that, we are going to introduce the following lines:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</code></pre></div></div>

<p>The <em>h</em> and <em>l</em> commands are used to turn on and turn off various terminal features, the ‘?25’ refers to the cursor.</p>

<p><br /></p>

<h4 id="212-clear-lines-one-at-a-time">2.12. Clear lines one at a time.</h4>

<p>Instead of clearing the entire screen before each refresh, it seems more optimal to clear each line as we redraw them. Let’s remove the ‘[2J’ (clear entire screen) escape sequence, and instead put a ‘[K’ sequence at the end of each line we draw.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">// Write line be line</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

  <span class="c1">//Rewrite entire screen removed</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="213-welcome-message">2.13. Welcome message.</h4>

<p>Let’s display the name of our editor and a version number a third of the way down the screen:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define KILO_VERSION "0.0.1"
</span>
<span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//If the line is a third of the total.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

      <span class="c1">//Introduce the string into a buffer 'welcome' and returns the number of characters that would be written.</span>
      <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
        <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>

      <span class="c1">//We check the length of the welcome message fits in one single line, if dont fit we trunct the welcome message to fit within the  current window with.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>snprintf() comes from <em>stdio.h</em>.</p>

<p>We use the welcome buffer and snprintf() to interpolate our KILO_VERSION string into the welcome message. We also truncate the length of the string in case the terminal is too tiny to fit our welcome message.</p>

<p>Now, we try to center it:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
      <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
        <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="214-move-the-cursor">2.14. Move the cursor.</h4>

<p>Let’s focus on input now. We want the user to be able to move the cursor around. The first step is to keep track of the cursor’s x and y position in the global editor state.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>E.cx is the horizontal coordinate of the cursor (the column) and E.cy is the vertical coordinate (the row). We initialize both of them to 0, as we want the cursor to start at the top-left of the screen. (Since the C language uses indexes that start from 0, we will use 0-indexed values wherever possible.)</p>

<p>Now let’s add code to editorRefreshScreen() to move the cursor to the position stored in E.cx and E.cy.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

  <span class="c1">//We introduce on buf the escape sequence of the position of the cursor (top-left), and then append the buf.</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

  <span class="c1">//Append the escape sequence to return the position of the buff and write the buffer and free.</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This will be effectively move the cursor to the position stored in E.cy and E.cx.</p>

<p>Now we are going to implement a code that allows the user to move:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">char</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'a'</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'d'</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'w'</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'w'</span><span class="p">:</span>
    <span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span>
    <span class="k">case</span> <span class="sc">'a'</span><span class="p">:</span>
    <span class="k">case</span> <span class="sc">'d'</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>First, we read the keypress:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, we implement a switch statement:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
    <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">'w'</span><span class="p">:</span>
  <span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span>
  <span class="k">case</span> <span class="sc">'a'</span><span class="p">:</span>
  <span class="k">case</span> <span class="sc">'d'</span><span class="p">:</span>
    <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <ul>
      <li>‘Ctrl-q’ clears the screen and return the cursor to the top left of the screen.</li>
      <li>‘w’,’s’,’a’,d’ calls <em>editorMoveCursor()</em></li>
    </ul>
  </li>
</ul>

<p>The <em>editorMoveCursor()</em> function controls the cursor coordinates by manipulating <em>E.cx</em> and <em>E.cy</em> by one.</p>

<p><br /></p>

<h4 id="215-arrow-keys">2.15. Arrow keys.</h4>

<p>Now that we have a way of mapping keypresses to move the cursor, let’s replace the wasd keys with the arrow keys. Last chapter we saw that pressing an arrow key sends multiple bytes as input to our program. These bytes are in the form of an escape sequence that starts with ‘\x1b’, ‘[’, followed by an ‘A’, ‘B’, ‘C’, or ‘D’ depending on which of the four arrow keys was pressed.</p>

<p>Let’s modify editorReadKey() to read escape sequences of this form as a single keypress.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="nf">editorReadKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="sc">'w'</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="sc">'s'</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="sc">'d'</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="sc">'a'</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code acts as follows:</p>

<ul>
  <li>First, read one byte from the STDIN. If the byte readed is the start of an escape sequence then read the next bytes, if not we return the readed char.</li>
  <li>If the second byte is the second part of the escape sequence (‘[’), then read the third byte.</li>
  <li>Then, as we said above, if the third byte is A,B,C,D we return w,s,d,a if not if either of these reads time out (after 0.1 seconds), then we assume the user just pressed the Escape key and return that.</li>
</ul>

<p>Note that the seq buffer is slightly longer than we need (two bytes longer), this is because we will be handling longer escape sequences in the future.</p>

<p>We have basically aliased the arrow keys to the wasd keys. This gets the arrow keys working immediately, but leaves the wasd keys still mapped to the editorMoveCursor() function. What we want is for editorReadKey() to return special values for each arrow key that let us identify that a particular arrow key was pressed.</p>

<p>Let’s start by replacing each instance of the wasd characters with the constants ARROW_UP, ARROW_LEFT, ARROW_DOWN, and ARROW_RIGHT:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*** defines ***/</span>
<span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span>
  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="sc">'a'</span><span class="p">,</span>
  <span class="n">ARROW_RIGHT</span> <span class="o">=</span> <span class="sc">'d'</span><span class="p">,</span>
  <span class="n">ARROW_UP</span> <span class="o">=</span> <span class="sc">'w'</span><span class="p">,</span>
  <span class="n">ARROW_DOWN</span> <span class="o">=</span> <span class="sc">'s'</span>
<span class="p">};</span>
</code></pre></div></div>

<p>An enum defines a set of named integer constants, we use them into the code defined before:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="nf">editorReadKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_UP</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_DOWN</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_RIGHT</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_LEFT</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">char</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we just have to choose a representation for arrow keys that doesn’t conflict with wasd, in the editorKey enum. We will give them a large integer value that is out of the range of a char, so that they don’t conflict with any ordinary keypresses.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span>
  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="n">ARROW_RIGHT</span><span class="p">,</span>
  <span class="n">ARROW_UP</span><span class="p">,</span>
  <span class="n">ARROW_DOWN</span>
<span class="p">};</span>
</code></pre></div></div>

<p>By setting the first constant in the enum to 1000, the rest of the constants get incrementing values of 1001, 1002, 1003, and so on.</p>

<p>We will also have to change all variables that store keypresses to be of type int instead of char.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">editorReadKey</span><span class="p">()</span>
<span class="kt">void</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="216-prevent-moving-the-cursor-off-screen">2.16. Prevent moving the cursor off screen.</h4>

<p>Currently, you can cause the E.cx and E.cy values to go into the negatives, or go past the right and bottom edges of the screen. Let’s prevent that by doing some bounds checking in editorMoveCursor():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="217-the-page-up-and-page-down-keys">2.17. The Page Up and Page Down keys.</h4>

<p>To complete our low-level terminal code, we need to detect a few more special keypresses that use escape sequences, like the arrow keys did. We’ll start with the Page Up and Page Down keys.</p>

<p>Page Up is sent as ‘5~’ and Page Down is sent as ‘6~’. First we add to our enum list:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span>
  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="n">ARROW_RIGHT</span><span class="p">,</span>
  <span class="n">ARROW_UP</span><span class="p">,</span>
  <span class="n">ARROW_DOWN</span><span class="p">,</span>
  <span class="n">PAGE_UP</span><span class="p">,</span>
  <span class="n">PAGE_DOWN</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Now we modify the <em>editorReadKey()</em> function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">editorReadKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'~'</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="sc">'5'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_UP</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_DOWN</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_UP</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_DOWN</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_RIGHT</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_LEFT</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We modify the part in which we detect the user’s input is an escape sequence and introduce a new if statement:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'~'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">case</span> <span class="sc">'5'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_UP</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_DOWN</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_UP</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_DOWN</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_RIGHT</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_LEFT</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>First, detect the next byte and if is between 0 and 9, we read the next byte, if not, we assume is an ARROW KEY.</li>
  <li>Then, we check the next byte and see if it is a ‘~’.</li>
  <li>If it is, then read the byte before and check if it is a 5 or a 6 and then we return PAGE_UP and PAGE_DOWN.</li>
</ul>

<p>This efectively catch when we press PAGE_UP and PAGE_DOWN and makes the function <em>editorReadKey()</em> to effectively return it.</p>

<p>Now, we have to define the behaviour of our terminal when we press PAGE_UP and PAGE_DOWN:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This introduces on the switch statement the PAGE_UP and the PAGE_DOWN cases in the same way (since there is no break between them).</p>

<p>Then, it introduces the number of rows of the screen <em>E.screenrows</em> on times and implements a while loop in which, while times is greater than 0 (0 is equals to False), calls <em>editorMoveCursor()</em> with the following line:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span>
</code></pre></div></div>

<p>This line performs as follows: if ‘c’ is PAGE_UP, then the statement takes the value of ARROW_UP (which remember is an enum value defined above) and if not, takes the value ARROW_DOWN.</p>

<p><br /></p>

<h4 id="218-the-home-and-end-keys">2.18. The Home and End keys.</h4>

<p>Now let’s implement the Home and End keys. Like the previous keys, these keys also send escape sequences. Unlike the previous keys, there are many different escape sequences that could be sent by these keys, depending on your OS, or your terminal emulator.</p>

<p>The Home key could be sent as ‘[1~’, ‘[7~’, ‘[H’, or ‘OH’. Similarly, the End key could be sent as ‘[4~’, ‘[8~’, ‘[F’, or ‘OF’.</p>

<p>First, we define the enum values:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span>
  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="n">ARROW_RIGHT</span><span class="p">,</span>
  <span class="n">ARROW_UP</span><span class="p">,</span>
  <span class="n">ARROW_DOWN</span><span class="p">,</span>
  <span class="n">HOME_KEY</span><span class="p">,</span>
  <span class="n">END_KEY</span><span class="p">,</span>
  <span class="n">PAGE_UP</span><span class="p">,</span>
  <span class="n">PAGE_DOWN</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Now we implement the catch of those enum values on <em>editorReadKey()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">editorReadKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'~'</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="sc">'1'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'4'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'5'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_UP</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_DOWN</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'7'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'8'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_UP</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_DOWN</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_RIGHT</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_LEFT</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'H'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'F'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'O'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="sc">'H'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'F'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We add several lines of codes which can be separates in three blocs:</p>

<ul>
  <li>
    <p>First, considering the cases in which can be: ‘[1~’, ‘[7~’ and ‘[4~’, ‘[8~’, then we reuse the if statement that check if the next user byte is an integer between 1 and 9 and add the following cases.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'~'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">case</span> <span class="sc">'1'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">'4'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">'5'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_UP</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_DOWN</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">'7'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
      <span class="k">case</span> <span class="sc">'8'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Second, we consider the cases in which can be ‘[H’ and ‘[F’, and we reuse the else statement of the if before and add the cases:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="p">{</span>
<span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_UP</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_DOWN</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_RIGHT</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_LEFT</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">'H'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">'F'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>In the third case, we consider if can be ‘OH’ and ‘OF’, then in this case we can’t reuse the if of the escape sequence (‘[’), we have to consider if instead receiving ‘[’ we receive ‘O’ and then distinguish between ‘H’ or ‘F’:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'O'</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'H'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">'F'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<h4 id="219-the-delete-key">2.19. The Delete key.</h4>

<p>Lastly, let’s detect when the Delete key is pressed. It simply sends the escape sequence <esc>[3~, so it’s easy to add to our switch statement.</esc></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span>
  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="n">ARROW_RIGHT</span><span class="p">,</span>
  <span class="n">ARROW_UP</span><span class="p">,</span>
  <span class="n">ARROW_DOWN</span><span class="p">,</span>
  <span class="n">DEL_KEY</span><span class="p">,</span>
  <span class="n">HOME_KEY</span><span class="p">,</span>
  <span class="n">END_KEY</span><span class="p">,</span>
  <span class="n">PAGE_UP</span><span class="p">,</span>
  <span class="n">PAGE_DOWN</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">editorReadKey</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"read"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'['</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">'0'</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'~'</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="sc">'1'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'3'</span><span class="p">:</span> <span class="k">return</span> <span class="n">DEL_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'4'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'5'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_UP</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'6'</span><span class="p">:</span> <span class="k">return</span> <span class="n">PAGE_DOWN</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'7'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">'8'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
          <span class="k">case</span> <span class="sc">'A'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_UP</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'B'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_DOWN</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'C'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_RIGHT</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'D'</span><span class="p">:</span> <span class="k">return</span> <span class="n">ARROW_LEFT</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'H'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
          <span class="k">case</span> <span class="sc">'F'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'O'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">case</span> <span class="sc">'H'</span><span class="p">:</span> <span class="k">return</span> <span class="n">HOME_KEY</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">'F'</span><span class="p">:</span> <span class="k">return</span> <span class="n">END_KEY</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="sc">'\x1b'</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For now we don’t make this key to do anything.</p>

<p><br /></p>

<h3 id="3-a-text-viewer">3. A text viewer.</h3>

<h4 id="31-a-line-viewer">3.1. A line viewer</h4>

<p>Let’s create a data type for storing a row of text in our editor. This will consist in an integer as <em>size</em>, and the string of chars.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">erow</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">;</span>
<span class="p">}</span> <span class="n">erow</span><span class="p">;</span>
</code></pre></div></div>

<p><em>erow</em> stands for “editor row”, and stores a line of text as a pointer to the dynamically-allocated character data and a length. The typedef lets us refer to the type as erow instead of struct erow.</p>

<p>Also, we change the editorConfig struct and initEditor:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="n">row</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s fill that erow with some text now. We won’t worry about reading from a file just yet. Instead, we’ll hardcode a “Hello, world” string into it.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span>
<span class="cm">/*** file i/o ***/</span>
<span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="s">"Hello, world!"</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">linelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="n">erow</span><span class="p">.</span><span class="n">chars</span><span class="p">[</span><span class="n">linelen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="n">initEditor</span><span class="p">();</span>
  <span class="n">editorOpen</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="n">editorProcessKeypress</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We include the <em>sys/types.h</em> header file to make use of <em>ssize_t</em> (an unsigned integer type capable of storing values in the range [0, SIZE_MAX]).</p>

<p>Then, we define the <em>editorOpen()</em> function in which we use <em>memcpy()</em> function to copy the contents from a memory block to another taking three arguments, the destination, the source and the size of the contents to be passed.</p>

<p>Line by line:</p>

<ul>
  <li>
    <p>We hardcode the string “Hello, world!”:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="s">"Hello, world!"</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>We sett the size of the string:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">ssize_t</span> <span class="n">linelen</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>Note that this lenthg is not the complete lenthg of the string since we are not including the null byte. Is just to pass the size to memcpy.</p>
  </li>
  <li>
    <p>We create the memory block for the destination:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">linelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div>    </div>

    <ul>
      <li>Then, we copy the memory block from <em>line</em> to <em>E.row.chars</em> and include the null byte:</li>
    </ul>

    <p>erow.chars[linelen] = ‘\0’;
```</p>
  </li>
  <li>
    <p>Lastly we sett the number of bytes to be printed to one, this have more importance in the implementation on the next block of code.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
<span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Now, we display it:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We modify our <em>editorDrawRows()</em> and include a new <em>if</em> statement in In which we check first is there are lines to be drawed with the <em>E.numrows</em> data setted in the <em>editorOpen()</em> section:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div></div>

<p>If there are we append the contents of the memory block to the buffer:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is on the suppose there only is one line.</p>

<p>Let’s consider the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">linelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
    <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">[</span><span class="n">linelen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="n">initEditor</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="n">editorProcessKeypress</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This two bloque of codes tell us how the program open a file and read its contens and how this block is implemented in the main function.</p>

<p>The first block applies the logic of the first version of our <em>openEditor()</em> function using <em>memcpy()</em> to move contents between memory blocks and expand it to read a file line by line getting the necesary information using <em>getline()</em> (which comes from <em>stdio.h</em>)</p>

<ul>
  <li>
    <p>First, we open a file with <em>fopen</em> in read mode (with only read permissions). Then check the value of the pointer <em>fp</em>; fopen returns NULL if the operation fails and NULL is asociated with FALSE:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>So, we check if the negative boolean value of the pointer is TRUE, this is, if the pointer is false, we call <em>die()</em></p>
  </li>
  <li>
    <p>Then, with <em>getline()</em> we get the attributes necesaries to pass the string to <em>memcpy()</em>, the <em>getline()</em> function reads an entire line from a stream (fp), storing the address of the buffer containing the text into <em>line</em> which is line is a pointer to a char pointer (char **) and <em>linecap</em> are the bytes in size of the string (If the buffer is not large enough to hold the line, getline() resizes it with realloc(), updating <em>line</em> and <em>linecap</em> as necessary). The buffer is null-terminated and includes the newline character, if one is found.</p>

    <p><em>getline()</em> returns the number of characters read (including the newline but excluding the null terminator), or -1 on failure/EOF.</p>

    <p>In our case, when <em>line</em> is NULL and <em>linecap</em> is 0, <em>getline()</em> allocates the buffer automatically.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
<span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Next, we check if the return value of the getline() function to verify if everything has gone alright.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>And strip newlines and carriage characters:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                     <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
<span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, we apply the logic of the previous <em>editorOpen()</em> version:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">linelen</span><span class="p">;</span>
<span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">linelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
<span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">[</span><span class="n">linelen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally we free the line pointer and close the file.</p>
  </li>
</ul>

<p>Now, on the <em>main()</em> function we just leave the user the option to use a file among with the editor. If we detect that the kilo binary has benn called along with an argument, we treat the argument as the file.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So, in summary; the core of editorOpen() is the same, we just get the line and linelen values from getline() now, instead of hardcoded values.</p>

<p><em>editorOpen()</em> now takes a filename and opens the file for reading using fopen(). We allow the user to choose a file to open by checking if they passed a filename as a command line argument. If they did, we call editorOpen() and pass it the filename. If they ran ./kilo with no arguments, editorOpen() will not be called and they’ll start with a blank file.</p>

<p><em>getline()</em> is useful for reading lines from a file when we don’t know how much memory to allocate for each line. It takes care of memory management for you. First, we pass it a null line pointer and a linecap (line capacity) of 0. That makes it allocate new memory for the next line it reads, and set line to point to the memory, and set linecap to let you know how much memory it allocated.</p>

<p>Later, when we have editorOpen() read multiple lines of a file, we will be able to feed the new line and linecap values back into getline() over and over, and it will try and reuse the memory that line points to as long as the linecap is big enough to fit the next line it reads. For now, we just copy the one line it reads into E.row.chars, and then free() the line that getline() allocated.</p>

<p>We also strip off the newline or carriage return at the end of the line before copying it into our erow. We know each erow represents one line of text, so there’s no use storing a newline character at the end of each one.</p>

<p>Now let’s fix a quick bug. We want the welcome message to only display when the user starts the program with no arguments, and not when they open a file, as the welcome message could get in the way of displaying the file.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//We change the condition to display if only there is no lines to draw from E.numrows.</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="32-multiple-lines">3.2. Multiple lines.</h4>

<p>The code before just prints the first line of the document. Let’s try to store multiples lines by making <em>E.row</em> an array of <em>erow</em> structs.</p>

<p>It will be a dynamically-allocated array, so we’ll make it a pointer to erow, and initialize the pointer to NULL. (This will break a bunch of our code that doesn’t expect E.row to be a pointer, so the program will fail to compile for the next few steps.):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span> <span class="c1">//Defined as pointer.</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">editorConfig</span> <span class="n">E</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//Initiate as NULL.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, let’s move the code in editorOpen() that initializes E.row to a new function called editorAppendRow() that we call through the <em>editorOpen()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">.</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">editorAppendRow</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Notice that we renamed the line and linelen variables to s and len, which are now arguments to editorAppendRow().</p>

<p>At this point, editorAppendRow() just works for only one line since the functionality has not been modified. In order to be able to store varios lines from the file, ew want editorAppendRow() to allocate space for a new erow, and then copy the given string to a new erow at the end of the E.row array:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">at</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, we used the first line to realloc the E.row size to adjust several erows (exactly to get one more line). Then, we copy the contents of the string <em>s</em> to the last alloced space in the E.row slot.</p>

<p>Next, let’s update <em>editorDrawRows()</em> to use “E.row[y]”:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">y</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">y</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And modify <em>editorOpen()</em> to keep reading lines from the file descriptor until there is nothing more to read:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">editorAppendRow</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For that, we just added a while loop that keep reading from fp until the function getline returns an error. getline() reads from a file descriptor until finds a terminator byte ‘\n’, then save the position and, in the next call it continous from there until the next terminator byte, that is what the function consider different lines</p>

<p><br /></p>

<h4 id="33-vertical-scrolling">3.3. Vertical scrolling.</h4>

<p>However, there is a problem at this point, despite the lines of the file we try to include in our editor, this one will only show the number of lines of the file that fits with the size of the terminal.</p>

<p>In order to change this, and be able to show more lines in our editor and scroll down the file we add a <em>rowoff</em> (row offset) variable to the global editor state, which will keep track of what row of the file the user is currently scrolled to.g</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//We initialize it to 0, which means we’ll be scrolled to the top of the file by default.</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Also, we have modified <em>editorDrawRows()</em> code in order to display the correct range of lines of the file according to the value of rowoff:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>We include a variable; <em>filerow</em>:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>This new variable defines the row of the file we want to display, next, we include an ‘if’ statement, in which we try to eval if the row to be displayed (filerow) is bigger than the total number of row to be displayed (E.numrows)</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> 
</code></pre></div>    </div>

    <p>If thisn is True it means that we already emptied our row buffer and is time now to fill the rest of the empty terminal with the ‘~’ char and the welcome message, but if it is False, we append to the buffer each row to be displayed:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">else</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>    </div>

    <p>In the code we retrieve the len of the line, we force to fit in the size of our window and then append the line to the buffer calling <em>abAppend()</em>.</p>
  </li>
</ul>

<p>With this we ensure that all the lines get displayed in the editor but, we still have the issue to scroll down the page to show the contents to the user. In order to do that, we define the following function <em>editorScroll()</em>. Our strategy will be to check if the cursor has moved outside of the visible window, and if so, adjust E.rowoff so that the cursor is just inside the visible window.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorScroll</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//Check if the cursor is above the visible window and displace it if it is.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//Check if the cursor is past the bottom of the visible window.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We add this function to the <em>editorRefreshScreen()</em> code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">editorScroll</span><span class="p">();</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this point, we allow into the logic of the cursor to displace the window when we need it. Let’s implement the functionality of the cursor in <em>editorMoveCursor()</em> function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Now, the position of the cursor can be bigger than the size of the screen if there are lines of the file that get outs from the visible window.</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that we can’t scroll up.</p>

<p>This is because we are trying tom scroll up through the render file, not the screen, this means that we now have to subtract E.rowoff from the value of E.cy to include the range of values of E.cy inside the file in order to be able to scroll over it:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">editorScroll</span><span class="p">();</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> 
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="34-horizontal-scrolling">3.4. Horizontal scrolling.</h4>

<p>Now let’s work on horizontal scrolling. We’ll implement it in just about the same way we implemented vertical scrolling. Start by adding a coloff (column offset) variable to the global editor state.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">editorConfig</span> <span class="n">E</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To display each row at the column offset, we’ll use E.coloff as an index into the chars of each erow we display, and subtract the number of characters that are to the left of the offset from the length of the row.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">size</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that when subtracting E.coloff from the length, len can now be a negative number, meaning the user scrolled horizontally past the end of the line. In that case, we set len to 0 so that nothing is displayed on that line.</p>

<p>Now let’s update editorScroll():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorScroll</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, it is exactly parallel to the vertical scrolling code. We just replace E.cy with E.cx, E.rowoff with E.coloff, and E.screenrows with E.screencols.</p>

<p>Now let’s allow the user to scroll past the right edge of the screen:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s allow the user to scroll past the right edge of the screen.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, let’s fix the cursor positioning, just like we did with vertical scrolling.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">editorScroll</span><span class="p">();</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now both E.cx and E.cy refer to the cursor’s position within the file, not its position on the editor’s screen.</p>

<p><br /></p>

<h4 id="35-limit-scrolling-to-the-right">3.5. Limit scrolling to the right.</h4>

<p>So our goal with the next few steps is to limit the values of E.cx and E.cy to only ever point to valid positions in the file. Otherwise, the user could move the cursor way off to the right of a line and start inserting text there, which wouldn’t make much sense. (The only exceptions to this rule are that E.cx can point one character past the end of a line so that characters can be inserted at the end of the line, and E.cy can point one line past the end of the file so that new lines at the end of the file can be added easily.)</p>

<p>Let’s start by not allowing the user to scroll past the end of the current line.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>The line:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>   
</code></pre></div>    </div>

    <p>Take the ternary operator ‘?’ to perform an if operation, if E.cy &gt;= E.numrows (which means, if the cursor is above the number of total rows) then row points to NULL, if not, it points to the current row.</p>
  </li>
  <li>
    <p>On another part;</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
<span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">break</span><span class="p">;</span>
</code></pre></div>    </div>

    <p>We check if row is not NULL and if the cursor is between the end and the start of a rown, then we add 1 when we press ARROW_RIGHT.</p>
  </li>
</ul>

<p><br /></p>

<h4 id="36-snap-cursor-to-end-of-line">3.6. Snap cursor to end of line.</h4>

<p>The user is still able to move the cursor past the end of a line, however. They can do it by moving the cursor to the end of a long line, then moving it down to the next line, which is shorter. The E.cx value won’t change, and the cursor will be off to the right of the end of the line it’s now on.</p>

<p>Let’s add some code to editorMoveCursor() that corrects E.cx if it ends up past the end of the line it’s on.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//We are add a correction in which after every arrow keypressing, we evaluate if the cursor is within the length of the current row. </span>

  <span class="c1">//First we check if the cursor is within a valid row index.</span>
  <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>

  <span class="c1">//If it is, we assign rowlen the size of the row in which lays the cursor, if not, the size of the row is 0 (which means is an invalid row).</span>
  <span class="kt">int</span> <span class="n">rowlen</span> <span class="o">=</span> <span class="n">row</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">//Then, we evaluate if the horizontal position of the cursor fits in the length of the line, if is bigger we truncate it.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="n">rowlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">rowlen</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="37-moving-left-at-the-start-of-a-line">3.7. Moving left at the start of a line.</h4>

<p>Let’s allow the user to press ← at the beginning of the line to move to the end of the previous line.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>

      <span class="c1">//If E.cx = 0, then we go upn and right to end of the row.</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">rowlen</span> <span class="o">=</span> <span class="n">row</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="n">rowlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">rowlen</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="38-moving-right-at-the-end-of-a-line">3.8. Moving right at the end of a line.</h4>

<p>Similarly, let’s allow the user to press → at the end of a line to go to the beginning of the next line.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorMoveCursor</span><span class="p">(</span><span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">==</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">rowlen</span> <span class="o">=</span> <span class="n">row</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="n">rowlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">rowlen</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="39-rendering-tabs">3.9. Rendering tabs.</h4>

<p>Our code doesn’t render properly the TABs. The length of a tab is up to the terminal being used and its settings and inside the editor doesn’t erase any character, it only move the cursor forward to the next tab stop.</p>

<p>We want to know the length of each tab, and we also want control over how to render tabs, so we’re going to add a second string to the erow struct called <em>render</em>, which will contain the actual characters to draw on the screen for that row of text. We’ll only use render for tabs for now, but in the future it could be used to render nonprintable control characters as a ^ character followed by another character, such as ^A for the Ctrl-A character.</p>

<p>Let’s start by adding render and <em>rsize</em> (which contains the size of the contents of render) to the erow struct, and initializing them in <em>editorAppendRow()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">erow</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rsize</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">render</span><span class="p">;</span>
<span class="p">}</span> <span class="n">erow</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">at</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, let’s make an <em>editorUpdateRow()</em> function that uses the chars string of an erow to fill in the contents of the render string.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function, performs as follows:</p>

<ul>
  <li>
    <p>First, we free ‘row-&gt;render’ since we are updating an existing value and that pointer can contain garbage. Then, we alloc memory for the pointer again of the size of the row:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
<span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, we copy byte to byte the contents of the row to render and add the terminator byte and add the size:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="p">}</span>
<span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
<span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span> <span class="c1">//idx contains the number of characters we copied into row-&gt;render, so we assign it to row-&gt;rsize</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Now, we call this function in <em>editorAppendRow()</em>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">at</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s replace chars and size with render and rsize in editorDrawRows(), when we display each erow.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Whit this change, the text viewer is displaying the characters in render. We now control what text is displaying.</p>

<p>The nexst step is to add code to <em>editorUpdateRow()</em> in order to render the TAB as multiple spaces.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">tabs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>

    <span class="c1">//First check if the receive char is a TAB, which is represented as the \t escape sequence. If it is, add one to the counter.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="n">tabs</span><span class="o">++</span><span class="p">;</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">tabs</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//Alloc 7 bytes more per TAB, since a TAB is 8 spaces and one byte per TAB is consider in row-&gt;size.</span>
  <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//After allocating memory, we place in the TAB slot a 8-divisible chunk of spaces (formely, a TAB).</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this point, we should probably make the length of a tab stop a constant.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define KILO_TAB_STOP 8
</span>
<span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">tabs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="n">tabs</span><span class="o">++</span><span class="p">;</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">tabs</span><span class="o">*</span><span class="p">(</span><span class="n">KILO_TAB_STOP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="n">KILO_TAB_STOP</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="310-tabs-and-the-cursor">3.10. Tabs and the cursor.</h4>

<p>The cursor doesn’t currently interact with tabs very well. When we position the cursor on the screen, we’re still assuming each character takes up only one column on the screen while TAB in fact occupies 8 slots.</p>

<p>To fix this, let’s introduce a new horizontal coordinate variable, <em>E.rx</em>. While <em>E.cx</em> is an index into the chars field of an erow, the E.rx variable will be an index into the render field. If there are no tabs on the current line, then E.rx will be the same as E.cx. If there are tabs, then E.rx will be greater than E.cx by however many extra spaces those tabs take up when rendered.</p>

<p>Start by adding rx to the global state struct, and initializing it to 0.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We’ll set the value of E.rx at the top of editorScroll(). For now we’ll just set it to be the same as E.cx. Then we’ll replace all instances of E.cx with E.rx in editorScroll(), because scrolling should take into account the characters that are actually rendered to the screen, and the rendered position of the cursor.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorScroll</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now change E.cx to E.rx in editorRefreshScreen() where we set the cursor position:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">editorScroll</span><span class="p">();</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>All that’s left to do is calculate the value of E.rx properly in editorScroll()</p>

<p>Let’s create an <em>editorRowCxToRx()</em> function that converts a chars index into a render index. 
We’ll need to loop through all the characters to the left of cx, and figure out how many spaces each tab takes up.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">editorRowCxToRx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cx</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cx</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span>
      <span class="n">rx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">KILO_TAB_STOP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">rx</span> <span class="o">%</span> <span class="n">KILO_TAB_STOP</span><span class="p">);</span>
    <span class="n">rx</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">rx</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For each character, if it’s a tab we use rx % KILO_TAB_STOP to find out how many columns we are to the right of the last tab stop, and then subtract that from KILO_TAB_STOP - 1 to find out how many columns we are to the left of the next tab stop. We add that amount to rx to get just to the left of the next tab stop, and then the unconditional rx++ statement gets us right on the next tab stop. Notice how this works even if we are currently on a tab stop.</p>

<p>Let’s call editorRowCxToRx() at the top of editorScroll() to finally set E.rx to its proper value.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorScroll</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">editorRowCxToRx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">],</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="311-scrollin-with-page-up-and-page-down">3.11. Scrollin with Page Up and Page Down.</h4>

<p>Now that we have scrolling, let’s make the Page Up and Page Down keys scroll up or down an entire page.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="312-move-to-the-end-of-the-line-with-end">3.12. Move to the end of the line with End.</h4>

<p>Now let’s have the End key move the cursor to the end of the current line. (The Home key already moves the cursor to the beginning of the line, since we made E.cx relative to the file instead of relative to the screen.)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="313-status-bar">3.13. Status bar.</h4>

<p>The last thing we’ll add before finally getting to text editing is a status bar. This will show useful information such as the filename, how many lines are in the file, and what line you’re currently on.</p>

<p>Later we’ll add a marker that tells you whether the file has been modified since it was last saved, and we’ll also display the filetype when we implement syntax highlighting.</p>

<p>First, we will make room for a simply one-line status bar at the bottom of the screen:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Also, we decrement E.screenrows so that editorDrawRows() doesn’t try to draw a line of text at the bottom of the screen. We have editorDrawRows() print a newline after the last row it draws, since the status bar is now the final line being drawn on the screen:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, to make the status bar stand out, we’re going to display it with inverted colors: black text on a white background. The escape sequence ‘[7m’ switches to inverted colors, and ‘[m’ switches back to normal formatting. Let’s draw a blank white status bar of inverted space characters.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">len</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then, we include the function on editorRefreshScreen():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">editorScroll</span><span class="p">();</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="n">editorDrawStatusBar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Since we want to display the filename in the status bar, let’s add a filename string to the global editor state, and save a copy of the filename there when a file is opened.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">editorAppendRow</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>strdup() comes from <em>string.h</em>. It makes a copy of the given string, allocating the required memory and assuming you will free() that memory.</p>

<p>We initialize E.filename to the NULL pointer, and it will stay NULL if a file isn’t opened (which is what happens when the program is run without arguments).Now we’re ready to display some information in the status bar. We’ll display up to 20 characters of the filename, followed by the number of lines in the file. If there is no filename, we’ll display ‘[No Name]’ instead.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="s">"%.20s - %d lines"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">:</span> <span class="s">"[No Name]"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">len</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s show the current line number, and align it to the right edge of the screen.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="n">rstatus</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="s">"%.20s - %d lines"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">:</span> <span class="s">"[No Name]"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">rstatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rstatus</span><span class="p">),</span> <span class="s">"%d/%d"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">rstatus</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">len</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="314-status-message">3.14. Status message.</h4>

<p>We’re going to add one more line below our status bar.</p>

<p>This will be for displaying messages to the user, and prompting the user for input when doing a search, for example.</p>

<p>We’ll store the current message in a string called <em>statusmsg</em>, which we’ll put in the global editor state.</p>

<p>We’ll also store a timestamp for the message, so that we can erase it a few seconds after it’s been displayed.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">statusmsg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">time_t</span> <span class="n">statusmsg_time</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We initialize E.statusmsg to an empty string, so no message will be displayed by default. E.statusmsg_time will contain the timestamp when we set a status message.</p>

<p>Let’s define an <em>editorSetStatusMessage()</em> function. 
This function will take a format string and a variable number of arguments, like the printf() family of functions:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">editorSetStatusMessage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
  <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
  <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
  <span class="n">vsnprintf</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">),</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="n">initEditor</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"HELP: Ctrl-Q = quit"</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="n">editorProcessKeypress</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>va_list, va_start(), and va_end() come from <em>stdarg.h</em>. vsnprintf() comes from <em>stdio.h</em>. time() comes from <em>time.h</em>.</p>

<p>In main(), we set the initial status message to a help message with the key bindings that our text editor uses (currently, just Ctrl-Q to quit).</p>

<p>vsnprintf() helps us make our own printf()-style function. We store the resulting string in E.statusmsg, and set E.statusmsg_time to the current time, which can be gotten by passing NULL to time(). (It returns the number of seconds that have passed since midnight, January 1, 1970 as an integer.)</p>

<p>The … argument makes editorSetStatusMessage() a variadic function, meaning it can take any number of arguments. C’s way of dealing with these arguments is by having you call va_start() and va_end() on a value of type va_list. The last argument before the … (in this case, fmt) must be passed to va_start(), so that the address of the next arguments is known. Then, between the va_start() and va_end() calls, you would call va_arg() and pass it the type of the next argument (which you usually get from the given format string) and it would return the value of that argument. In this case, we pass fmt and ap to vsnprintf() and it takes care of reading the format string and calling va_arg() to get each argument.</p>

<p>Now that we have a status message to display, let’s make room for a second line beneath our status bar where we’ll display the message.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="n">rstatus</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="s">"%.20s - %d lines"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">:</span> <span class="s">"[No Name]"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">rstatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rstatus</span><span class="p">),</span> <span class="s">"%d/%d"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">rstatus</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">len</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We decrement E.screenrows again, and print a newline after the first status bar. We now have a blank final line once again.</p>

<p>Let’s draw the message bar in a new editorDrawMessageBar() function.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawMessageBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">msglen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">msglen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">&amp;&amp;</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">editorScroll</span><span class="p">();</span>
  <span class="k">struct</span> <span class="n">abuf</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">ABUF_INIT</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25l"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">editorDrawRows</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="n">editorDrawStatusBar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="n">editorDrawMessageBar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%d;%dH"</span><span class="p">,</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[?25h"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ab</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
  <span class="n">abFree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First we clear the message bar with the ‘[K’ escape sequence. Then we make sure the message will fit the width of the screen, and then display the message, but only if the message is less than 5 seconds old.</p>

<p>When you start up the program now, you should see the help message at the bottom. It will disappear when you press a key after 5 seconds. Remember, we only refresh the screen after each keypress.</p>

<p><br /></p>

<h3 id="4-a-text-editor">4. A Text Editor.</h3>

<h4 id="41-insert-ordinary-characters">4.1. Insert Ordinary characters.</h4>

<p>In the code of the previous section, we create a program that modify some terminal characteristics and render a file on it.</p>

<p>Now, we want over the terminal in order to transform our text viewer in a text editor. Let’s start writing a function that insert a single character into an erow at a given position.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="n">at</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function perform as follows:</p>

<ul>
  <li>
    <p>First, we validate the index ‘at’ which marks the position in which we want to insert the character. Notice that at is allowed to go one character past the end of the string, in which case the character should be inserted at the end of the string.</p>
  </li>
  <li>
    <p>Then we allocate one more byte for the chars of the erow (we add 2 because we also have to make room for the null byte).</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now we use <em>memmove()</em> to shift the entire row and make space for a new byte on the desired location:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="nf">memmove</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>which is a function that copies <em>n</em> bytes from a memory area designated by an starting pointer (void* src) to a destination memory area <em>dest</em> again following an starting pointer.</p>

    <p>The memory areas may overlap and return a void pointer to dest area. In this case, the memory area coincide in a way that we expand the original area so doing something with the return value is not required.</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>So with <em>memmove()</em>, we take the bytes starting from <em>&amp;row-&gt;chars[at]</em> this is, from row-&gt;chars buffer at the position ‘at’ and move it over the region starting one byte to the right creating one byte gap between the two regions.</p>
  </li>
  <li>
    <p>Then, we update the size of the row, place the new character on the new allocated byte and call <em>editorUpdateRow()</em>.</p>
  </li>
</ul>

<p>Now, we’ll add a function to this section called editorInsertChar() which will take a character and use <em>editorRowInsertChar()</em> to insert that character into the position that the cursor is at.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">//Insert an empty row if the position of the cursor is at the edge of the screen.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorAppendRow</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">//We call the function described above to insert a char on the row mark at E.cy on position E.cx.</span>
  <span class="n">editorRowInsertChar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">],</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice that editorInsertChar() doesn’t have to worry about the details of modifying an erow, and editorRowInsertChar() doesn’t have to worry about where the cursor is.</p>

<p>Let’s call editorInsertChar() in the default: case of the switch statement in editorProcessKeypress(). This will allow any keypress that isn’t mapped to another editor function to be inserted directly into the text being edited.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="c1">//default is the case triggered wheb any of the previous case matchs. Thus, when we press any key on the keyboard we insert it on the text editor. </span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><br /></p>

<h4 id="42-prevent-inserting-special-characters">4.2. Prevent inserting special characters.</h4>

<p>Currently, if you press keys like Backspace or Enter, those characters will be inserted directly into the text, which we certainly don’t want.</p>

<p>Let’s handle a bunch of these special keys in <em>editorProcessKeypress()</em>, so that they don’t fall through to the default case of calling <em>editorInsertChar()</em>.</p>

<p>First, ‘BACKSPACE’ doesn’t have a human-readable backslash-escape representation in C (like \n, \r, and so on), so we make it part of the editorKey enum and assign it its ASCII value of 127:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorKey</span> <span class="p">{</span>
  <span class="n">BACKSPACE</span> <span class="o">=</span> <span class="mi">127</span><span class="p">,</span> 
  <span class="n">ARROW_LEFT</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="n">ARROW_RIGHT</span><span class="p">,</span>
  <span class="n">ARROW_UP</span><span class="p">,</span>
  <span class="n">ARROW_DOWN</span><span class="p">,</span>
  <span class="n">DEL_KEY</span><span class="p">,</span>
  <span class="n">HOME_KEY</span><span class="p">,</span>
  <span class="n">END_KEY</span><span class="p">,</span>
  <span class="n">PAGE_UP</span><span class="p">,</span>
  <span class="n">PAGE_DOWN</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Then, in editorProcessKeypress():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span>
    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>The first new key we add to the switch statement is ‘\r’, which is the Enter key. For now we want to ignore it, but obviously we’ll be making it do something later, so we mark it with a TODO comment.</li>
  <li>We handle Backspace and Delete in a similar way, marking them with a TODO.</li>
  <li>We also handle the Ctrl-H key combination, which sends the control code 8, which is originally what the Backspace character would send back in the day.</li>
  <li>Lastly, we handle Ctrl-L and Escape by not doing anything when those keys are pressed. Ctrl-L is traditionally used to refresh the screen in terminal programs. In our text editor, the screen refreshes after any keypress, so we don’t have to do anything else to implement that feature.</li>
</ul>

<p>We ignore the Escape key because there are many key escape sequences that we aren’t handling (such as the F1–F12 keys), and the way we wrote editorReadKey(), pressing those keys will be equivalent to pressing the Escape key. We don’t want the user to unwittingly insert the escape character 27 into their text, so we ignore those keypresses.</p>

<p><br /></p>

<h4 id="43-save-to-disk">4.3. Save to disk.</h4>

<p>Now that we’ve finally made text editable, let’s implement saving to disk. First we’ll write a function that converts our array of erow structs into a single string that is ready to be written out to a file.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="nf">editorRowsToString</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="n">totlen</span> <span class="o">+=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">totlen</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">totlen</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
    <span class="n">p</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function returns a pointer to a char and needs a pointer to an integer, the buffer length and performs as follows:</p>

<ul>
  <li>
    <p>First we calculate the length of the total rows adding the row’s size for each row in a variable:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">int</span> <span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="n">totlen</span> <span class="o">+=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="o">*</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">totlen</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, we alloc the same amount of space for a pointer to a char (a string to chars):</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">totlen</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, we copy the contents of each row into buff making pointer arithmetic:</p>

    <ul>
      <li>
        <p>First, we use <em>memcpy()</em>:</p>

        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Then, we use pointer arithmetic to move the pointer ‘p’ up to the final of the just added row and add a salt line escape sequence, and then move it one position more:</p>

        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">+=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
<span class="n">p</span><span class="o">++</span><span class="p">;</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>Then we return a pointer to the initial position of the buffer.</p>

        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p>With this; this function converts the editor’s internal row structure into a single string buffer.</p>

<p>Now we’ll implement the editorSave() function, which will actually write the string returned by editorRowsToString() to disk.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">//If it’s a new file, then E.filename will be NULL, and we won’t know where to save the file, so we just return without doing anything for now. </span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="c1">//Call the function to create the buffer.</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

  <span class="c1">//Crete the file if not exists for READ&amp;WRITE operations and with default permissions.</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

  <span class="c1">//ftruncate() sets the file’s size to the specified length.</span>
  <span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

  <span class="c1">//Write the contents, close the file and free the buffer pointer.</span>
  <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Anyways, all we have to do now is map a key to editorSave(). We’ll use Ctrl-S.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span>
      <span class="n">editorSave</span><span class="p">();</span> <span class="c1">//Save file.</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span>
    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now, let’s add some error handling to <em>editorSave()</em> function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//Check every function doesn't return an error value.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>open() and ftruncate() both return -1 on error. We expect write() to return the number of bytes we told it to write. Whether or not an error occurred, we ensure that the file is closed and the memory that buf points to is freed.</p>

<p>Let’s use <em>editorSetStatusMessage()</em> to notify the user whether the save succeeded or not. While we’re at it, we’ll add the Ctrl-S key binding to the help message that’s set in main():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="n">initEditor</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"HELP: Ctrl-S = save | Ctrl-Q = quit"</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="n">editorProcessKeypress</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above code doesn’t actually compile, because we are trying to call editorSetStatusMessage() before it is defined in the file.</p>

<p><br /></p>

<h4 id="44-dirty-flag">4.4. Dirty flag.</h4>

<p>We’d like to keep track of whether the text loaded in our editor differs from what’s in the file. Then we can warn the user that they might lose unsaved changes when they try to quit.</p>

<p>We call a text buffer “dirty” if it has been modified since opening or saving the file. Let’s add a dirty variable to the global editor state, and initialize it to 0.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dirty</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">statusmsg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">time_t</span> <span class="n">statusmsg_time</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s show the state of E.dirty in the status bar, by displaying (modified) after the filename if the file has been modified.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="n">rstatus</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="s">"%.20s - %d lines %s"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">:</span> <span class="s">"[No Name]"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">?</span> <span class="s">"(modified)"</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span> <span class="c1">//If change has been made, then we modify dirty.</span>
  <span class="kt">int</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">rstatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rstatus</span><span class="p">),</span> <span class="s">"%d/%d"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">rstatus</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">len</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s increment E.dirty in each row operation that makes a change to the text.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorAppendRow</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="kt">int</span> <span class="n">at</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">editorRowInsertChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="n">at</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We could have used E.dirty = 1 instead of E.dirty++, but by incrementing it we can have a sense of “how dirty” the file is, which could be useful. (We’ll just be treating E.dirty as a boolean value in this tutorial, so it doesn’t really matter.)</p>

<p>If you open a file at this point, you’ll see that (modified) appears right away, before you make any changes. That’s because editorOpen() calls editorAppendRow(), which increments E.dirty. To fix that, let’s reset E.dirty to 0 at the end of editorOpen(), and also in editorSave().</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">editorAppendRow</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now you should see (modified) appear in the status bar when you first insert a character, and you should see it disappear when you save the file to disk.</p>

<p><br /></p>

<h4 id="45-quit-confirmation">4.5. Quit confirmation.</h4>

<p>Now we’re ready to warn the user about unsaved changes when they try to quit. If E.dirty is set, we will display a warning in the status bar, and require the user to press Ctrl-Q three more times in order to quit without saving.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define KILO_QUIT_TIMES 3
</span>
<span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span>
          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span>
        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span>
      <span class="n">editorSave</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span>
    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We edit <em>editorProcessKeypress()</em>, in order to introduce some check on the case <em>CTRL_KEY(‘q’)</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>

<span class="k">case</span> <span class="nf">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">)</span><span class="o">:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span>
      <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span>
    <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">break</span><span class="p">;</span>

<span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
</code></pre></div></div>

<p>Each time they press Ctrl-Q with unsaved changes, we set the status message and decrement quit_times. When quit_times gets to 0, we finally allow the program to exit. When they press any key other than Ctrl-Q, then quit_times gets reset back to 3 at the end of the editorProcessKeypress() function.</p>

<p><br /></p>

<h4 id="46-simple-backspacing">4.6. Simple backspacing.</h4>

<p>Let’s implement backspacing next. First we’ll create an editorRowDelChar() function, which deletes a character in an erow.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRowDelChar</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">at</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This function is pretty similar to <em>editorRowInsertChar()</em>, which shift par of a row to create an empty byte in which we insert a char. In this case, we make the same strategy but we not make space for a new byte, instead we just shift part of the row at the position of the cursor (at) to the left one time effectively deleting the char located before the cursor.</p>

<pre><code class="language-less">- HELLO -&gt; editorRowInsertChar('C','2') -&gt; HE_LLO -&gt; HECLLO
- HELLO -&gt; editorRowDelChar('2') -&gt; HLLO
</code></pre>

<p>As we did with <em>editorRowInsertChar()</em>, we also create a function to call <em>editorRowDelChar()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDelChar</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRowDelChar</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If the cursor’s past the end of the file, then there is nothing to delete, and we return immediately. Otherwise, we get the erow the cursor is on, and if there is a character to the left of the cursor, we delete it and move the cursor one to the left.</p>

<p>Let’s map the Backspace, Ctrl-H, and Delete keys to editorDelChar().</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
      <span class="cm">/* TODO */</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span>
          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span>
        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span>
      <span class="n">editorSave</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span><span class="p">)</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">ARROW_RIGHT</span><span class="p">);</span>
      <span class="n">editorDelChar</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span>
    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It so happens that in our editor, pressing the → key and then Backspace is equivalent to what you would expect from pressing the Delete key in a text editor: it deletes the character to the right of the cursor. So that is how we implement the Delete key above.</p>

<p><br /></p>

<h4 id="47-backspaceing-at-the-start-of-a-line">4.7. Backspaceing at the start of a line.</h4>

<p>Currently, editorDelChar() doesn’t do anything when the cursor is at the beginning of a line. When the user backspaces at the beginning of a line, we want to append the contents of that line to the previous line, and then delete the current line. This effectively backspaces the implicit \n character in between the two lines to join them into one line. So we need two new row operations: one for appending a string to a row, and one for deleting a row.</p>

<p>Let’s start by implementing editorDelRow(), which will also require an editorFreeRow() function for freeing the memory owned by the erow we are deleting.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFreeRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">editorDelRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">editorFreeRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">--</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>First we validate the at index.</p>
  </li>
  <li>
    <p>Then we free the memory owned by the row using editorFreeRow().</p>
  </li>
  <li>
    <p>We then use memmove() to overwrite the deleted row struct with the rest of the rows that come after it, and decrement numrows. Finally, we increment E.dirty.</p>
  </li>
</ul>

<p>Now let’s implement editorRowAppendString(), which appends a string to the end of a row.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">editorRowAppendString</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The mecanic of the function is simple, we realloc the size, copy the string with memcpy() and append terminator byte.</p>

<p>Now we’re ready to get editorDelChar() to handle the case where the cursor is at the beginning of a line.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDelChar</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRowDelChar</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
    <span class="n">editorRowAppendString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
    <span class="n">editorDelRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">);</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="48-the-enter-key">4.8. The Enter key</h4>

<p>The last editor operation we have to implement is the Enter key. The Enter key allows the user to insert new lines into the text, or split a line into two lines. The first thing we need to do is rename the editorAppendRow(…) function to editorInsertRow(int at, …). It will now be able to insert a row at the index specified by the new at argument.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorInsertRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span> <span class="c1">//Expand the number of available line by 1.</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span><span class="p">));</span> <span class="c1">//At the desired position, we shift the entire block one line creating a salt between two lines. </span>
  
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We now have to replace all calls to editorAppendRow(…) with calls to editorInsertRow(E.numrows, …).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorInsertChar</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">editorRowInsertChar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">],</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we are ready to implement <em>editorInsertNewline()</em>, which handles an Enter keypress:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorInsertNewline</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">],</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">);</span>
    <span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">];</span>
    <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
    <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">editorUpdateRow</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>`
The function just distinguish between if we insert a new line at the beginning of the row or within a row. In the second case we split the row at the position E.cy at the E.cx position and insert a newline calling <em>editorInsertRow()</em>.</p>

<p>Finally, let’s actually map the Enter key to the editorInsertNewline() operation.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
      <span class="n">editorInsertNewline</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span>
          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span>
        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span>
      <span class="n">editorSave</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span><span class="p">)</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">ARROW_RIGHT</span><span class="p">);</span>
      <span class="n">editorDelChar</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span>
    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="49-save-as">4.9. Save as.</h4>

<p>Currently, when the user runs ./kilo with no arguments, they get a blank file to edit but have no way of saving. We need a way of prompting the user to input a filename when saving a new file.</p>

<p>Let’s make an editorPrompt() function that displays a prompt in the status bar, and lets the user input a line of text after the prompt.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorRefreshScreen</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The user’s input is stored in buf, which is a dynamically allocated string that we initalize to the empty string. We then enter an infinite loop that repeatedly sets the status message, refreshes the screen, and waits for a keypress to handle. The prompt is expected to be a format string containing a %s, which is where the user’s input will be displayed.</p>

<p>When the user presses Enter, and their input is not empty, the status message is cleared and their input is returned. Otherwise, when they input a printable character, we append it to buf. If buflen has reached the maximum capacity we allocated (stored in bufsize), then we double bufsize and allocate that amount of memory before appending to buf. We also make sure that buf ends with a \0 character, because both editorSetStatusMessage() and the caller of editorPrompt() will use it to know where the string ends.</p>

<p>Now let’s prompt the user for a filename in editorSave(), when E.filename is NULL.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next, let’s allow the user to press Escape to cancel the input prompt.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When an input prompt is cancelled, we free() the buf ourselves and return NULL. So let’s handle a return value of NULL in editorSave() by aborting the save operation and displaying a “Save aborted” message to the user.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s (ESC to cancel)"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Save aborted"</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>(Note: If you’re using Bash on Windows, you will have to press Escape 3 times to get one Escape keypress to register in our program, because the read() calls in editorReadKey() that look for an escape sequence never time out.)</p>

<p>Now let’s allow the user to press Backspace (or Ctrl-H, or Delete) in the input prompt.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">BACKSPACE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="o">--</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="5-search">5. Search.</h3>

<h4 id="51-implemenmt-a-search-functionality">5.1. Implemenmt a search functionality.</h4>

<p>Let’s use <em>editorPrompt()</em> to implement a minimal search feature.</p>

<p>When the user types a search query and presses Enter, we’ll loop through all the rows of the file, and if a row contains their query string, we’ll move the cursor to the match.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The strstr() function finds the first occurrence of the substring <em>query</em> in the string <em>row-&gt;render</em>.</p>

<p>Then, we evaluate if match is not NULL and move the cursor (E.cy, E.cx) to that position. Realize that  we set “E.cx” substratic the pointer ‘row-&gt;render’ to ‘match’ giving as result the number of offsets between the two of them in the row, this is; the offset in which ‘match’ starts.</p>

<p>Lastly, we set E.rowoff so that we are scrolled to the very bottom of the file, which will cause editorScroll() to scroll upwards at the next screen refresh so that the matching line will be at the very top of the screen.</p>

<p>We assigned a render index to E.cx, but E.cx is an index into chars. If there are tabs to the left of the match, the cursor is going to be in the wrong position. We need to convert the render index into a chars index before assigning it to E.cx. Let’s create an editorRowRxToCx() function, which is the opposite of the editorRowCxToRx()</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">editorRowRxToCx</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cx</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">cx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">cx</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span>
      <span class="n">cur_rx</span> <span class="o">+=</span> <span class="p">(</span><span class="n">KILO_TAB_STOP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">cur_rx</span> <span class="o">%</span> <span class="n">KILO_TAB_STOP</span><span class="p">);</span>
    <span class="n">cur_rx</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur_rx</span> <span class="o">&gt;</span> <span class="n">rx</span><span class="p">)</span> <span class="k">return</span> <span class="n">cx</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">cx</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And call it in <em>editorFind()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, let’s map Ctrl-F to the <em>editorFind()</em> function, and add it to the help message we set in main():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorProcessKeypress</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">'\r'</span><span class="p">:</span>
      <span class="n">editorInsertNewline</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'q'</span><span class="p">):</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&amp;&amp;</span> <span class="n">quit_times</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"WARNING!!! File has unsaved changes. "</span>
          <span class="s">"Press Ctrl-Q %d more times to quit."</span><span class="p">,</span> <span class="n">quit_times</span><span class="p">);</span>
        <span class="n">quit_times</span><span class="o">--</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[2J"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">write</span><span class="p">(</span><span class="n">STDOUT_FILENO</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[H"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'s'</span><span class="p">):</span>
      <span class="n">editorSave</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HOME_KEY</span><span class="p">:</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">END_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
        <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'f'</span><span class="p">):</span>
      <span class="n">editorFind</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">BACKSPACE</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">):</span>
    <span class="k">case</span> <span class="n">DEL_KEY</span><span class="p">:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span><span class="p">)</span> <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">ARROW_RIGHT</span><span class="p">);</span>
      <span class="n">editorDelChar</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">PAGE_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">PAGE_DOWN</span><span class="p">:</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_DOWN</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">times</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">times</span><span class="o">--</span><span class="p">)</span>
          <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PAGE_UP</span> <span class="o">?</span> <span class="n">ARROW_UP</span> <span class="o">:</span> <span class="n">ARROW_DOWN</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ARROW_UP</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_DOWN</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_LEFT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">ARROW_RIGHT</span><span class="p">:</span>
      <span class="n">editorMoveCursor</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'l'</span><span class="p">):</span>
    <span class="k">case</span> <span class="sc">'\x1b'</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">editorInsertChar</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">quit_times</span> <span class="o">=</span> <span class="n">KILO_QUIT_TIMES</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">enableRawMode</span><span class="p">();</span>
  <span class="n">initEditor</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorOpen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span>
    <span class="s">"HELP: Ctrl-S = save | Ctrl-Q = quit | Ctrl-F = find"</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="n">editorProcessKeypress</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="52-incremental-search">5.2. Incremental Search.</h4>

<p>Now, let’s make our search feature fancy. We want to support incremental search, meaning the file is searched after each keypress when the user is typing in their search query.</p>

<p>To implement this, we’re going to get editorPrompt() to take a callback function as an argument. We’ll have it call this function after each keypress, passing the current search query inputted by the user and the last key they pressed:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">*</span><span class="nf">editorPrompt</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
    <span class="n">editorRefreshScreen</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">editorReadKey</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">DEL_KEY</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">CTRL_KEY</span><span class="p">(</span><span class="sc">'h'</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">BACKSPACE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">buf</span><span class="p">[</span><span class="o">--</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="n">bufsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bufsize</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
      <span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="n">callback</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We will start saying that a “callback function” is a function that gets passed as an argument to another function, which then “calls back” (invokes) that function at specific points during its execution. It’s a way to customize behavior without modifying the original function’s code.</p>

<p>We implement the callback function at several points on the code:</p>

<ul>
  <li>After each character is typed or deleted</li>
  <li>When user presses Escape (canceling)</li>
  <li>When user presses Enter (confirming)</li>
</ul>

<p>This design enables incremental search; as the user types each character, the callback can immediately search the file and highlight matches.</p>

<p>The if statements allow the caller to pass NULL for the callback, in case they don’t want to use a callback. This is the case when we prompt the user for a filename, so let’s pass NULL to editorPrompt() when we do that. We’ll also pass NULL to editorPrompt() in editorFind() for now, to get the code to compile.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s (ESC to cancel)"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Save aborted"</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">query</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now that we handle those cases in which we dont want to perform a callback when the user enters input on the prompt, lets define the actual callback function and implements in <em>editorFind()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">,</span> <span class="n">editorFindCallback</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lets check that in <em>editorFindCallback()</em> function, we just reused the search codeblock and we just check if the user press Enter or Escape. Thus, every time a user press a key, the callback function will peroform a search of the query string of chars.</p>

<p><br /></p>

<h4 id="53-restore-cursor-position-when-cancelling-search">5.3. Restore cursor position when cancelling search.</h4>

<p>When the user presses Escape to cancel a search, we want the cursor to go back to where it was when they started the search. To do that, we’ll have to save their cursor position and scroll position, and restore those values after the search is cancelled:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">saved_cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">saved_cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">saved_coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">saved_rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (ESC to cancel)"</span><span class="p">,</span> <span class="n">editorFindCallback</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">saved_cx</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">saved_cy</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">saved_coloff</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">saved_rowoff</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If query is NULL, that means they pressed Escape, so in that case we restore the values we saved.</p>

<p>The last feature we’d like to add is to allow the user to advance to the next or previous match in the file using the arrow keys. The ↑ and ← keys will go to the previous match, and the ↓ and → keys will go to the next match.</p>

<p>We’ll implement this feature using two static variables in our callback. last_match will contain the index of the row that the last match was on, or -1 if there was no last match. And direction will store the direction of the search: 1 for searching forward, and -1 for searching backward.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_RIGHT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_DOWN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_LEFT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_UP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, we always reset last_match to -1 unless an arrow key was pressed. So we’ll only advance to the next or previous match when an arrow key is pressed. You can also see that we always set direction to 1 unless the ← or ↑ key was pressed. So we always search in the forward direction unless the user specifically asks to search backwards from the last match.</p>

<p>If key is ‘\r’ (Enter) or ‘\x1b’ (Escape), that means we’re about to leave search mode. So we reset last_match and direction to their initial values to get ready for the next search operation.</p>

<p>Now that we have those variables all set up, let’s put them to use.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_RIGHT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_DOWN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_LEFT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_UP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">last_match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">last_match</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">current</span> <span class="o">+=</span> <span class="n">direction</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">current</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">last_match</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>current is the index of the current row we are searching. If there was a last match, it starts on the line after (or before, if we’re searching backwards). If there wasn’t a last match, it starts at the top of the file and searches in the forward direction to find the first match.</p>

<p>The if … else if causes current to go from the end of the file back to the beginning of the file, or vice versa, to allow a search to “wrap around” the end of a file and continue from the top (or bottom).</p>

<p>When we find a match, we set last_match to current, so that if the user presses the arrow keys, we’ll start the next search from that point.</p>

<p>Finally, let’s not forget to update the prompt text to let the user know they can use the arrow keys.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFind</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">saved_cx</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">saved_cy</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">saved_coloff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">saved_rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">query</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Search: %s (Use ESC/Arrows/Enter)"</span><span class="p">,</span>
                             <span class="n">editorFindCallback</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">saved_cx</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">saved_cy</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="n">saved_coloff</span><span class="p">;</span>
    <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">saved_rowoff</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="6-syntax-highlighting">6. Syntax highlighting.</h3>

<h4 id="61-colorful-digits-">6.1. Colorful digits-</h4>

<p>Let’s start by just getting some color on the screen, as simply as possible. We’ll attempt to highlight numbers by coloring each digit character red.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[31m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Realize that we can no longer just feed the substring of render that we want to print right into abAppend(). We’ll have to do it character-by-character from now on.  So we loop through the characters and use <em>isdigit()</em> on each one to test if it is a digit character. If it is, we precede it with the ‘31m’ escape sequence and follow it by the ‘39m’ sequence.</p>

<p>We previously used the m command to draw the status bar using inverted colors. Now we are using it to set the text color. The VT100 User Guide doesn’t document color, so let’s turn to the Wikipedia article on ANSI escape codes. It includes a large table containing all the different argument codes you can use with the m command on various terminals. It also includes the ANSI color table with the 8 foreground/background colors available.</p>

<p><br /></p>

<h4 id="62-refractor-highlighting">6.2. Refractor highlighting.</h4>

<p>Now we know how to color text, but we’re going to have to do a lot more work to actually highlight entire strings, keywords, comments, and so on. We can’t just decide what color to use based on the class of each character, like we’re doing with digits currently.</p>

<p>What we want to do is figure out the highlighting for each row of text before we display it, and then rehighlight a line whenever it gets changed. To do that, we need to store the highlighting of each line in an array. Let’s add an array to the erow struct named hl, which stands for “highlight”.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">erow</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rsize</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">render</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">erow</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">editorInsertRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span><span class="p">));</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">hl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorFreeRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">);</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>hl is an array of unsigned char values, meaning integers in the range of 0 to 255. Each value in the array will correspond to a character in render, and will tell you whether that character is part of a string, or a comment, or a number, and so on. Let’s create an enum containing the possible values that the hl array can contain.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorHighlight</span> <span class="p">{</span>
  <span class="n">HL_NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">HL_NUMBER</span>
<span class="p">};</span>
</code></pre></div></div>

<p>For now, we’ll focus on highlighting numbers only.</p>

<p>So we want every character that’s part of a number to have a corresponding HL_NUMBER value in the hl array, and we want every other value in hl to be HL_NORMAL.</p>

<p>Let’s create a new <em>editorUpdateSyntax()</em> function.</p>

<p>This function will go through the characters of an erow and highlight them by setting each value in the hl array.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>First, we realloc ‘hl’ array to fulfill the size of the row.</li>
  <li>Then, with memset we fill al the slots of the char’s array with HL_NORMAL value.</li>
  <li>Then, we loop every char in the row to identify digts with isdigit() and we register the matchs in hl with HL_NUMBER value.</li>
</ul>

<p>Lastly, we call <em>editorUpdateSyntax()</em> in editorUpdateRow():</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateRow</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">tabs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="n">tabs</span><span class="o">++</span><span class="p">;</span>
  <span class="n">free</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">tabs</span><span class="o">*</span><span class="p">(</span><span class="n">KILO_TAB_STOP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\t'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="n">KILO_TAB_STOP</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">chars</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
  <span class="n">editorUpdateSyntax</span><span class="p">(</span><span class="n">row</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>editorUpdateRow() already has the job of updating the render array whenever the text of the row changes, so it makes sense that that’s where we want to update the hl array. So after updating render, we call editorUpdateSyntax() at the end.</p>

<p>Next, let’s make an editorSyntaxToColor() function that maps values in hl to the actual ANSI color codes we want to draw them with.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">editorSyntaxToColor</span><span class="p">(</span><span class="kt">int</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HL_NUMBER</span><span class="p">:</span> <span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="k">return</span> <span class="mi">37</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We return the ANSI code for “foreground red” for numbers, and “foreground white” for anything else that might slip through. (We’ll be handling HL_NORMAL separately, so editorSyntaxToColor() doesn’t need to handle it.)</p>

<p>Now, lets draw the highlighted text to the screen.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">hl</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">HL_NORMAL</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">editorSyntaxToColor</span><span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
          <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
          <span class="kt">int</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%dm"</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>First we get a pointer, hl, to the slice of the hl array that corresponds to the slice of render that we are printing.</p>
  </li>
  <li>
    <p>Then, for each character, if it’s an HL_NORMAL character, we use ‘39m’ to make sure we’re using the default text color before printing it. If it’s not HL_NORMAL, we use snprintf() to write the escape sequence into a buffer which we pass to abAppend() before appending the actual character.</p>
  </li>
  <li>
    <p>Finally, after we’re done looping through all the characters and displaying them, we print a final ‘39m’ escape sequence to make sure the text color is reset to default.</p>
  </li>
</ul>

<p>In practice, most characters are going to be the same color as the previous character, so most of the escape sequences are redundant. Let’s keep track of the current text color as we loop through the characters, and only print out an escape sequence when the color changes.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">hl</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">int</span> <span class="n">current_color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">HL_NORMAL</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">current_color</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">editorSyntaxToColor</span><span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">!=</span> <span class="n">current_color</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
            <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%dm"</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>current_color is -1 when we want the default text color, otherwise it is set to the value that editorSyntaxToColor() last returned. When the color changes, we print out the escape sequence for that color and set current_color to the new color.</p>

<p><br /></p>

<h4 id="63-colorful-search-results">6.3. Colorful search results.</h4>

<p>Before we start highlighting strings and keywords and all that, let’s use our highlighting system to highlight search results. We’ll start by adding HL_MATCH to the editorHighlight enum, and mapping it to the color blue (34) in editorSyntaxToColor().</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorHighlight</span> <span class="p">{</span>
  <span class="n">HL_NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">HL_NUMBER</span><span class="p">,</span>
  <span class="n">HL_MATCH</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">editorSyntaxToColor</span><span class="p">(</span><span class="kt">int</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HL_NUMBER</span><span class="p">:</span> <span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_MATCH</span><span class="p">:</span> <span class="k">return</span> <span class="mi">34</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="k">return</span> <span class="mi">37</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now all we have to do is memset() the matched substring to HL_MATCH in our search code.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_RIGHT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_DOWN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_LEFT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_UP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">last_match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">last_match</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">current</span> <span class="o">+=</span> <span class="n">direction</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">current</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">last_match</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">],</span> <span class="n">HL_MATCH</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">query</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="64-restore-syntax-highlighting-after-search">6.4. Restore syntax highlighting after search.</h4>

<p>Currently, search results stay highlighted in blue even after the user is done using the search feature. We want to restore hl to its previous value after each search.</p>

<p>To do that, we’ll save the original contents of hl in a static variable named <em>saved_hl</em> in editorFindCallback(), and restore hl to the contents of saved_hl at the top of the callback.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorFindCallback</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">saved_hl_line</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">saved_hl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">saved_hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">saved_hl_line</span><span class="p">].</span><span class="n">hl</span><span class="p">,</span> <span class="n">saved_hl</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">saved_hl_line</span><span class="p">].</span><span class="n">rsize</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">saved_hl</span><span class="p">);</span>
    <span class="n">saved_hl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="sc">'\r'</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="sc">'\x1b'</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_RIGHT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_DOWN</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_LEFT</span> <span class="o">||</span> <span class="n">key</span> <span class="o">==</span> <span class="n">ARROW_UP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">last_match</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">last_match</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">current</span> <span class="o">=</span> <span class="n">last_match</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">current</span> <span class="o">+=</span> <span class="n">direction</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="n">current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">erow</span> <span class="o">*</span><span class="n">row</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">current</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">,</span> <span class="n">query</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">last_match</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="n">editorRowRxToCx</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">);</span>
      <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span>
      <span class="n">saved_hl_line</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
      <span class="n">saved_hl</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">saved_hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
      <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">match</span> <span class="o">-</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">],</span> <span class="n">HL_MATCH</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">query</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We use another static variable named saved_hl_line to know which line’s hl needs to be restored. saved_hl is a dynamically allocated array which points to NULL when there is nothing to restore. If there is something to restore, we memcpy() it to the saved line’s hl and then deallocate saved_hl and set it back to NULL.</p>

<p><br /></p>

<h4 id="65-colorful-numbers">6.5. Colorful numbers.</h4>

<p>Alright, let’s start working on highlighting numbers properly. First, we’ll change our for loop in editorUpdateSyntax() to a while loop, to allow us to consume multiple characters each iteration. (We’ll only consume one character at a time for numbers, but this will be useful for later.)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s define an is_separator() function that takes a character and returns true if it’s considered a separator character.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">is_separator</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">isspace</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\0'</span> <span class="o">||</span> <span class="n">strchr</span><span class="p">(</span><span class="s">",.()+-/*=~%&lt;&gt;[];"</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>strchr() comes from <em>string.h</em>. It looks for the first occurrence of a character in a string, and returns a pointer to the matching character in the string. If the string doesn’t contain the character, strchr() returns NULL.</p>

<p>Right now, numbers are highlighted even if they’re part of an identifier, such as the 32 in int32_t. To fix that, we’ll require that numbers are preceded by a separator character, which includes whitespace or punctuation characters. We also include the null byte (‘\0’), because then we can count the null byte at the end of each line as a separator, which will make some of our code simpler in the future.</p>

<p>Let’s add a prev_sep variable to editorUpdateSyntax() that keeps track of whether the previous character was a separator. Then let’s use it to recognize and highlight numbers properly.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We initialize prev_sep to 1 (meaning true) because we consider the beginning of the line to be a separator. (Otherwise numbers at the very beginning of the line wouldn’t be highlighted.)</p>

<p>prev_hl is set to the highlight type of the previous character. To highlight a digit with HL_NUMBER, we now require the previous character to either be a separator, or to also be highlighted with HL_NUMBER.</p>

<p>When we decide to highlight the current character a certain way (HL_NUMBER in this case), we increment i to “consume” that character, set prev_sep to 0 to indicate we are in the middle of highlighting something, and then continue the loop. We will use this pattern for each thing that we highlight.</p>

<p>If we end up not highlighting the current character, then we’ll end up at the bottom of the while loop, where we set prev_sep according to whether the current character is a separator, and we increment i to consume the character. The memset() we did at the top of the function means that an unhighlighted character will have a value of HL_NORMAL in hl.</p>

<p>Now let’s support highlighting numbers that contain decimal points.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
      <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="66-detect-filetype">6.6. Detect filetype.</h4>

<p>Before we go on to highlight other things, we’re going to add filetype detection to our editor. This will allow us to have different rules for how to highlight different types of files. For example, text files shouldn’t have any highlighting, and C files should highlight numbers, strings, C/C++-style comments, and many different keywords specific to C.</p>

<p>Let’s create an editorSyntax struct that will contain all the syntax highlighting information for a particular filetype.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define HL_HIGHLIGHT_NUMBERS (1&lt;&lt;0)
</span>
<span class="k">struct</span> <span class="n">editorSyntax</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filetype</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">filematch</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>The filetype field is the name of the filetype that will be displayed to the user in the status bar.</li>
  <li>The filematch is an array of strings, where each string contains a pattern to match a filename against.</li>
</ul>

<p>Then, if the filename matches, then the file will be recognized as having that filetype. Finally, flags is a bit field that will contain flags for whether to highlight numbers and whether to highlight strings for that filetype. For now, we define just the HL_HIGHLIGHT_NUMBERS flag bit.</p>

<p>Now let’s make an array of built-in editorSyntax structs, and add one for the C language to it:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#define HLDB_ENTRIES (sizeof(HLDB) / sizeof(HLDB[0]))
</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">C_HL_extensions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">".c"</span><span class="p">,</span> <span class="s">".h"</span><span class="p">,</span> <span class="s">".cpp"</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">struct</span> <span class="n">editorSyntax</span> <span class="n">HLDB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
    <span class="s">"c"</span><span class="p">,</span>
    <span class="n">C_HL_extensions</span><span class="p">,</span>
    <span class="n">HL_HIGHLIGHT_NUMBERS</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Thus, HLDB stands for “highlight database”. Our editorSyntax struct for the C language contains the string “c” for the filetype field, the extensions “.c”, “.h”, and “.cpp” for the filematch field (the array must be terminated with NULL), and the HL_HIGHLIGHT_NUMBERS flag turned on in the flags field.</p>

<p>We then define an HLDB_ENTRIES constant to store the length of the HLDB array.</p>

<p>Now let’s add a pointer to the current editorSyntax struct in our global editor state, and initialize it to NULL.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorConfig</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rowoff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">coloff</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screenrows</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">screencols</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">numrows</span><span class="p">;</span>
  <span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">dirty</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">statusmsg</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">time_t</span> <span class="n">statusmsg_time</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">editorSyntax</span> <span class="o">*</span><span class="n">syntax</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">termios</span> <span class="n">orig_termios</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">editorConfig</span> <span class="n">E</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">initEditor</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">coloff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">statusmsg_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">getWindowSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"getWindowSize"</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When E.syntax is NULL, that means there is no filetype for the current file, and no syntax highlighting should be done.</p>

<p>Let’s show the current filetype in the status bar. If E.syntax is NULL, then we’ll display no ft (“no filetype”) instead.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawStatusBar</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="kt">char</span> <span class="n">status</span><span class="p">[</span><span class="mi">80</span><span class="p">],</span> <span class="n">rstatus</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="s">"%.20s - %d lines %s"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">:</span> <span class="s">"[No Name]"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">?</span> <span class="s">"(modified)"</span> <span class="o">:</span> <span class="s">""</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">rlen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">rstatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rstatus</span><span class="p">),</span> <span class="s">"%s | %d/%d"</span><span class="p">,</span>
    <span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">?</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">filetype</span> <span class="o">:</span> <span class="s">"no ft"</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">cy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">len</span> <span class="o">==</span> <span class="n">rlen</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">rstatus</span><span class="p">,</span> <span class="n">rlen</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">len</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s change editorUpdateSyntax() to take the current E.syntax value into account.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If no filetype is set, we return immediately after memset()ting the entire line to HL_NORMAL. We also wrap the number-highlighting code in an if statement that checks to see if numbers should be highlighted for the current filetype.</p>

<p>Now we’ll create an editorSelectSyntaxHighlight() function that tries to match the current filename to one of the filematch fields in the HLDB. If one matches, it’ll set E.syntax to that filetype.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSelectSyntaxHighlight</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">HLDB_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">editorSyntax</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HLDB</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">is_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">is_ext</span> <span class="o">&amp;&amp;</span> <span class="n">ext</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">||</span>
          <span class="p">(</span><span class="o">!</span><span class="n">is_ext</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>strrchr() and strcmp() come from <string.h>. strrchr() returns a pointer to the last occurrence of a character in a string, and strcmp() returns 0 if two given strings are equal.</string.h></p>

<p>First we set E.syntax to NULL, so that if nothing matches or if there is no filename, then there is no filetype.</p>

<p>Then we get a pointer to the extension part of the filename by using strrchr() to find the last occurrence of the . character. If there is no extension, then ext will be NULL.</p>

<p>Finally, we loop through each editorSyntax struct in the HLDB array, and for each one of those, we loop through each pattern in its filematch array. If the pattern starts with a ., then it’s a file extension pattern, and we use strcmp() to see if the filename ends with that extension. If it’s not a file extension pattern, then we just check to see if the pattern exists anywhere in the filename, using strstr(). If the filename matched according to those rules, then we set E.syntax to the current editorSyntax struct, and return.</p>

<p>We want to call editorSelectSyntaxHighlight() wherever E.filename changes. This is in editorOpen() and editorSave().</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorOpen</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">free</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
  <span class="n">editorSelectSyntaxHighlight</span><span class="p">();</span>
  <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="n">die</span><span class="p">(</span><span class="s">"fopen"</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">linecap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">ssize_t</span> <span class="n">linelen</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">linelen</span> <span class="o">=</span> <span class="n">getline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linecap</span><span class="p">,</span> <span class="n">fp</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">linelen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span>
                           <span class="n">line</span><span class="p">[</span><span class="n">linelen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\r'</span><span class="p">))</span>
      <span class="n">linelen</span><span class="o">--</span><span class="p">;</span>
    <span class="n">editorInsertRow</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">linelen</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorSave</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">editorPrompt</span><span class="p">(</span><span class="s">"Save as: %s (ESC to cancel)"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Save aborted"</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">editorSelectSyntaxHighlight</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">editorRowsToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="n">E</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"%d bytes written to disk"</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
  <span class="n">editorSetStatusMessage</span><span class="p">(</span><span class="s">"Can't save! I/O error: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this point, when you open a C file in the editor, you should see numbers getting highlighted, and you should see c in the status bar where we display the filetype. When you start up the editor with no arguments and save the file with a filename that ends in .c, you should see the filetype in the status bar change satisfyingly from no ft to c. However, any numbers you might have in the file will not be highlighted! Very unsatisfying!</p>

<p>Let’s rehighlight the entire file after setting E.syntax in editorSelectSyntaxHighlight().</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorSelectSyntaxHighlight</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">HLDB_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">editorSyntax</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HLDB</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">is_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">is_ext</span> <span class="o">&amp;&amp;</span> <span class="n">ext</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">||</span>
          <span class="p">(</span><span class="o">!</span><span class="n">is_ext</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">filematch</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
        <span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">filerow</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">filerow</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">filerow</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">editorUpdateSyntax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="67-colorful-strings">6.7. Colorful strings.</h4>

<p>With all that out of the way, we can finally get to highlighting more things! Let’s start with strings.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorHighlight</span> <span class="p">{</span>
  <span class="n">HL_NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">HL_STRING</span><span class="p">,</span>
  <span class="n">HL_NUMBER</span><span class="p">,</span>
  <span class="n">HL_MATCH</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">editorSyntaxToColor</span><span class="p">(</span><span class="kt">int</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HL_STRING</span><span class="p">:</span> <span class="k">return</span> <span class="mi">35</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_NUMBER</span><span class="p">:</span> <span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_MATCH</span><span class="p">:</span> <span class="k">return</span> <span class="mi">34</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="k">return</span> <span class="mi">37</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We’re coloring strings magenta (35).</p>

<p>Now let’s add an HL_HIGHLIGHT_STRINGS bit flag to the flags field of the editorSyntax struct, and turn on the flag when highlighting C files.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define HL_HIGHLIGHT_STRINGS (1&lt;&lt;1)
</span>
<span class="k">struct</span> <span class="n">editorSyntax</span> <span class="n">HLDB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
    <span class="s">"c"</span><span class="p">,</span>
    <span class="n">C_HL_extensions</span><span class="p">,</span>
    <span class="n">HL_HIGHLIGHT_NUMBERS</span> <span class="o">|</span> <span class="n">HL_HIGHLIGHT_STRINGS</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Now for the actual highlighting code. We will use an in_string variable to keep track of whether we are currently inside a string. If we are, then we’ll keep highlighting the current character as a string until we hit the closing quote.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you can see, we highlight both double-quoted strings and single-quoted strings (sorry Lispers/Rustaceans). We actually store either a double-quote (“) or a single-quote (‘) character as the value of in_string, so that we know which one closes the string.</p>

<p>So, going through the code from top to bottom: If in_string is set, then we know the current character can be highlighted with HL_STRING. Then we check if the current character is the closing quote (c == in_string), and if so, we reset in_string to 0. Then, since we highlighted the current character, we have to consume it by incrementing i and continueing out of the current loop iteration. We also set prev_sep to 1 so that if we’re done highlighting the string, the closing quote is considered a separator.</p>

<p>If we’re not currently in a string, then we have to check if we’re at the beginning of one by checking for a double- or single-quote. If we are, we store the quote in in_string, highlight it with HL_STRING, and consume it.</p>

<p>We should probably take escaped quotes into account when highlighting strings. If the sequence ' or " occurs in a string, then the escaped quote doesn’t close the string in the vast majority of languages.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="68-colorful-single-luine-comments">6.8. Colorful single-luine comments.</h4>

<p>Next let’s highlight single-line comments. (We’ll leave multi-line comments until the end, because they’re complicated.)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorHighlight</span> <span class="p">{</span>
  <span class="n">HL_NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">HL_COMMENT</span><span class="p">,</span>
  <span class="n">HL_STRING</span><span class="p">,</span>
  <span class="n">HL_NUMBER</span><span class="p">,</span>
  <span class="n">HL_MATCH</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">editorSyntaxToColor</span><span class="p">(</span><span class="kt">int</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HL_COMMENT</span><span class="p">:</span> <span class="k">return</span> <span class="mi">36</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_STRING</span><span class="p">:</span> <span class="k">return</span> <span class="mi">35</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_NUMBER</span><span class="p">:</span> <span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_MATCH</span><span class="p">:</span> <span class="k">return</span> <span class="mi">34</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="k">return</span> <span class="mi">37</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Comments will be highlighted in cyan (36).</p>

<p>We’ll let each language specify its own single-line comment pattern, as they differ a lot between languages. Let’s add a singleline_comment_start string to the editorSyntax struct, and set it to “//” for the C filetype.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorSyntax</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filetype</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">filematch</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">editorSyntax</span> <span class="n">HLDB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
    <span class="s">"c"</span><span class="p">,</span>
    <span class="n">C_HL_extensions</span><span class="p">,</span>
    <span class="s">"//"</span><span class="p">,</span>
    <span class="n">HL_HIGHLIGHT_NUMBERS</span> <span class="o">|</span> <span class="n">HL_HIGHLIGHT_STRINGS</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Now for the highlighting code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">scs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scs_len</span> <span class="o">=</span> <span class="n">scs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scs_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scs</span><span class="p">,</span> <span class="n">scs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_COMMENT</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>strncmp() comes from <em>string.h</em>.</p>

<p>If you don’t want single-line comment highlighting for a particular filetype, you should be able to set singleline_comment_start either to NULL or to the empty string (“”). We make scs an alias for E.syntax-&gt;singleline_comment_start for easier typing (and readability, perhaps?). We then set scs_len to the length of the string, or 0 if the string is NULL. This lets us use scs_len as a boolean to know whether we should highlight single-line comments.</p>

<p>So we wrap our comment highlighting code in an if statement that checks scs_len and also makes sure we’re not in a string, since we’re placing this code above the string highlighting code (order matters a lot in this function).</p>

<p>If those checks passed, then we use strncmp() to check if this character is the start of a single-line comment. If so, then we simply memset() the whole rest of the line with HL_COMMENT and break out of the syntax highlighting loop. Just like that, we’re done highlighting the line.</p>

<p><br /></p>

<h4 id="69-colorful-keywords">6.9. Colorful keywords.</h4>

<p>Now let’s turn to highlighting keywords. We’re going to allow languages to specify two types of keywords that will be highlighted in different colors. (In C, we’ll highlight actual keywords in one color and common type names in the other color.)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorHighlight</span> <span class="p">{</span>
  <span class="n">HL_NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">HL_COMMENT</span><span class="p">,</span>
  <span class="n">HL_KEYWORD1</span><span class="p">,</span>
  <span class="n">HL_KEYWORD2</span><span class="p">,</span>
  <span class="n">HL_STRING</span><span class="p">,</span>
  <span class="n">HL_NUMBER</span><span class="p">,</span>
  <span class="n">HL_MATCH</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">editorSyntaxToColor</span><span class="p">(</span><span class="kt">int</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HL_COMMENT</span><span class="p">:</span> <span class="k">return</span> <span class="mi">36</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_KEYWORD1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">33</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_KEYWORD2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">32</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_STRING</span><span class="p">:</span> <span class="k">return</span> <span class="mi">35</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_NUMBER</span><span class="p">:</span> <span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_MATCH</span><span class="p">:</span> <span class="k">return</span> <span class="mi">34</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="k">return</span> <span class="mi">37</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The two colors we’ll use for keywords are yellow (33) and green (32).</p>

<table>
  <tbody>
    <tr>
      <td>Let’s add a keywords array to the editorSyntax struct. This will be a NULL-terminated array of strings, each string containing a keyword. To differentiate between the two types of keywords, we’ll terminate the second type of keywords with a pipe (</td>
      <td>) character (also known as a vertical bar).</td>
    </tr>
  </tbody>
</table>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorSyntax</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filetype</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">filematch</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">C_HL_keywords</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">"switch"</span><span class="p">,</span> <span class="s">"if"</span><span class="p">,</span> <span class="s">"while"</span><span class="p">,</span> <span class="s">"for"</span><span class="p">,</span> <span class="s">"break"</span><span class="p">,</span> <span class="s">"continue"</span><span class="p">,</span> <span class="s">"return"</span><span class="p">,</span> <span class="s">"else"</span><span class="p">,</span>
  <span class="s">"struct"</span><span class="p">,</span> <span class="s">"union"</span><span class="p">,</span> <span class="s">"typedef"</span><span class="p">,</span> <span class="s">"static"</span><span class="p">,</span> <span class="s">"enum"</span><span class="p">,</span> <span class="s">"class"</span><span class="p">,</span> <span class="s">"case"</span><span class="p">,</span>
  <span class="s">"int|"</span><span class="p">,</span> <span class="s">"long|"</span><span class="p">,</span> <span class="s">"double|"</span><span class="p">,</span> <span class="s">"float|"</span><span class="p">,</span> <span class="s">"char|"</span><span class="p">,</span> <span class="s">"unsigned|"</span><span class="p">,</span> <span class="s">"signed|"</span><span class="p">,</span>
  <span class="s">"void|"</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">editorSyntax</span> <span class="n">HLDB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
    <span class="s">"c"</span><span class="p">,</span>
    <span class="n">C_HL_extensions</span><span class="p">,</span>
    <span class="n">C_HL_keywords</span><span class="p">,</span>
    <span class="s">"//"</span><span class="p">,</span>
    <span class="n">HL_HIGHLIGHT_NUMBERS</span> <span class="o">|</span> <span class="n">HL_HIGHLIGHT_STRINGS</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>As mentioned earlier, we’ll highlight common C types as secondary keywords, so we end each one with a</td>
      <td>character.</td>
    </tr>
  </tbody>
</table>

<p>Now let’s highlight them.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">scs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scs_len</span> <span class="o">=</span> <span class="n">scs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scs_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scs</span><span class="p">,</span> <span class="n">scs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_COMMENT</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prev_sep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">klen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">kw2</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">klen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'|'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kw2</span><span class="p">)</span> <span class="n">klen</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">klen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">is_separator</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">klen</span><span class="p">]))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kw2</span> <span class="o">?</span> <span class="n">HL_KEYWORD2</span> <span class="o">:</span> <span class="n">HL_KEYWORD1</span><span class="p">,</span> <span class="n">klen</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">klen</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First, at the top of the function we make keywords an alias for E.syntax-&gt;keywords since we’ll be using it a lot, and in some pretty dense code.</p>

<p>Keywords require a separator both before and after the keyword. Otherwise, the void in avoid, voided, or avoidable would be highlighted as a keyword, which is definitely a problem we want to, uh, circumnavigate.</p>

<table>
  <tbody>
    <tr>
      <td>So we check prev_sep to make sure a separator came before the keyword, before looping through each possible keyword. For each keyword, we store the length in klen and whether it’s a secondary keyword in kw2, in which case we decrement klen to account for the extraneous</td>
      <td>character.</td>
    </tr>
  </tbody>
</table>

<p>We then use strncmp() to check if the keyword exists at our current position in the text, and we check to see if a separator character comes after the keyword. Since \0 is considered a separator character, this works if the keyword is at the very end of the line.</p>

<p>If all that passed, then we have a keyword to highlight. We use memset() to highlight the whole keyword at once, highlighting it with HL_KEYWORD1 or HL_KEYWORD2 depending on the value of kw2. We then consume the entire keyword by incrementing i by the length of the keyword. Then we break instead of continueing, because we are in an inner loop, so we have to break out of that loop before continueing the outer loop. That is why, after the for loop, we check if the loop was broken out of by seeing if it got to the terminating NULL value, and if it was broken out of, we continue.</p>

<p><br /></p>

<h4 id="610-nonprintable-characters">6.10. Nonprintable characters.</h4>

<p>Before we tackle highlighting multi-line comments, let’s take a quick break from editorUpdateSyntax().</p>

<p>We’re going to display nonprintable characters in a more user-friendly way. Currently, nonprintable characters completely mess up the rendering that our editor does. Just try running kilo and passing itself in as an argument. That is, open the kilo executable file using kilo. And try moving the cursor around, and typing. It’s not pretty. Every keypress causes the terminal to ding, because the audible bell character (7) is being printed out. Strings containing terminal escape sequences in our code are being printed out as actual escape sequences, because that’s how they’re stored in a raw executable.</p>

<p>To prevent all that, we’re going to translate nonprintable characters into printable ones. We’ll render the alphabetic control characters (Ctrl-A = 1, Ctrl-B = 2, …, Ctrl-Z = 26) as the capital letters A through Z. We’ll also render the 0 byte like a control character. Ctrl-@ = 0, so we’ll render it as an @ sign. Finally, any other nonprintable characters we’ll render as a question mark (?). And to differentiate these characters from their printable counterparts, we’ll render them using inverted colors (black on white).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">hl</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">int</span> <span class="n">current_color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
          <span class="kt">char</span> <span class="n">sym</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">26</span><span class="p">)</span> <span class="o">?</span> <span class="sc">'@'</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">:</span> <span class="sc">'?'</span><span class="p">;</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sym</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">HL_NORMAL</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">current_color</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">editorSyntaxToColor</span><span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">!=</span> <span class="n">current_color</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
            <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%dm"</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We use iscntrl() to check if the current character is a control character. If so, we translate it into a printable character by adding its value to ‘@’ (in ASCII, the capital letters of the alphabet come after the @ character), or using the ‘?’ character if it’s not in the alphabetic range.</p>

<p>We then use the ‘7m’ escape sequence to switch to inverted colors before printing the translated symbol. We use <esc>[m to turn off inverted colors again.</esc></p>

<p>Unfortunately, ‘m’ turns off all text formatting, including colors. So let’s print the escape sequence for the current color afterwards.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorDrawRows</span><span class="p">(</span><span class="k">struct</span> <span class="n">abuf</span> <span class="o">*</span><span class="n">ab</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">filerow</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">E</span><span class="p">.</span><span class="n">rowoff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">filerow</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="n">E</span><span class="p">.</span><span class="n">screenrows</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">welcome</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">welcome</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">welcome</span><span class="p">),</span>
          <span class="s">"Kilo editor -- version %s"</span><span class="p">,</span> <span class="n">KILO_VERSION</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">welcomelen</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">welcomelen</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">screencols</span> <span class="o">-</span> <span class="n">welcomelen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">padding</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">padding</span><span class="o">--</span><span class="p">)</span> <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">welcome</span><span class="p">,</span> <span class="n">welcomelen</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"~"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">)</span> <span class="n">len</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">screencols</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">render</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">filerow</span><span class="p">].</span><span class="n">hl</span><span class="p">[</span><span class="n">E</span><span class="p">.</span><span class="n">coloff</span><span class="p">];</span>
      <span class="kt">int</span> <span class="n">current_color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iscntrl</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
          <span class="kt">char</span> <span class="n">sym</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">26</span><span class="p">)</span> <span class="o">?</span> <span class="sc">'@'</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">:</span> <span class="sc">'?'</span><span class="p">;</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[7m"</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sym</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[m"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">current_color</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%dm"</span><span class="p">,</span> <span class="n">current_color</span><span class="p">);</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">HL_NORMAL</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">current_color</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="kt">int</span> <span class="n">color</span> <span class="o">=</span> <span class="n">editorSyntaxToColor</span><span class="p">(</span><span class="n">hl</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">!=</span> <span class="n">current_color</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">current_color</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
            <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">clen</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[%dm"</span><span class="p">,</span> <span class="n">color</span><span class="p">);</span>
            <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[39m"</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\x1b</span><span class="s">[K"</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">abAppend</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="611-colorful-multiline-comments">6.11. Colorful multiline comments.</h4>

<p>Okay, we have one last feature to implement: multi-line comment highlighting. Let’s start by adding HL_MLCOMMENT to the editorHighlight enum.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">enum</span> <span class="n">editorHighlight</span> <span class="p">{</span>
  <span class="n">HL_NORMAL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">HL_COMMENT</span><span class="p">,</span>
  <span class="n">HL_MLCOMMENT</span><span class="p">,</span>
  <span class="n">HL_KEYWORD1</span><span class="p">,</span>
  <span class="n">HL_KEYWORD2</span><span class="p">,</span>
  <span class="n">HL_STRING</span><span class="p">,</span>
  <span class="n">HL_NUMBER</span><span class="p">,</span>
  <span class="n">HL_MATCH</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">editorSyntaxToColor</span><span class="p">(</span><span class="kt">int</span> <span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">hl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HL_COMMENT</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">HL_MLCOMMENT</span><span class="p">:</span> <span class="k">return</span> <span class="mi">36</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_KEYWORD1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">33</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_KEYWORD2</span><span class="p">:</span> <span class="k">return</span> <span class="mi">32</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_STRING</span><span class="p">:</span> <span class="k">return</span> <span class="mi">35</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_NUMBER</span><span class="p">:</span> <span class="k">return</span> <span class="mi">31</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">HL_MATCH</span><span class="p">:</span> <span class="k">return</span> <span class="mi">34</span><span class="p">;</span>
    <span class="nl">default:</span> <span class="k">return</span> <span class="mi">37</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We’ll highlight multi-line comments to be the same color as single-line comments (cyan).</p>

<p>Now we’ll add two strings to editorSyntax: multiline_comment_start and multiline_comment_end. In C, these will be “/<em>” and “</em>/”.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">editorSyntax</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">filetype</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">filematch</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">multiline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">multiline_comment_end</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">editorSyntax</span> <span class="n">HLDB</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>
    <span class="s">"c"</span><span class="p">,</span>
    <span class="n">C_HL_extensions</span><span class="p">,</span>
    <span class="n">C_HL_keywords</span><span class="p">,</span>
    <span class="s">"//"</span><span class="p">,</span> <span class="s">"/*"</span><span class="p">,</span> <span class="s">"*/"</span><span class="p">,</span>
    <span class="n">HL_HIGHLIGHT_NUMBERS</span> <span class="o">|</span> <span class="n">HL_HIGHLIGHT_STRINGS</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Now let’s open editorUpdateSyntax() up once again. We’ll add mcs and mce aliases that are analogous to the scs alias we already have for single-line comments. We’ll also add mcs_len and mce_len.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">scs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mce</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_end</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scs_len</span> <span class="o">=</span> <span class="n">scs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mcs_len</span> <span class="o">=</span> <span class="n">mcs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mce_len</span> <span class="o">=</span> <span class="n">mce</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mce</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scs_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scs</span><span class="p">,</span> <span class="n">scs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_COMMENT</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prev_sep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">klen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">kw2</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">klen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'|'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kw2</span><span class="p">)</span> <span class="n">klen</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">klen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">is_separator</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">klen</span><span class="p">]))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kw2</span> <span class="o">?</span> <span class="n">HL_KEYWORD2</span> <span class="o">:</span> <span class="n">HL_KEYWORD1</span><span class="p">,</span> <span class="n">klen</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">klen</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now for highliting the code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">scs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mce</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_end</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scs_len</span> <span class="o">=</span> <span class="n">scs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mcs_len</span> <span class="o">=</span> <span class="n">mcs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mce_len</span> <span class="o">=</span> <span class="n">mce</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mce</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scs_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scs</span><span class="p">,</span> <span class="n">scs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_COMMENT</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mcs_len</span> <span class="o">&amp;&amp;</span> <span class="n">mce_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_comment</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_MLCOMMENT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mce</span><span class="p">,</span> <span class="n">mce_len</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_MLCOMMENT</span><span class="p">,</span> <span class="n">mce_len</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">mce_len</span><span class="p">;</span>
          <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mcs</span><span class="p">,</span> <span class="n">mcs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_MLCOMMENT</span><span class="p">,</span> <span class="n">mcs_len</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">mcs_len</span><span class="p">;</span>
        <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prev_sep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">klen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">kw2</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">klen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'|'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kw2</span><span class="p">)</span> <span class="n">klen</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">klen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">is_separator</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">klen</span><span class="p">]))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kw2</span> <span class="o">?</span> <span class="n">HL_KEYWORD2</span> <span class="o">:</span> <span class="n">HL_KEYWORD1</span><span class="p">,</span> <span class="n">klen</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">klen</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First we add an in_comment boolean variable to keep track of whether we’re currently inside a multi-line comment (this variable isn’t used for single-line comments).</p>

<p>Moving down into the while loop, we require both mcs and mce to be non-NULL strings of length greater than 0 in order to turn on multi-line comment highlighting. We also check to make sure we’re not in a string, because having /* inside a string doesn’t start a comment in most languages. Okay, I’ll say it: all languages.</p>

<p>If we’re currently in a multi-line comment, then we can safely highlight the current character with HL_MLCOMMENT. Then we check if we’re at the end of a multi-line comment by using strncmp() with mce. If so, we use memset() to highlight the whole mce string with HL_MLCOMMENT, and then we consume it. If we’re not at the end of the comment, we simply consume the current character which we already highlighted.</p>

<p>If we’re not currently in a multi-line comment, then we use strncmp() with mcs to check if we’re at the beginning of a multi-line comment. If so, we use memset() to highlight the whole mcs string with HL_MLCOMMENT, set in_comment to true, and consume the whole mcs string.</p>

<p>Now let’s fix a bit of a complication that multi-line comments add: single-line comments should not be recognized inside multi-line comments.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">scs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mce</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_end</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scs_len</span> <span class="o">=</span> <span class="n">scs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mcs_len</span> <span class="o">=</span> <span class="n">mcs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mce_len</span> <span class="o">=</span> <span class="n">mce</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mce</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scs_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_comment</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scs</span><span class="p">,</span> <span class="n">scs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_COMMENT</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mcs_len</span> <span class="o">&amp;&amp;</span> <span class="n">mce_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_comment</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_MLCOMMENT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mce</span><span class="p">,</span> <span class="n">mce_len</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_MLCOMMENT</span><span class="p">,</span> <span class="n">mce_len</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">mce_len</span><span class="p">;</span>
          <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mcs</span><span class="p">,</span> <span class="n">mcs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_MLCOMMENT</span><span class="p">,</span> <span class="n">mcs_len</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">mcs_len</span><span class="p">;</span>
        <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prev_sep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">klen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">kw2</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">klen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'|'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kw2</span><span class="p">)</span> <span class="n">klen</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">klen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">is_separator</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">klen</span><span class="p">]))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kw2</span> <span class="o">?</span> <span class="n">HL_KEYWORD2</span> <span class="o">:</span> <span class="n">HL_KEYWORD1</span><span class="p">,</span> <span class="n">klen</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">klen</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Okay, now let’s work on highlighting multi-line comments that actually span over multiple lines. To do this, we need to know if the previous line is part of an unclosed multi-line comment. Let’s add an hl_open_comment boolean variable to the erow struct. Let’s also add an idx integer variable, so that each erow knows its own index within the file. That will allow each row to examine the previous row’s hl_open_comment value.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">erow</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rsize</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">chars</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">render</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hl</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">hl_open_comment</span><span class="p">;</span>
<span class="p">}</span> <span class="n">erow</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">editorInsertRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span><span class="p">));</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">at</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">hl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">hl_open_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We initialize idx to the row’s index in the file at the time it is inserted. Let’s make sure to update the idx of each row whenever a row is inserted into or removed from the file.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorInsertRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">at</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">chars</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">rsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">render</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">hl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">].</span><span class="n">hl_open_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">editorUpdateRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">++</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">editorDelRow</span><span class="p">(</span><span class="kt">int</span> <span class="n">at</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">at</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">at</span> <span class="o">&gt;=</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="n">editorFreeRow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">]);</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">at</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">erow</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="n">at</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">at</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">idx</span><span class="o">--</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="o">--</span><span class="p">;</span>
  <span class="n">E</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The for loops update the index of each row that was displaced by the insert or delete operation.</p>

<p>Now, the final step.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">editorUpdateSyntax</span><span class="p">(</span><span class="n">erow</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">,</span> <span class="n">HL_NORMAL</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">keywords</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">scs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">singleline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_start</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">mce</span> <span class="o">=</span> <span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">multiline_comment_end</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">scs_len</span> <span class="o">=</span> <span class="n">scs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mcs_len</span> <span class="o">=</span> <span class="n">mcs</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mcs</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mce_len</span> <span class="o">=</span> <span class="n">mce</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">mce</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">in_comment</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">hl_open_comment</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev_hl</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="n">HL_NORMAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">scs_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_comment</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scs</span><span class="p">,</span> <span class="n">scs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_COMMENT</span><span class="p">,</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mcs_len</span> <span class="o">&amp;&amp;</span> <span class="n">mce_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_comment</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_MLCOMMENT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mce</span><span class="p">,</span> <span class="n">mce_len</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_MLCOMMENT</span><span class="p">,</span> <span class="n">mce_len</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">mce_len</span><span class="p">;</span>
          <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mcs</span><span class="p">,</span> <span class="n">mcs_len</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HL_MLCOMMENT</span><span class="p">,</span> <span class="n">mcs_len</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">mcs_len</span><span class="p">;</span>
        <span class="n">in_comment</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_STRINGS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">in_string</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'\\'</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">rsize</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">in_string</span><span class="p">)</span> <span class="n">in_string</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">'\''</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">in_string</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
          <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_STRING</span><span class="p">;</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="p">.</span><span class="n">syntax</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HL_HIGHLIGHT_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">isdigit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prev_sep</span> <span class="o">||</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="n">prev_hl</span> <span class="o">==</span> <span class="n">HL_NUMBER</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HL_NUMBER</span><span class="p">;</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prev_sep</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">klen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="kt">int</span> <span class="n">kw2</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">klen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'|'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kw2</span><span class="p">)</span> <span class="n">klen</span><span class="o">--</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">klen</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">is_separator</span><span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">render</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">klen</span><span class="p">]))</span> <span class="p">{</span>
          <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">kw2</span> <span class="o">?</span> <span class="n">HL_KEYWORD2</span> <span class="o">:</span> <span class="n">HL_KEYWORD1</span><span class="p">,</span> <span class="n">klen</span><span class="p">);</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">klen</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">keywords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prev_sep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">prev_sep</span> <span class="o">=</span> <span class="n">is_separator</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">hl_open_comment</span> <span class="o">!=</span> <span class="n">in_comment</span><span class="p">);</span>
  <span class="n">row</span><span class="o">-&gt;</span><span class="n">hl_open_comment</span> <span class="o">=</span> <span class="n">in_comment</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">row</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">.</span><span class="n">numrows</span><span class="p">)</span>
    <span class="n">editorUpdateSyntax</span><span class="p">(</span><span class="o">&amp;</span><span class="n">E</span><span class="p">.</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Near the top of editorUpdateSyntax(), we initialize in_comment to true if the previous row has an unclosed multi-line comment. If that’s the case, then the current row will start out being highlighted as a multi-line comment.</p>

<p>At the bottom of editorUpdateSyntax(), we set the value of the current row’s hl_open_comment to whatever state in_comment got left in after processing the entire row. That tells us whether the row ended as an unclosed multi-line comment or not.</p>

<p><br /></p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#C">C</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=Text+Editor.&url=http%3A%2F%2Flocalhost%3A4000%2F2025-08-11-Text-Editor%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2025-08-11-Text-Editor%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2025-08-11-Text-Editor%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2025-07-11-GarbageCollector/" data-toggle="tooltip" data-placement="top" title="Garbage Collector.">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2025-11-06-LSBO/" data-toggle="tooltip" data-placement="top" title="(Linear) Stack Buffer Overflow.">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/Qv1nTv5" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/Qvintvs1" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/german-sanmillan-68b308229/" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        German
        &nbsp;&bull;&nbsp;
      
      2026

      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>


  
  
    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
