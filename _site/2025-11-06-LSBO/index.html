<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>(Linear) Stack Buffer Overflow.</title>

  
  <meta name="author" content="German">
  

  <meta name="description" content="Notes from Stack Buffer Overflow course from OST2.">

  

  

  
  <link rel="alternate" type="application/rss+xml" title="Home" href="http://localhost:4000/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  
    
      <link rel="stylesheet" href="/assets/css/custom-dark.css">
    
  

  
  
  

  

  
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="(Linear) Stack Buffer Overflow.">
  <meta property="og:description" content="Notes from Stack Buffer Overflow course from OST2.">

  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="German">
  <meta property="og:article:published_time" content="2025-11-06T00:00:00-05:00">
  <meta property="og:url" content="http://localhost:4000/2025-11-06-LSBO/">
  <link rel="canonical" href="http://localhost:4000/2025-11-06-LSBO/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@Qvintvs1">
  <meta name="twitter:creator" content="@Qvintvs1">

  <meta property="twitter:title" content="(Linear) Stack Buffer Overflow.">
  <meta property="twitter:description" content="Notes from Stack Buffer Overflow course from OST2.">

  

  

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("script[type='math/tex; mode=display']").forEach(function(el) {
      el.outerHTML = "\\[" + el.textContent + "\\]";
    });
    document.querySelectorAll("script[type='math/tex']").forEach(function(el) {
      el.outerHTML = "\\(" + el.textContent + "\\)";
    });
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
    script.async = true;
    document.head.appendChild(script);
  });
</script>


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="http://localhost:4000/">Home</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Program</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/Cpage">C</a>
                  <a class="dropdown-item" href="/DHARMApage">Dharma</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Web2</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/BURPSUITEpage">Burp</a>
                  <a class="dropdown-item" href="/THMpage">Thm</a>
                  <a class="dropdown-item" href="/HackTheBoxpage">Htb</a>
                  <a class="dropdown-item" href="/PEN200page">BasicPentesting</a>
                  <a class="dropdown-item" href="/REDTEAMBASICSpage">RedTeam</a>
                  <a class="dropdown-item" href="/BLUETEAMBASICSpage">Blueteam</a>
                  <a class="dropdown-item" href="/REDESpage">Net</a>
                  <a class="dropdown-item" href="/2022-11-17-GitBasics">Git</a>
                  <a class="dropdown-item" href="/CSOFTpage">MemCorrupt</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ZKP</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/MATHpage">Math</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
                  <a class="dropdown-item" href="/NOIRpage">Noir</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Assembly</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/ASSEMpage">x86</a>
            </div>
          </li>
        
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "P vs NP.", \
          "category" : "math", \
          "url"      : "/2026-01-11-PvsNP/", \
          "date"     : "January 11, 2026" \
        }, \
       \
        { \
          "title"    : "Race Conditions.", \
          "category" : "csoft", \
          "url"      : "/2025-12-28-RaceCondition/", \
          "date"     : "December 28, 2025" \
        }, \
       \
        { \
          "title"    : "Introducción al Cálculo", \
          "category" : "matemáticas", \
          "url"      : "/2025-12-25-MathTest/", \
          "date"     : "December 25, 2025" \
        }, \
       \
        { \
          "title"    : "Uninitialize Data Access.", \
          "category" : "csoft", \
          "url"      : "/2025-12-23-UDA/", \
          "date"     : "December 23, 2025" \
        }, \
       \
        { \
          "title"    : "Control Flow.", \
          "category" : "assem", \
          "url"      : "/2025-12-12-ControlFlow/", \
          "date"     : "December 12, 2025" \
        }, \
       \
        { \
          "title"    : "Other Integer Issues.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-OtherIntegerIssues/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Integer Overflow/Underflow.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-IntegerOverflow-Underflow/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Passing Parameters.", \
          "category" : "assem", \
          "url"      : "/2025-12-04-Passing-Parameters/", \
          "date"     : "December  4, 2025" \
        }, \
       \
        { \
          "title"    : "Stackframe; Local variables, Arrays and Structures.", \
          "category" : "assem", \
          "url"      : "/2025-12-01-LocalVars_Arrays_structs/", \
          "date"     : "December  1, 2025" \
        }, \
       \
        { \
          "title"    : "Out-Of-Bounds Write.", \
          "category" : "csoft", \
          "url"      : "/2025-11-26-Out-Of-Bounds-Write/", \
          "date"     : "November 26, 2025" \
        }, \
       \
        { \
          "title"    : "Calling Functions.", \
          "category" : "assem", \
          "url"      : "/2025-11-21-CallingFunctions/", \
          "date"     : "November 21, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Heap Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-18-HBO/", \
          "date"     : "November 18, 2025" \
        }, \
       \
        { \
          "title"    : "Basic Instructions.", \
          "category" : "assem", \
          "url"      : "/2025-11-17-AssemblyBasicRegisters/", \
          "date"     : "November 17, 2025" \
        }, \
       \
        { \
          "title"    : "Computer Registers.", \
          "category" : "assem", \
          "url"      : "/2025-11-08-ComputerRegisters/", \
          "date"     : "November  8, 2025" \
        }, \
       \
        { \
          "title"    : "CVE-2021-20294.", \
          "category" : "csoft", \
          "url"      : "/2025-11-07-CVE-2021-20294/", \
          "date"     : "November  7, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Stack Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-06-LSBO/", \
          "date"     : "November  6, 2025" \
        }, \
       \
        { \
          "title"    : "Text Editor.", \
          "category" : "C", \
          "url"      : "/2025-08-11-Text-Editor/", \
          "date"     : "August 11, 2025" \
        }, \
       \
        { \
          "title"    : "Garbage Collector.", \
          "category" : "C", \
          "url"      : "/2025-07-11-GarbageCollector/", \
          "date"     : "July 11, 2025" \
        }, \
       \
        { \
          "title"    : "Hashtables.", \
          "category" : "C", \
          "url"      : "/2025-06-13-HashTable/", \
          "date"     : "June 13, 2025" \
        }, \
       \
        { \
          "title"    : "Building my own malloc in C.", \
          "category" : "C", \
          "url"      : "/2025-06-09-BuildingOwnMalloc/", \
          "date"     : "June  9, 2025" \
        }, \
       \
        { \
          "title"    : "Malloc Tutorial", \
          "category" : "C", \
          "url"      : "/2025-06-06-MallocTutorial/", \
          "date"     : "June  6, 2025" \
        }, \
       \
        { \
          "title"    : "SharedLibraries&amp;FunctionHooking", \
          "category" : "C", \
          "url"      : "/2025-04-26-SharedLibraries&FunctionHooking/", \
          "date"     : "April 26, 2025" \
        }, \
       \
        { \
          "title"    : "File Descritors", \
          "category" : "C", \
          "url"      : "/2025-03-04-FileDescriptors/", \
          "date"     : "March  4, 2025" \
        }, \
       \
        { \
          "title"    : "Network Programming", \
          "category" : "C", \
          "url"      : "/2025-02-22-Network_Programming/", \
          "date"     : "February 22, 2025" \
        }, \
       \
        { \
          "title"    : "2. Constants and Literals in C.", \
          "category" : "C", \
          "url"      : "/2024-12-10-2.ConstantsinC-copy/", \
          "date"     : "December 10, 2024" \
        }, \
       \
        { \
          "title"    : "1. Basics of C", \
          "category" : "C", \
          "url"      : "/2024-12-02-1.BasicsOfC/", \
          "date"     : "December  2, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "DHA", \
          "url"      : "/2024-09-24-Dharma_Tutorial/", \
          "date"     : "September 24, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "fuzz", \
          "url"      : "/2024-03-22-Dharma_Tutorial-copy/", \
          "date"     : "March 22, 2024" \
        }, \
       \
        { \
          "title"    : "Mi experiencia con el OSCP", \
          "category" : "pen", \
          "url"      : "/2023-11-19-PEN200_Experience/", \
          "date"     : "November 19, 2023" \
        }, \
       \
        { \
          "title"    : "Client Side", \
          "category" : "pen", \
          "url"      : "/2023-11-17-17.Client_Side_Attacks/", \
          "date"     : "November 17, 2023" \
        }, \
       \
        { \
          "title"    : "Deep Packet Tunneling", \
          "category" : "pen", \
          "url"      : "/2023-11-16-16.Tunneling_Through_Deep_Packet_Inspection/", \
          "date"     : "November 16, 2023" \
        }, \
       \
        { \
          "title"    : "Report", \
          "category" : "pen", \
          "url"      : "/2023-11-15-15.Making_Reports/", \
          "date"     : "November 15, 2023" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "pen", \
          "url"      : "/2023-11-14-14.Metasploit/", \
          "date"     : "November 14, 2023" \
        }, \
       \
        { \
          "title"    : "Password Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-13-13.Password_Attacks/", \
          "date"     : "November 13, 2023" \
        }, \
       \
        { \
          "title"    : "Active Directory Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-12-12.Active_Directory_Attacks/", \
          "date"     : "November 12, 2023" \
        }, \
       \
        { \
          "title"    : "Port Forwarding", \
          "category" : "pen", \
          "url"      : "/2023-11-11-11.Port_Forwarding/", \
          "date"     : "November 11, 2023" \
        }, \
       \
        { \
          "title"    : "Privilege Escalation", \
          "category" : "pen", \
          "url"      : "/2023-11-10-10.Privilege_Escalation/", \
          "date"     : "November 10, 2023" \
        }, \
       \
        { \
          "title"    : "File Transfers", \
          "category" : "pen", \
          "url"      : "/2023-11-09-9.File_Tranfers/", \
          "date"     : "November  9, 2023" \
        }, \
       \
        { \
          "title"    : "Buffer Overflows", \
          "category" : "pen", \
          "url"      : "/2023-11-08-8.Buffer_Overflows/", \
          "date"     : "November  8, 2023" \
        }, \
       \
        { \
          "title"    : "Vulnerability Scanning.", \
          "category" : "pen", \
          "url"      : "/2023-11-07-7.Vulnerability_Scanning/", \
          "date"     : "November  7, 2023" \
        }, \
       \
        { \
          "title"    : "Information Gathering", \
          "category" : "pen", \
          "url"      : "/2023-11-06-6.Active_Information_Gathering/", \
          "date"     : "November  6, 2023" \
        }, \
       \
        { \
          "title"    : "Windows", \
          "category" : "pen", \
          "url"      : "/2023-11-05-5.Windows/", \
          "date"     : "November  5, 2023" \
        }, \
       \
        { \
          "title"    : "Networking", \
          "category" : "pen", \
          "url"      : "/2023-11-04-4.Networking/", \
          "date"     : "November  4, 2023" \
        }, \
       \
        { \
          "title"    : "Scripting", \
          "category" : "pen", \
          "url"      : "/2023-11-03-3.Scripting/", \
          "date"     : "November  3, 2023" \
        }, \
       \
        { \
          "title"    : "Practical Tools", \
          "category" : "pen", \
          "url"      : "/2023-11-02-2.PracticalTools/", \
          "date"     : "November  2, 2023" \
        }, \
       \
        { \
          "title"    : "Linux", \
          "category" : "pen", \
          "url"      : "/2023-11-01-1.Linux/", \
          "date"     : "November  1, 2023" \
        }, \
       \
        { \
          "title"    : "Easy", \
          "category" : "hack", \
          "url"      : "/2022-12-01-Easy/", \
          "date"     : "December  1, 2022" \
        }, \
       \
        { \
          "title"    : "Git Basics", \
          "category" : "", \
          "url"      : "/2022-11-17-GitBasics/", \
          "date"     : "November 17, 2022" \
        }, \
       \
        { \
          "title"    : "Tier I", \
          "category" : "hack", \
          "url"      : "/2022-11-10-Tier_1/", \
          "date"     : "November 10, 2022" \
        }, \
       \
        { \
          "title"    : "Tier 0", \
          "category" : "hack", \
          "url"      : "/2022-11-09-Tier_0/", \
          "date"     : "November  9, 2022" \
        }, \
       \
        { \
          "title"    : "7.BufferOverflow.", \
          "category" : "thm", \
          "url"      : "/2022-11-02-7.BufferOverflow/", \
          "date"     : "November  2, 2022" \
        }, \
       \
        { \
          "title"    : "6.Offensive Pentesting", \
          "category" : "thm", \
          "url"      : "/2022-11-01-6.OffensivePentesting/", \
          "date"     : "November  1, 2022" \
        }, \
       \
        { \
          "title"    : "5.RedTeam", \
          "category" : "thm", \
          "url"      : "/2022-10-30-5.RedTeam/", \
          "date"     : "October 30, 2022" \
        }, \
       \
        { \
          "title"    : "4.Windows", \
          "category" : "thm", \
          "url"      : "/2022-10-22-4.Windows/", \
          "date"     : "October 22, 2022" \
        }, \
       \
        { \
          "title"    : "3.Junior Penetrationtester path", \
          "category" : "thm", \
          "url"      : "/2022-09-02-3.JRPenetrationTester/", \
          "date"     : "September  2, 2022" \
        }, \
       \
        { \
          "title"    : "2.Complete Begginer path.", \
          "category" : "thm", \
          "url"      : "/2022-08-07-2.CompleteBegginer/", \
          "date"     : "August  7, 2022" \
        }, \
       \
        { \
          "title"    : "1.Pre-Security path.", \
          "category" : "thm", \
          "url"      : "/2022-07-11-1Pre-Security/", \
          "date"     : "July 11, 2022" \
        }, \
       \
        { \
          "title"    : "0.Scripting for pentesters.", \
          "category" : "thm", \
          "url"      : "/2022-07-10-0.Scripting_for_pentesters/", \
          "date"     : "July 10, 2022" \
        }, \
       \
        { \
          "title"    : "Burp Certified Practitioner Practice Exam.", \
          "category" : "burp", \
          "url"      : "/2022-03-30-PracticeExam/", \
          "date"     : "March 30, 2022" \
        }, \
       \
        { \
          "title"    : "22. OAuth Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-27-22.OAuth_authentication/", \
          "date"     : "March 27, 2022" \
        }, \
       \
        { \
          "title"    : "21. HTTP Request Smuggling.", \
          "category" : "burp", \
          "url"      : "/2022-03-26-21.HTTP_request_smuggling/", \
          "date"     : "March 26, 2022" \
        }, \
       \
        { \
          "title"    : "20. HTTP Host Header Attacks.", \
          "category" : "burp", \
          "url"      : "/2022-03-25-20.HTTP_Host_header_attacks/", \
          "date"     : "March 25, 2022" \
        }, \
       \
        { \
          "title"    : "19. Web Cache Poisoning.", \
          "category" : "burp", \
          "url"      : "/2022-03-24-19.Web_cache_poisoning/", \
          "date"     : "March 24, 2022" \
        }, \
       \
        { \
          "title"    : "18. Server-Side Template Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-23-18.Serve-side_template_injection/", \
          "date"     : "March 23, 2022" \
        }, \
       \
        { \
          "title"    : "17. Insecure Deserialization.", \
          "category" : "burp", \
          "url"      : "/2022-03-22-17.Insecure_deserialization/", \
          "date"     : "March 22, 2022" \
        }, \
       \
        { \
          "title"    : "16. WebSockets.", \
          "category" : "burp", \
          "url"      : "/2022-03-21-16.WebSockets/", \
          "date"     : "March 21, 2022" \
        }, \
       \
        { \
          "title"    : "15.DOM-based XSS vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-20-15-DOM-based_vulnerabilities/", \
          "date"     : "March 20, 2022" \
        }, \
       \
        { \
          "title"    : "14. Clickjacking.", \
          "category" : "burp", \
          "url"      : "/2022-03-19-14.Clickjacking/", \
          "date"     : "March 19, 2022" \
        }, \
       \
        { \
          "title"    : "13. Cross-Origin Resource Sharing.", \
          "category" : "burp", \
          "url"      : "/2022-03-18-13.Cross-origin_resource_sharing_(CORS)/", \
          "date"     : "March 18, 2022" \
        }, \
       \
        { \
          "title"    : "12. Cross-Site Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-17-12.Cross-site_request_forgery_(CSRF)/", \
          "date"     : "March 17, 2022" \
        }, \
       \
        { \
          "title"    : "11. Cross-Site Scripting.", \
          "category" : "burp", \
          "url"      : "/2022-03-16-11.Cross-site_scripting_(XSS)/", \
          "date"     : "March 16, 2022" \
        }, \
       \
        { \
          "title"    : "10. XXE Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-15-10.XXE_injection/", \
          "date"     : "March 15, 2022" \
        }, \
       \
        { \
          "title"    : "9. Server-Side Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-14-9.Server-side_request_forgery/", \
          "date"     : "March 14, 2022" \
        }, \
       \
        { \
          "title"    : "8. File Upload.", \
          "category" : "burp", \
          "url"      : "/2022-03-13-8.File_upload_vulnerabilities/", \
          "date"     : "March 13, 2022" \
        }, \
       \
        { \
          "title"    : "7. Access Control.", \
          "category" : "burp", \
          "url"      : "/2022-03-12-7.Access_control/", \
          "date"     : "March 12, 2022" \
        }, \
       \
        { \
          "title"    : "6. Information Disclosure.", \
          "category" : "burp", \
          "url"      : "/2022-03-11-6.Information_disclosure/", \
          "date"     : "March 11, 2022" \
        }, \
       \
        { \
          "title"    : "5. Bussiness Logic Vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-10-5.Business_logic_vulnerabilities/", \
          "date"     : "March 10, 2022" \
        }, \
       \
        { \
          "title"    : "4. Command Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-09-4.Command_Injection/", \
          "date"     : "March  9, 2022" \
        }, \
       \
        { \
          "title"    : "3. Directory Traversal.", \
          "category" : "burp", \
          "url"      : "/2022-03-08-3.Directory_Traversal/", \
          "date"     : "March  8, 2022" \
        }, \
       \
        { \
          "title"    : "2. Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-07-2.Authentication/", \
          "date"     : "March  7, 2022" \
        }, \
       \
        { \
          "title"    : "1. SQLInjection", \
          "category" : "burp", \
          "url"      : "/2022-03-06-1.SQLInjection/", \
          "date"     : "March  6, 2022" \
        }, \
       \
        { \
          "title"    : "Seguridad Perimetral", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Seguridad_Perimetral/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Hardening de sistemas", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Hardening_de_sistemas/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Bandit", \
          "category" : "otw", \
          "url"      : "/2022-02-08-Bandit/", \
          "date"     : "February  8, 2022" \
        }, \
       \
        { \
          "title"    : "Proxy", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Proxys/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Protocolos Relevantes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Protocolos_Importantes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Curso Básico Redes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Precurso_Redes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "IPs", \
          "category" : "redes", \
          "url"      : "/2022-02-07-IPs/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Movimientos Laterales", \
          "category" : "redteam", \
          "url"      : "/2022-02-06-Introducci%C3%B3n_a_movimientos_laterales/", \
          "date"     : "February  6, 2022" \
        }, \
       \
        { \
          "title"    : "Evasión de Defensas", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Evasi%C3%B3n_de_Defensas/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Escalada de privilegios", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Escalada_de_privilegios/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "redteam", \
          "url"      : "/2022-02-04-Metasploit_B%C3%A1sico/", \
          "date"     : "February  4, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a aplicaciones Android", \
          "category" : "redteam", \
          "url"      : "/2022-02-03-Ataques_aplicaciones_android/", \
          "date"     : "February  3, 2022" \
        }, \
       \
        { \
          "title"    : "Ataque a aplicaciones web.", \
          "category" : "redteam", \
          "url"      : "/2022-02-02-Ataques_a_aplicaciones_web/", \
          "date"     : "February  2, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a Infraestructuras y Redes", \
          "category" : "redteam", \
          "url"      : "/2022-02-01-Ataques_a_Infraestructuras_y_Redes/", \
          "date"     : "February  1, 2022" \
        }, \
       \
        { \
          "title"    : "Análisis de Objetivos", \
          "category" : "redteam", \
          "url"      : "/2022-01-28-An%C3%A1lisis_de_Objetivos/", \
          "date"     : "January 28, 2022" \
        }, \
       \
       \
        { \
          "title"    : "Assembly and Architecture Introduction.", \
          "category" : "page", \
          "url"      : "/ASSEMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Blueteam Basics", \
          "category" : "page", \
          "url"      : "/BLUETEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PortSwigger BurpSuite Course", \
          "category" : "page", \
          "url"      : "/BURPSUITEpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C-Family Software Memory Corruption Vulnerabilities", \
          "category" : "page", \
          "url"      : "/CSOFTpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C &amp; Systems Fundamentals.", \
          "category" : "page", \
          "url"      : "/Cpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Dharma Fuzzer language", \
          "category" : "page", \
          "url"      : "/DHARMApage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Exploiting &amp; Reversing", \
          "category" : "page", \
          "url"      : "/EXPREVpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Fuzzing JavaScript Engine", \
          "category" : "page", \
          "url"      : "/Fuzzpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "HackTheBox", \
          "category" : "page", \
          "url"      : "/HackTheBoxpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/MATHpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PEN200 notes", \
          "category" : "page", \
          "url"      : "/PEN200page/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Proyectos", \
          "category" : "page", \
          "url"      : "/PROJECTSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Networking Basics", \
          "category" : "page", \
          "url"      : "/REDESpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "RedTeam Basics", \
          "category" : "page", \
          "url"      : "/REDTEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Retired Machines", \
          "category" : "page", \
          "url"      : "/RetiredMachinespage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/THMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "About me", \
          "category" : "page", \
          "url"      : "/aboutme/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "THM", \
          "category" : "page", \
          "url"      : "/preOSCPpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/tags/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page2/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page3/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page4/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page5/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page6/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page7/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page8/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page9/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page10/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page11/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page12/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page13/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page14/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page15/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page16/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page17/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page18/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page19/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page20/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>(Linear) Stack Buffer Overflow.</h1>
          
            
              <h2 class="post-subheading">Notes from Stack Buffer Overflow course from OST2.</h2>
            
          

          
            <span class="post-meta">Posted on November 6, 2025</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <h3 id="1-introduction">1. Introduction.</h3>

<h4 id="11-memory-layout">1.1. Memory Layout.</h4>

<p>First of all, let’s introduce some fundamental concepts:</p>

<ul>
  <li><em>Stack</em>:  The stack is the name of a data structure type where data is pushed onto the top and gets popped off the top. Exists a memory region which behaves like the <em>stack</em> data type and is used for temporary data storage (local variables), this is referred as the stack of the program o stack-frame of a function.</li>
</ul>

<p><img src="stack-heap.png" alt="" /></p>

<p>Let’s consider the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="kt">char</span> <span class="n">buf3</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf4</span><span class="p">;</span>
    <span class="n">buf4</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"We got an input string: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This code defines two buffers of data, then, in main it defines also two more and copyt the string passed by argument to the program in buf 1 and print the string to the stdout.</p>

<p>So let’s strip this.</p>

<ul>
  <li>
    <p>First of all, we have to notice that <em>buf1</em> and <em>buf2</em> are global variables since there aren’t within a function and because of that, they will not be in the stack, they will be in a special global areas, there are areas for initialice and not initialice variables.</p>
  </li>
  <li>
    <p>In the other hand, we have buf3 and buf4 which are in fact within a function and thus, are local variables and will be placed in the stack frame of the main function.</p>

    <p>First, we have buf3 which is a uninitialiced buffer of 8 bytes which exists in the stack.</p>

    <p>Second, we have a pointer, buf4 which is also placed in the stack and it sizes depends of the system architecture (32/64 bits). Notice that this pointer exists in the stack but malloc() reserves a chunk of 8 bytes in the heap and makes buf4 pointer to point to it so the contents of buf4 aren’t allocated in the stack but in the heap.</p>
  </li>
</ul>

<p>We can visualize this as follows:</p>

<p><img src="codevisualization1.png" alt="" /></p>

<p>So the problem relies, in if instead were using buf1 in strcpy() we were using buf3; then a potential attacker could prompt to the program a more larger input than 8 bytes overwritting other parts of the stack since there is no regulation about the amount of data passed to the buffer. For example, we could overwrite buf4 with othe memory address so buf4 now points to an attacker-controlled memory region.</p>

<p>The ultimate goal for a potential malicious actor is to gain control of the return address of the function.</p>

<p><br /></p>

<h4 id="12-stack-conventions-directions-and-endianess">1.2. Stack Conventions. Directions and Endianess.</h4>

<p>In this section we gonna see how the stack of a program gets stuffed with information.</p>

<p>First, the stack grows towards to lower address, this basically means that, since it is a continous block of memory, the bottom (start) of the stack wil be the higher mermoy address in the stack and the top (end) of the stack will be the lower address in the stack.</p>

<p>On the other hand, while stack grows to lower memory address, memory writes grows to higher address. This means that there are two things that happens at once in the stack at the time a program executes:</p>

<ul>
  <li>The stack gets filled by items of variable size that have information. This blocks of data, the stackframes, are stacked in continous order towards lower memory address.</li>
  <li>Also, the order in which each block is stuffed with data goes the reverse; from lower address to the higher address.</li>
</ul>

<p>Here is a representation:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Higher</span> <span class="n">Memory</span> <span class="n">Addresses</span>
    <span class="err">↑</span>
<span class="mh">0x2000</span>  <span class="err">├─────────────────────────┐</span>
        <span class="err">│</span>   <span class="n">STACK</span> <span class="n">BOTTOM</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span>  <span class="err">│</span>
<span class="mh">0x1900</span>  <span class="err">├─────────────────────────┤</span>
        <span class="err">│</span>   <span class="n">Function</span> <span class="n">A</span> <span class="n">Frame</span>      <span class="err">│</span>
<span class="mh">0x1800</span>  <span class="err">├─────────────────────────┤</span>
        <span class="err">│</span>   <span class="n">Function</span> <span class="n">B</span> <span class="n">Frame</span>      <span class="err">│</span>
<span class="mh">0x1700</span>  <span class="err">├─────────────────────────┤</span>
        <span class="err">│</span>   <span class="n">Return</span> <span class="n">address</span><span class="p">,</span> <span class="n">etc</span><span class="p">.</span>  <span class="err">│</span>
<span class="mh">0x1670</span>  <span class="err">├─────────────────────────┤</span>
        <span class="err">│</span> <span class="err">┌─</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span> <span class="err">─┐</span>  <span class="err">│</span>  
        <span class="err">│</span> <span class="err">│</span>  <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'o'</span>   <span class="err">│</span>  <span class="err">│</span>  <span class="err">←</span> <span class="mh">0x1654</span> <span class="p">(</span><span class="n">writes</span> <span class="n">toward</span> <span class="n">higher</span> <span class="n">addr</span><span class="p">)</span>
        <span class="err">│</span> <span class="err">│</span>  <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'l'</span>   <span class="err">│</span>  <span class="err">│</span>  <span class="err">←</span> <span class="mh">0x1653</span>
        <span class="err">│</span> <span class="err">│</span>  <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'l'</span>   <span class="err">│</span>  <span class="err">│</span>  <span class="err">←</span> <span class="mh">0x1652</span>  
        <span class="err">│</span> <span class="err">│</span>  <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'e'</span>   <span class="err">│</span>  <span class="err">│</span>  <span class="err">←</span> <span class="mh">0x1651</span>
        <span class="err">│</span> <span class="err">│</span>  <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'H'</span>   <span class="err">│</span>  <span class="err">│</span>  <span class="err">←</span> <span class="mh">0x1650</span> <span class="p">(</span><span class="n">buffer</span> <span class="n">base</span> <span class="n">address</span><span class="p">)</span>
        <span class="err">│</span> <span class="err">└────────────────────┘</span>  <span class="err">│</span>
<span class="mh">0x1600</span>  <span class="err">├─────────────────────────┤</span> <span class="err">←</span> <span class="n">STACK</span> <span class="n">TOP</span> <span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="err">│</span>   <span class="n">Available</span> <span class="n">Space</span>       <span class="err">│</span>
        <span class="err">└─────────────────────────┘</span>
    <span class="err">↓</span>
<span class="n">Lower</span> <span class="n">Memory</span> <span class="n">Addresses</span>
</code></pre></div></div>

<p>We can see that the stackframes are sequentially stacked starting at the stack bottom and going throw lower memroy address, also we can see that the values of the variables of one of that stackframes are stored going from lower memory address (H -&gt; 0x1650) to the higher memory address of the frame (o -&gt; 0x1654). Is worth to</p>

<p><br /></p>

<h4 id="13-endianess">1.3. Endianess.</h4>

<p>Until now, we have discussed in a simple way how one-byte data gets stored in the stack, we see that if we have a buffer of 4 chars, each char gets automatically identified by a memory address, but what happens with those values that are big enough to occupie more than one byte to be represented. Essentially, this data get stored along several bytes and the processor understand that set of bytes as one entity, one value, if you need to reach that value you need all bytes at once. Apparently, nothing change, data get stored in bytes and bytes are written upwards in memory address but the problem arises when we question how this sett of data gets writen.</p>

<p>In the previous example, we have a buffer of 4 chars (skipping string terminator byte) in which we have stored the string ‘Hello’, here, there is no question about how to write this string in memory since this string is nothing but an array of chars so the first chars goes in the lower memory address un this all along until the last char which goes in higher address. But when we face a 4 bytes value, like an integer, we can’t split the value as we did before or saying in other way, we can but no without answering one question; which bytes are the start and end of the value?</p>

<p>In the “Hello” string the answer is pretty clear because we know which char of the string is introduced first (is worth to mention that this have nothing to do with sintax or grammatically reasons, this is described in processor terms, and for the processor, there are 4 distintc values stored one after the other in 4 different bytes and all togheter conforms the string in human terms, the first of this values is the ‘H’ all along to the ‘o’, so there is no discussion), but what happens with the integer “0x12345678”, this integer gets split like this:</p>

<pre><code class="language-less">0x12345678 --&gt; [12] [34] [56] [78]
</code></pre>

<p>For the processor, this 4 bytes store one value and the processor have to reach every one of this bytes in order to access the integer, so the question is, how the processor access this bytes, or in other term, how do we store this bytes in order to make the processor to access them in a satisfactory way. Here is where the endianness take place.</p>

<p>The endianness is a term that referes how multi-bytes values take place in memory, specifically, it distinguish between which byte is the first byte to be stored and dependes in how the processor works:</p>

<ul>
  <li>
    <p><strong>Big Endian</strong> conserve what we could name as the traditional order, in the sense that, for big endian way, the first byte in order (in our case the more significant byte) is the first byte to be stored, then the rest are written upwards as usual:</p>

    <pre><code class="language-less">  0x1000  →   [12]
  0x1001  →   [34]
  0x1002  →   [56]
  0x1003  →   [78]
</code></pre>

    <p>Network traffic is sent in big endian. Also, registers store data in big endian.</p>
  </li>
  <li>
    <p><strong>Little Endian</strong>, in the other hand, reverts traditional order; it assumes that the last byte in traditional order (in our case the less significant byte) is the first byte to be stored, then the rest are written upwards as usual:</p>

    <pre><code class="language-less">  0x1000  →   [78]
  0x1001  →   [56]
  0x1002  →   [34]
  0x1003  →   [12] 
</code></pre>
  </li>
</ul>

<p>Most of the processor works in little endian, so little endian or the “reverse order” is by default the most general way to store information in memory. An example of little endian would be Intel processors
<br /></p>

<h3 id="2-buffer-overflow-explained">2. Buffer Overflow explained.</h3>

<p>So, as we said before, buffer overflow is pretty simple, it consist when a living-in-the-stack buffer (watch out that it <strong>only applies to buffers</strong>, not for example integers or any other kind of variables) gets written out of bounds and starts overwritting other parts of the stack. Normally, the point of the most of the attacks that triggers buffer overflows in the stack is to reach the * * of the stackframe in order to gain control over the execution flow of the program.</p>

<p>This can happen mainly in two forms:</p>

<ul>
  <li>Unsafe/weakly-bounded functions like memcpy(), strcpy(), strcat(), sprintf(), etc and the equivalent wrapper functions.</li>
  <li>Sequential data writes within a loop with an attacker controlled <em>counter/exit condition</em></li>
</ul>

<p>Let’s see a trivial example:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="c1">//Local variable --&gt; living-in-the-stack buffer.</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="c1">//Unbounded function copy attacked-controlled-input-data to the local variable.</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"We got an input string: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h3 id="3-exercises">3. Exercises.</h3>

<h4 id="31-userspace-vulnerabilities">3.1. Userspace Vulnerabilities.</h4>

<h5 id="311-server-side">3.1.1. Server side.</h5>

<h6 id="3111-cve-2021-20294">3.1.1.1. CVE-2021-20294.</h6>

<p><em>Readelf</em> is a command line utility for parsing Executable and Linkable Format (ELF) binaries, which is the standard format of binary in Unix systems. It is usually invoked manually on binaries, for debugging or analyzing purpouses.</p>

<p>Look at the following code, and see if you can identify the vulnerability.</p>

<p>(Note: you can double click on variables to highlight where they are used. You can also type notes to yourself in the editor, but they won’t be saved.)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">////ACID: filedata, symtab, section, strtab, strtab_size</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">print_dynamic_symbol</span> <span class="p">(</span><span class="n">Filedata</span> <span class="o">*</span><span class="n">filedata</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">si</span><span class="p">,</span> <span class="n">Elf_Internal_Sym</span> <span class="o">*</span><span class="n">symtab</span><span class="p">,</span> <span class="n">Elf_Internal_Shdr</span> <span class="o">*</span><span class="n">section</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strtab</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">strtab_size</span><span class="p">){</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version_string</span><span class="p">;</span>
  <span class="k">enum</span> <span class="n">versioned_symbol_info</span> <span class="n">sym_info</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vna_other</span><span class="p">;</span>
  <span class="n">Elf_Internal_Sym</span> <span class="o">*</span><span class="n">psym</span> <span class="o">=</span> <span class="n">symtab</span> <span class="o">+</span> <span class="n">si</span><span class="p">;</span>
  
  <span class="n">printf</span> <span class="p">(</span><span class="s">"%6ld: "</span><span class="p">,</span> <span class="n">si</span><span class="p">);</span>
  <span class="n">print_vma</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">,</span> <span class="n">LONG_HEX</span><span class="p">);</span>
  <span class="n">putchar</span> <span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
  <span class="n">print_vma</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="n">DEC_5</span><span class="p">);</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">" %-7s"</span><span class="p">,</span> <span class="n">get_symbol_type</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">ELF_ST_TYPE</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)));</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">" %-6s"</span><span class="p">,</span> <span class="n">get_symbol_binding</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">ELF_ST_BIND</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">filedata</span><span class="o">-&gt;</span><span class="n">file_header</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_OSABI</span><span class="p">]</span> <span class="o">==</span> <span class="n">ELFOSABI_SOLARIS</span><span class="p">)</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">" %-7s"</span><span class="p">,</span>  <span class="n">get_solaris_symbol_visibility</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vis</span> <span class="o">=</span> <span class="n">ELF_ST_VISIBILITY</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span><span class="p">);</span>

      <span class="n">printf</span> <span class="p">(</span><span class="s">" %-7s"</span><span class="p">,</span> <span class="n">get_symbol_visibility</span> <span class="p">(</span><span class="n">vis</span><span class="p">));</span>
      <span class="cm">/* Check to see if any other bits in the st_other field are set.
   Note - displaying this information disrupts the layout of the
   table being generated, but for the moment this case is very rare.  */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span> <span class="o">^</span> <span class="n">vis</span><span class="p">)</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">" [%s] "</span><span class="p">,</span> <span class="n">get_symbol_other</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span> <span class="o">^</span> <span class="n">vis</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">" %4s "</span><span class="p">,</span> <span class="n">get_symbol_index_type</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_shndx</span><span class="p">));</span>

  <span class="n">bfd_boolean</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">VALID_SYMBOL_NAME</span> <span class="p">(</span><span class="n">strtab</span><span class="p">,</span> <span class="n">strtab_size</span><span class="p">,</span>
              <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_name</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sstr</span> <span class="o">=</span> <span class="n">is_valid</span>  <span class="o">?</span> <span class="n">strtab</span> <span class="o">+</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_name</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>

  <span class="n">version_string</span>
    <span class="o">=</span> <span class="n">get_symbol_version_string</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span>
         <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="nb">NULL</span>
          <span class="o">||</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_DYNSYM</span><span class="p">),</span>
         <span class="n">strtab</span><span class="p">,</span> <span class="n">strtab_size</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span>
         <span class="n">psym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sym_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vna_other</span><span class="p">);</span> <span class="c1">//XENO: Lots of ACID in will yield ACID out</span>
  
  <span class="kt">int</span> <span class="n">len_avail</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">do_wide</span> <span class="o">&amp;&amp;</span> <span class="n">version_string</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="c1">//XENO: do_wide is true iff -W option passed</span>
    <span class="p">{</span>
      <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

      <span class="n">len_avail</span> <span class="o">-=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"@%s"</span><span class="p">,</span> <span class="n">version_string</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">sym_info</span> <span class="o">==</span> <span class="n">symbol_undefined</span><span class="p">)</span>
  <span class="n">len_avail</span> <span class="o">-=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">" (%d)"</span><span class="p">,</span> <span class="n">vna_other</span><span class="p">);</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sym_info</span> <span class="o">!=</span> <span class="n">symbol_hidden</span><span class="p">)</span>
  <span class="n">len_avail</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">print_symbol</span> <span class="p">(</span><span class="n">len_avail</span><span class="p">,</span> <span class="n">sstr</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>From the comments of the code above, we can deduce that the parameters: filedata, symtab, section, strtab, strtab_size are attacker controlled, so it would be worth where this parameters take place in the code:</p>

<p><strong>Filedata</strong></p>

<p>Let’s start tracking the file data parameter.</p>

<ul>
  <li>The first thing we want to say is that <em>filedata</em> is a Filedata type instance (custom instance) which is pass to the function as an argument.</li>
  <li>
    <p>Some sort of data is extracted and printed out to STDOUT, nothing valuable:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">printf</span><span class="p">(</span><span class="s">" %-7s"</span><span class="p">,</span> <span class="n">get_symbol_type</span><span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">ELF_ST_TYPE</span><span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)));</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">" %-6s"</span><span class="p">,</span> <span class="n">get_symbol_binding</span><span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">ELF_ST_BIND</span><span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)));</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Some header from filedata gets compared:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">if</span><span class="p">(</span><span class="n">filedata</span><span class="o">-&gt;</span><span class="n">file_header</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_OSABI</span><span class="p">]</span> <span class="o">==</span> <span class="n">ELFOSABI_SOLARIS</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>More data gets printed from the file:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">printf</span> <span class="p">(</span><span class="s">" [%s] "</span><span class="p">,</span> <span class="n">get_symbol_other</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span> <span class="o">^</span> <span class="n">vis</span><span class="p">));</span>
  <span class="n">printf</span> <span class="p">(</span><span class="s">" %4s "</span><span class="p">,</span> <span class="n">get_symbol_index_type</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_shndx</span><span class="p">));</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Finally, filedata is used to stuff a variable:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">version_string</span> <span class="o">=</span> <span class="n">get_symbol_version_string</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_DYNSYM</span><span class="p">),</span> <span class="n">strtab</span><span class="p">,</span> <span class="n">strtab_size</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">psym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sym_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vna_other</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>This essentially converts <em>version_string</em> in attacker-controlled-input-data, so let’s track version_string.</p>
  </li>
</ul>

<p><br /></p>

<p><strong>filedata –&gt; version_string</strong></p>

<ul>
  <li>
    <p>First, version_string is a pointer to constant char, a buffer to hold a string in the heap:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version_string</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then some data, probably a string from the filedata, gets store in there as we see before:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">version_string</span> <span class="o">=</span> <span class="n">get_symbol_version_string</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="p">(</span><span class="n">section</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">section</span><span class="o">-&gt;</span><span class="n">sh_type</span> <span class="o">==</span> <span class="n">SHT_DYNSYM</span><span class="p">),</span> <span class="n">strtab</span><span class="p">,</span> <span class="n">strtab_size</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">psym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sym_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vna_other</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Then, sprintf(), which is a weakly-bounded function, copy the contents from the attack-controlled ‘version_string’ to a local buffer:</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">len_avail</span> <span class="o">-=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"@%s"</span><span class="p">,</span> <span class="n">version_string</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
</ul>

<p><br /></p>

<p><strong>symtab</strong></p>

<p>First, symtab is passed to the function as an argument, is a pointer to ‘Elf_Internal_Sym’ data and then infect a pointer within our function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Elf_Internal_Sym</span> <span class="o">*</span><span class="n">psym</span> <span class="o">=</span> <span class="n">symtab</span> <span class="o">+</span> <span class="n">si</span><span class="p">;</span>
</code></pre></div></div>

<p>It not appears again in the funtion.</p>

<p><br /></p>

<p><strong>symtab –&gt; psym</strong></p>

<p>Some values are printed out from psym:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">print_vma</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_value</span><span class="p">,</span> <span class="n">LONG_HEX</span><span class="p">);</span>
<span class="n">putchar</span> <span class="p">(</span><span class="sc">' '</span><span class="p">);</span>
<span class="n">print_vma</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_size</span><span class="p">,</span> <span class="n">DEC_5</span><span class="p">);</span>
<span class="n">printf</span> <span class="p">(</span><span class="s">" %-7s"</span><span class="p">,</span> <span class="n">get_symbol_type</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">ELF_ST_TYPE</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)));</span>
<span class="n">printf</span> <span class="p">(</span><span class="s">" %-6s"</span><span class="p">,</span> <span class="n">get_symbol_binding</span> <span class="p">(</span><span class="n">filedata</span><span class="p">,</span> <span class="n">ELF_ST_BIND</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_info</span><span class="p">)));</span>
<span class="k">if</span> <span class="p">(</span><span class="n">filedata</span><span class="o">-&gt;</span><span class="n">file_header</span><span class="p">.</span><span class="n">e_ident</span><span class="p">[</span><span class="n">EI_OSABI</span><span class="p">]</span> <span class="o">==</span> <span class="n">ELFOSABI_SOLARIS</span><span class="p">)</span>
    <span class="n">printf</span> <span class="p">(</span><span class="s">" %-7s"</span><span class="p">,</span>  <span class="n">get_solaris_symbol_visibility</span> <span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span><span class="p">));</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Then, some value <em>unsigned int vis</em> is stuffed with pysm:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vis</span> <span class="o">=</span> <span class="n">ELF_ST_VISIBILITY</span><span class="p">(</span><span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_other</span><span class="p">);</span>
</code></pre></div></div>

<p>This is not vulnerable to linear stack buffer overflow since <em>vis</em>, despite is a local variable and is living in the stack, is not a buffer, is an integer and an attempt to overflow it would lead to a truncation since arithmetic modular C behaviour.</p>

<p>Further more, ELF_ST_VISBILITY() is a macro defined as follows:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ELF_ST_VISIBILITY(o)  ((o) &amp; 0x3)
</span></code></pre></div></div>

<p>This means, that, despite what value ‘o’ represents, the macro only gets the bytes resulting of applying to ‘o’ the 0x3 mask what makes the buffer overflow impossible.</p>

<p><br /></p>

<p><strong>Section</strong></p>

<p>Section is again a value passed to the function through argument and is a pointer to Elf_Internal_Shdr. In the code it is not used too much, only in the well known version_string variable.</p>

<p><br /></p>

<p><strong>Strtab</strong></p>

<p>Strtab is a string pass as an argument to the function and is used mainly in two lines in the code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bfd_boolean</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">VALID_SYMBOL_NAME</span><span class="p">(</span><span class="n">strtab</span><span class="p">,</span> <span class="n">strtab_size</span><span class="p">,</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_name</span><span class="p">);</span>
</code></pre></div></div>

<p>This is a boolean value which means is not a buffer so it not applies. For a complete job, we would have to look exactly how bfd_boolean datatype is defined (since C does not define booleans by default) but here we will assume is just not a buffer.</p>

<p>The other line is:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">sstr</span> <span class="o">=</span> <span class="n">is_valid</span>  <span class="o">?</span> <span class="n">strtab</span> <span class="o">+</span> <span class="n">psym</span><span class="o">-&gt;</span><span class="n">st_name</span> <span class="o">:</span> <span class="n">_</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
</code></pre></div></div>

<p>This lines defines a pointer to constant char, and in one hand it tries to stuffed with strtab value. But again, as integers, pointers are also fixed-size scalar type (8bytes in x64 architectures) so whatever the size of the data you want to enter, the pointer will only gets the eight rightmost bytes.</p>

<p>The last lines is the one of the version_string variable.</p>

<p><br /></p>

<p><strong>strtab_size</strong></p>

<p>This parameter also gets into the function as a parameter and take place in two lines, in the boolean varaible and the version_string so in any case this can lead to stack buffer overflow.</p>

<p><br /></p>

<p><strong>How to mitigate it</strong></p>

<p>In order to mitigate this vulnerability, we have to check the length of the version_string variable before using to fill any buffer. This check can be before call snprintf or while call in it.</p>

<p><br /></p>

<h6 id="3112-cve-2021-43579">3.1.1.2. CVE-2021-43579.</h6>

<p>This vulnerability exists in a document rendering program. HTMLDOC is a program that reads HTML and Markdown and generates corresponding EPUB, HTML, PostScript or PDF file.</p>

<p>This program <em>parses</em> html or markdown files and <em>converts</em> it to other file types, we know that parse is within our list of actions that can be dangerous.</p>

<p>In this case, all that is read from <em>fp</em> is attack controlled.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">////ACID: everything read from fp</span>
<span class="k">static</span> <span class="kt">int</span>                       <span class="cm">/* O - 0 = success, -1 = fail */</span>
<span class="n">image_load_bmp</span><span class="p">(</span><span class="n">image_t</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span>     <span class="cm">/* I - Image to load into */</span>
               <span class="kt">FILE</span>    <span class="o">*</span><span class="n">fp</span><span class="p">,</span>      <span class="cm">/* I - File to read from */</span>
               <span class="kt">int</span>     <span class="n">gray</span><span class="p">,</span>     <span class="cm">/* I - Grayscale image? */</span>
               <span class="kt">int</span>     <span class="n">load_data</span><span class="p">)</span><span class="cm">/* I - 1 = load image data, 0 = just info */</span>
<span class="p">{</span>
  <span class="kt">int</span>   <span class="n">info_size</span><span class="p">,</span>	<span class="cm">/* Size of info header */</span>
        <span class="n">depth</span><span class="p">,</span>		<span class="cm">/* Depth of image (bits) */</span>
        <span class="n">compression</span><span class="p">,</span>	<span class="cm">/* Type of compression */</span>
        <span class="n">colors_used</span><span class="p">,</span>	<span class="cm">/* Number of colors used */</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>		<span class="cm">/* Looping vars */</span>
        <span class="n">color</span><span class="p">,</span>		<span class="cm">/* Color of RLE pixel */</span>
        <span class="n">count</span><span class="p">,</span>		<span class="cm">/* Number of times to repeat */</span>
        <span class="n">temp</span><span class="p">,</span>		<span class="cm">/* Temporary color */</span>
        <span class="n">align</span><span class="p">;</span>		<span class="cm">/* Alignment bytes */</span>
        <span class="n">uchar</span> <span class="n">bit</span><span class="p">,</span>	<span class="cm">/* Bit in image */</span>
        <span class="n">byte</span><span class="p">;</span>		<span class="cm">/* Byte in image */</span>
        <span class="n">uchar</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>	<span class="cm">/* Pointer into pixels */</span>
        <span class="n">uchar</span>		<span class="n">colormap</span><span class="p">[</span><span class="mi">256</span><span class="p">][</span><span class="mi">4</span><span class="p">];</span><span class="cm">/* Colormap */</span>


  <span class="c1">// Get the header...</span>
  <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>			<span class="cm">/* Skip "BM" sync chars */</span>
  <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>		<span class="cm">/* Skip size */</span>
  <span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>		<span class="cm">/* Skip reserved stuff */</span>
  <span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

  <span class="c1">// Then the bitmap information...</span>
  <span class="n">info_size</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span>       <span class="o">=</span> <span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span>      <span class="o">=</span> <span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">depth</span>            <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">compression</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">colors_used</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
  <span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">8192</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">info_size</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">info_size</span> <span class="o">-=</span> <span class="mi">40</span><span class="p">;</span> <span class="n">info_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">info_size</span> <span class="o">--</span><span class="p">)</span>
      <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

  <span class="c1">// Get colormap...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">colors_used</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">colors_used</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">depth</span><span class="p">;</span>

  <span class="n">fread</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">colors_used</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>

  <span class="c1">// Setup image and buffers...</span>
  <span class="n">img</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">gray</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>

  <span class="c1">// If this image is indexed and we are writing an encrypted PDF file, bump the use count so</span>
  <span class="c1">// we create an image object (Acrobat 6 bug workaround)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">Encryption</span><span class="p">)</span>
    <span class="n">img</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">++</span><span class="p">;</span>

  <span class="c1">// Return now if we only need the dimensions...</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">img</span><span class="o">-&gt;</span><span class="n">pixels</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">pixels</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">gray</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Convert colormap to grayscale...</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">colors_used</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">color</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">color</span> <span class="o">--</span><span class="p">)</span>
      <span class="n">colormap</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">colormap</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">31</span> <span class="o">+</span>
                            <span class="n">colormap</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">61</span> <span class="o">+</span>
                            <span class="n">colormap</span><span class="p">[</span><span class="n">color</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Read the image data...</span>
  <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">byte</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">temp</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">--</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">pixels</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">case</span> <span class="mi">1</span> <span class="p">:</span> <span class="cm">/* Bitmap */</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span><span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gray</span><span class="p">)</span>
        <span class="p">{</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
              <span class="p">}</span>

        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gray</span><span class="p">)</span>
        <span class="p">{</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
    <span class="p">}</span>

         <span class="cm">/*
    * Read remaining bytes to align to 32 bits...
    */</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">temp</span> <span class="o">++</span><span class="p">)</span>
      <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="mi">4</span> <span class="p">:</span> <span class="cm">/* 16-color */</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">bit</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * Get a new count as needed...
      */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">compression</span> <span class="o">!=</span> <span class="n">BI_RLE4</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">align</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">align</span> <span class="o">--</span><span class="p">;</span>
    <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
              <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * End of line...
      */</span>

                  <span class="n">x</span> <span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * End of image...
      */</span>

      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * Delta...
      */</span>

      <span class="n">count</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
      <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
     <span class="cm">/*
      * Absolute...
      */</span>

      <span class="n">color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">align</span> <span class="o">=</span> <span class="p">((</span><span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
          <span class="n">color</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
            <span class="p">}</span>

           <span class="cm">/*
      * Get a new color as needed...
      */</span>

      <span class="n">count</span> <span class="o">--</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span>
      <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span>
        <span class="k">else</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>

             <span class="cm">/*
        * Copy the color value...
        */</span>

              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gray</span><span class="p">)</span>
        <span class="p">{</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
              <span class="p">}</span>

        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">bit</span>    <span class="o">=</span> <span class="mh">0x0f</span><span class="p">;</span>
            <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
             <span class="cm">/*
        * Copy the color value...
        */</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gray</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
          <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">bit</span>    <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="mi">8</span> <span class="p">:</span> <span class="cm">/* 256-color */</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * Get a new count as needed...
      */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">compression</span> <span class="o">!=</span> <span class="n">BI_RLE8</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">align</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">align</span> <span class="o">--</span><span class="p">;</span>
    <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
              <span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * End of line...
      */</span>

                  <span class="n">x</span> <span class="o">++</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * End of image...
      */</span>

      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="cm">/*
      * Delta...
      */</span>

      <span class="n">count</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
      <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
     <span class="cm">/*
      * Absolute...
      */</span>

      <span class="n">color</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
          <span class="n">color</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
            <span class="p">}</span>

           <span class="cm">/*
      * Get a new color as needed...
      */</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>

            <span class="n">count</span> <span class="o">--</span><span class="p">;</span>

           <span class="cm">/*
      * Copy the color value...
      */</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gray</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">colormap</span><span class="p">[</span><span class="n">temp</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="mi">24</span> <span class="p">:</span> <span class="cm">/* 24-bit RGB */</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">gray</span><span class="p">)</span>
    <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">--</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
        <span class="n">temp</span> <span class="o">+=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">61</span><span class="p">;</span>
        <span class="n">temp</span> <span class="o">+=</span> <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">*</span> <span class="mi">31</span><span class="p">;</span>
        <span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)(</span><span class="n">temp</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">--</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span><span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
        <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span><span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
        <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span><span class="p">)</span><span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
      <span class="p">}</span>
          <span class="p">}</span>

         <span class="cm">/*
    * Read remaining bytes to align to 32 bits...
    */</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">temp</span> <span class="o">=</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">temp</span> <span class="o">++</span><span class="p">)</span>
      <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So, we gonna proceed as we did in our previous exercise and lets check the <em>fp</em> parameter and all the things stuffed with it.</p>

<p><br /></p>

<p><strong>fp</strong></p>

<p>fp is a pointer to a FILE object which is passed as to the function as an argument.</p>

<p>At first, some data is read from the fp parameter:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>			<span class="cm">/* Skip "BM" sync chars */</span>
<span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>		<span class="cm">/* Skip size */</span>
<span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>		<span class="cm">/* Skip reserved stuff */</span>
<span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>Unless this functions store data in a buffer by their own, is not in our interest so we go on.</p>

<p>(This calls are made to discard useless bytes or parts of the file. C compiler treat a file as a stream of bytes, and the system maintains a file position indicator (or “file pointer position”) that tracks where you are in the file. Whenever you read, by default you start reading from this fileposition pointer which also advances every time bytes are read. So when calling this functions we are making this file position pointer advanced in order to reach the part with interesting data.)</p>

<p>Then, a few variables are filled with <em>fp</em> value:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">info_size</span>        <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span>       <span class="o">=</span> <span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span>      <span class="o">=</span> <span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>Then skip word:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>Define a new variable:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">depth</span>            <span class="o">=</span> <span class="n">read_word</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">compression</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>Skip more bytes:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="n">read_long</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>And then define a new variable:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colors_used</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>At a first glance; <em>info_size, img-&gt;width, img-&gt;height, depth, compression, colors_used</em> can’t be used in a stack linear buffer overflow, because the functions used to stuff this variables are size-fixed only read a few bytes of fp and nothing more, so overflow is impossible.</p>

<p>How ever, we don’t know if any of this values can be used in other interactions like in a for loop statement, so we continue checking the code.</p>

<p>Then, we have several checks:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">8192</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">img</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">info_size</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">info_size</span> <span class="o">-=</span> <span class="mi">40</span><span class="p">;</span> <span class="n">info_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">info_size</span> <span class="o">--</span><span class="p">)</span>
    <span class="n">getc</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>First of all, it checks that some values are within certain marginis, [0, 8192), then it reads from <em>fp</em>, in order to skip the info part of the file if this one is bigger than 40.</p>

<p>Then, we get the colormap, at first we read it from the header, but it could be 0, if that the case, we fixed by setting the colorsused to 2^depth, then we store the colors_used value into the colormap array:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">colors_used</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">depth</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">colors_used</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">depth</span><span class="p">;</span>

<span class="n">fread</span><span class="p">(</span><span class="n">colormap</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">colors_used</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>Is worth to mention that this fread() function is introducing into our stack-living buffer an attacker-controlled variable, so if this function weak-bounded it could lead to a linear stack buffer overflow by introducing for example a negative <em>colors_used</em> value.</p>

<p>For that we, check the description of the function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">size_t</span> <span class="nf">fread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">);</span>
</code></pre></div></div>

<p>The function fread() reads n items of data, each size bytes long, from the stream pointed to by stream, storing them at the location given by ptr.</p>

<p>So the definition does not talk about any limit or restriction about the storage and is presumibly weak-bounded. More specific, we can see that <em>fread()</em> is reading 4 items of <em>color_used</em> size, color_used is a signed int:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">colors_used</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">read_dword</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</code></pre></div></div>

<p>So, is <em>fread()</em> is reading 4 items of a size that is user’s controlled, thus we could specify a size that meets the following criteria:</p>

<pre><code class="language-less">size * 4 &gt; 256 * 4
</code></pre>

<p>Since the buffer is of uchar datatype (one byte per slot).</p>

<p><br /></p>

<h5 id="312-desktop-side">3.1.2 Desktop side.</h5>

<h6 id="3211-cve-2020-10005">3.2.1.1. CVE-2020-10005.</h6>

<p>Microsoft Server Message Block (SMB) Protocol is a network file sharing protocol. Apple’s macOS implements SMB server and client code. The SMB2 TREE_CONNECT Request packet is sent by a client to request access to a particular share on the server. This request packet is composed by the several parts:</p>

<ul>
  <li>StructureSize - 16 bytes</li>
  <li>Flags/Reserved - 16 bytes</li>
  <li>PathOffset - 16 bytes</li>
  <li>PathLength - 16 bytes</li>
  <li>Buffer - 32 bytes or more</li>
</ul>

<p>This data is stored in the <em>tree_connect_request</em> structure.</p>

<p>Let’s check the code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">undefined8</span>
<span class="n">smb2</span><span class="o">::</span><span class="n">extract</span><span class="p">(</span><span class="n">uchar</span> <span class="o">**</span><span class="n">pkt_ptr_ptr</span><span class="p">,</span><span class="n">uchar</span> <span class="o">**</span><span class="n">packet_size_hdr_ptr_ptr</span><span class="p">,</span><span class="n">tree_connect_request</span> <span class="o">*</span><span class="n">memcpy_src</span><span class="p">,</span>
             <span class="n">uchar</span> <span class="o">**</span><span class="n">smb_hdr_ptr_ptr</span><span class="p">)</span>

<span class="p">{</span>
  <span class="kt">short</span> <span class="o">*</span><span class="n">psVar1</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
  <span class="kt">short</span> <span class="o">*</span><span class="n">packetEnd</span><span class="p">;</span>
  <span class="n">ushort</span> <span class="n">tc_PathLength</span><span class="p">;</span>
  <span class="n">ushort</span> <span class="n">tc_PathOffset</span><span class="p">;</span>
  <span class="kt">short</span> <span class="n">tc_StructureSize</span><span class="p">;</span>
  
  <span class="n">psVar1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">pkt_ptr_ptr</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">packet_size_hdr_ptr_ptr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">psVar1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tc_StructureSize</span> <span class="o">=</span> <span class="o">*</span><span class="n">psVar1</span><span class="p">;</span>
    <span class="o">*</span><span class="n">pkt_ptr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)(</span><span class="n">psVar1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">memcpy_src</span><span class="o">-&gt;</span><span class="n">short_1_StructureSize</span> <span class="o">=</span> <span class="n">tc_StructureSize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">tc_StructureSize</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">pkt_ptr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)(</span><span class="n">psVar1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
      <span class="n">memcpy_src</span><span class="o">-&gt;</span><span class="n">short_2_Flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">tc_PathOffset</span> <span class="o">=</span> <span class="n">psVar1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="o">*</span><span class="n">pkt_ptr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)(</span><span class="n">psVar1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">memcpy_src</span><span class="o">-&gt;</span><span class="n">short_3_PathOffset</span> <span class="o">=</span> <span class="n">tc_PathOffset</span><span class="p">;</span>
      <span class="n">tc_PathLength</span> <span class="o">=</span> <span class="n">psVar1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
      <span class="o">*</span><span class="n">pkt_ptr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)(</span><span class="n">psVar1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
      <span class="n">memcpy_src</span><span class="o">-&gt;</span><span class="n">short_4_PathLength</span> <span class="o">=</span> <span class="n">tc_PathLength</span><span class="p">;</span>
      <span class="n">packetEnd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">smb_hdr_ptr_ptr</span> <span class="o">+</span> <span class="n">tc_PathOffset</span> <span class="o">+</span>
                           <span class="p">((</span><span class="n">uint</span><span class="p">)(</span><span class="o">*</span><span class="n">smb_hdr_ptr_ptr</span> <span class="o">+</span> <span class="n">tc_PathOffset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
      <span class="o">*</span><span class="n">pkt_ptr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">packetEnd</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="n">psVar1</span> <span class="o">&lt;=</span> <span class="n">packetEnd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">psVar1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">packet_size_hdr_ptr_ptr</span><span class="p">,</span> <span class="n">packetEnd</span> <span class="o">&lt;=</span> <span class="n">psVar1</span><span class="p">)</span>
         <span class="p">)</span> <span class="p">{</span>
        <span class="n">packetEnd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">packetEnd</span> <span class="o">+</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">tc_PathLength</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">psVar1</span> <span class="o">&lt;=</span> <span class="n">packetEnd</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">packetEnd</span> <span class="o">=</span> <span class="n">psVar1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">uVar2</span> <span class="o">=</span> <span class="n">smb</span><span class="o">::</span><span class="n">extract_utf16_string</span>
                          <span class="p">(</span><span class="n">pkt_ptr_ptr</span><span class="p">,(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">packetEnd</span><span class="p">,(</span><span class="n">oem_string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">memcpy_src</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">uVar2</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">////ACID: in_packet_ptr, in_packet_size</span>
<span class="n">ulong</span> <span class="nf">smb2_dispatch_tree_connect</span><span class="p">(</span><span class="n">smb_request</span> <span class="o">*</span><span class="n">param_1</span><span class="p">,</span> <span class="n">uchar</span> <span class="o">*</span><span class="n">in_packet_ptr</span><span class="p">,</span> <span class="n">uchar</span> <span class="o">*</span><span class="n">in_packet_size</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">piVar1</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">**</span><span class="n">this</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">lVar2</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">cVar4</span><span class="p">;</span>
  <span class="n">ulong</span> <span class="n">num_chars</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar6</span><span class="p">;</span>
  <span class="n">ulong</span> <span class="n">uVar7</span><span class="p">;</span>
  <span class="n">byte</span> <span class="n">bVar8</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">lVar9</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">bitmasked_num_chars</span><span class="p">;</span>
  <span class="n">uchar</span> <span class="o">*</span><span class="n">local_8b8</span><span class="p">;</span>
  <span class="n">uchar</span> <span class="o">*</span><span class="n">local_8b0</span><span class="p">;</span>
  <span class="n">uchar</span> <span class="o">*</span><span class="n">packet_input_ptr</span><span class="p">;</span>
  <span class="n">uchar</span> <span class="o">*</span><span class="n">packet_size</span><span class="p">;</span>
  <span class="n">unknown_struct_1</span> <span class="n">local_898</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">uStack2188</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">local_87c</span><span class="p">;</span>
  <span class="n">undefined4</span> <span class="n">local_878</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">uStack2164</span><span class="p">;</span>
  <span class="n">undefined2</span> <span class="n">local_870</span><span class="p">;</span>
  <span class="n">undefined2</span> <span class="n">local_86e</span><span class="p">;</span>
  <span class="n">undefined2</span> <span class="n">uStack2156</span><span class="p">;</span>
  <span class="n">uint</span> <span class="n">local_86a</span><span class="p">;</span>
  <span class="n">wchar16</span> <span class="n">wcSharePath</span> <span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
  <span class="n">tree_connect_request</span> <span class="n">memcpy_src</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">local_48</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">local_38</span><span class="p">;</span>
  <span class="kt">long</span> <span class="n">lVar3</span><span class="p">;</span>
  <span class="n">uchar</span> <span class="o">*</span><span class="n">puVar2</span><span class="p">;</span>
  
  <span class="n">local_38</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">__got</span><span class="o">::</span><span class="n">___stack_chk_guard</span><span class="p">;</span>
  <span class="n">memcpy_src</span> <span class="o">=</span> <span class="n">ZEXT816</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">local_48</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_87c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_local_898</span> <span class="o">=</span> <span class="n">ZEXT816</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">packet_input_ptr</span> <span class="o">=</span> <span class="n">in_packet_ptr</span><span class="p">;</span>
  <span class="n">packet_size</span> <span class="o">=</span> <span class="n">in_packet_size</span><span class="p">;</span>
  <span class="n">__stubs</span><span class="o">::</span><span class="n">___bzero</span><span class="p">(</span><span class="n">wcSharePath</span><span class="p">,</span><span class="mh">0x800</span><span class="p">);</span>
  <span class="n">cVar4</span> <span class="o">=</span> <span class="n">smb2</span><span class="o">::</span><span class="n">extract</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet_input_ptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">packet_size</span><span class="p">,</span><span class="o">&amp;</span><span class="n">memcpy_src</span><span class="p">,(</span><span class="n">uchar</span> <span class="o">**</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="mi">9</span><span class="p">));</span>
  <span class="n">num_chars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cVar4</span> <span class="o">==</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
  <span class="n">local_898</span> <span class="o">=</span> <span class="n">CONCAT48</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">local_48</span><span class="p">,</span><span class="n">local_898</span><span class="p">.</span><span class="mi">0</span><span class="n">_8_buf_ptr</span><span class="p">);</span>
  <span class="n">_local_898</span> <span class="o">=</span> <span class="n">CONCAT88</span><span class="p">(</span><span class="n">stack0xfffffffffffff770</span><span class="p">,</span><span class="n">memcpy_src</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">memcpy_src</span><span class="p">.</span><span class="n">buf</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">fail2:</span>
    <span class="n">uVar6</span> <span class="o">=</span> <span class="n">platform</span><span class="o">::</span><span class="n">log</span><span class="o">::</span><span class="n">smbx_std_log</span><span class="p">();</span>
    <span class="n">cVar4</span> <span class="o">=</span> <span class="n">__stubs</span><span class="o">::</span><span class="n">_os_log_type_enabled</span><span class="p">(</span><span class="n">uVar6</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cVar4</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">local_878</span> <span class="o">=</span> <span class="mh">0x8200102</span><span class="p">;</span>
      <span class="n">uStack2164</span> <span class="o">=</span> <span class="mh">0x8f914</span><span class="p">;</span>
      <span class="n">local_870</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">local_86e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">__stubs</span><span class="o">::</span><span class="n">__os_log_impl</span><span class="p">(</span><span class="mh">0x100000000</span><span class="p">,</span><span class="n">uVar6</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="s">"%s: bad path for tree connect"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_878</span><span class="p">,</span><span class="mh">0xc</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">bitmasked_num_chars</span> <span class="o">=</span> <span class="mh">0xc00000be</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">bitmasked_num_chars</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_48</span> <span class="o">&amp;</span> <span class="mh">0x3fffffff</span><span class="p">;</span>
    <span class="n">num_chars</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">bitmasked_num_chars</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">local_898</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">undefined</span>  <span class="p">[</span><span class="mi">12</span><span class="p">])</span><span class="mh">0x3fffffff</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">undefined</span>  <span class="p">[</span><span class="mi">12</span><span class="p">])</span><span class="mh">0x0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">uint</span><span class="p">)</span><span class="n">local_48</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">memcpy_src</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">num_chars</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">memcpy_path</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">num_chars</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy_src</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
<span class="nl">memcpy_path:</span>
        <span class="n">__stubs</span><span class="o">::</span><span class="n">_memcpy</span><span class="p">(</span><span class="n">wcSharePath</span><span class="p">,</span><span class="n">memcpy_src</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span><span class="n">num_chars</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">wcSharePath</span><span class="p">[</span><span class="n">num_chars</span><span class="p">]</span> <span class="o">=</span> <span class="sc">L'\0'</span><span class="p">;</span>
        <span class="n">local_898</span> <span class="o">=</span> <span class="n">CONCAT48</span><span class="p">(</span><span class="n">bitmasked_num_chars</span> <span class="o">+</span> <span class="mh">0x80000000</span><span class="p">,</span><span class="n">wcSharePath</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">bitmasked_num_chars</span> <span class="o">=</span> <span class="n">connect_to_named_tree</span><span class="p">(</span><span class="n">param_1</span><span class="p">,(</span><span class="n">oem_string</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">local_898</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local_87c</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">bitmasked_num_chars</span> <span class="o">&lt;</span> <span class="mh">0x40000000</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="err">¶</span><span class="n">m_1</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">PathOffset</span> <span class="o">=</span> <span class="n">local_87c</span><span class="p">;</span>
        <span class="n">smb_session</span><span class="o">::</span><span class="n">find_tree</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">register0x00000020</span> <span class="o">+</span> <span class="o">-</span><span class="mh">0x878</span><span class="p">);</span>
        <span class="n">lVar2</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
        <span class="n">lVar3</span> <span class="o">=</span> <span class="n">CONCAT44</span><span class="p">(</span><span class="n">uStack2164</span><span class="p">,</span><span class="n">local_878</span><span class="p">);</span>
        <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)(</span><span class="n">param_1</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="n">lVar3</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lVar3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">LOCK</span><span class="p">();</span>
          <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">lVar3</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">lVar3</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">///...</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We see that in the function a memcpy() operation is performed with the buffer of the tree_connect_request structure:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__stubs</span><span class="o">::</span><span class="n">_memcpy</span><span class="p">(</span><span class="n">wcSharePath</span><span class="p">,</span><span class="n">memcpy_src</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span><span class="n">num_chars</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div></div>

<p>Both the buffer and num_chars are items of the user controlled tree_connect_request structure so we have a copy operation with no restriction controlled by the user.</p>

<p><br /></p>

<h4 id="32-firmware-preparallel-to-os">3.2. Firmware (pre/parallel-to-OS).</h4>

<h5 id="321-desktop">3.2.1. Desktop.</h5>

<h6 id="3212-cve-2021-21574-bios-disconnect">3.2.1.2. CVE-2021-21574 “BIOS Disconnect”.</h6>

<p>This is a vulnerability in a feature called “Dell BIOSConnect” which support BIOS updates.</p>

<p>BIOS, Basic Input Output System, as well as UEFI, Unified Extensible Firmware Interface, are both firmware interfaces that initialize hardware and boot the operating system when a device such as a computer turn on. UEFI is kind of a replace to BIOS startup engine, in many cases, devices marketed as BIOS implements UEFI.</p>

<p>When an update is request, the DELL laptop connect do Dell.com and request CatalogBc.xml which parses in order to reach if a BIOS update (FOTA.EFI) or an Operating System update (CSOS.EFI) is available. EFI files are boot loader executables for devices using UEFI.</p>

<p>There exists a vulnerability (CVE-2021-21571) in which the request accepts data not only from dell.com but any subdomain of dell.com (accepts a wildcard certificate: *.dell.com) meaning that all the information received in the request and parsed later is attacker controlled.</p>

<p>So, we have the following block code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Pseudocode derived from assembly</span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">write_ptr</span> <span class="o">=</span> <span class="n">buf_on_stack</span><span class="p">;</span> <span class="c1">//rbp-0x158</span>
<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">hex_ptr</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="o">*</span><span class="n">write_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">CONVERT_HEX</span><span class="p">(</span><span class="n">hex_ptr</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">CONVERT_HEX</span><span class="p">(</span><span class="n">hex_ptr</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">buf_on_stack</span> <span class="o">!=</span> <span class="n">calculated_sha256</span> <span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">buf_on_stack</span><span class="p">,</span> <span class="n">calculated_sha256</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">EFI_NOT_FOUND</span><span class="p">;</span>
  <span class="p">}</span>
<span class="c1">//...</span>
</code></pre></div></div>

<p>At the while loop we are writting on a stack buffer at the following address of the pointer <em>write_ptr</em>, since this increment persist in each iteration the hole buffer is being written and since the break conditions depends on an attacker-controlled parameter (hex_ptr) and no sanitization is being made, this can result in a stack buffer overflow.</p>

<p>Is worth to note that the index (idx) cannot be bigger than 20000 but, as the commentary says, the buffer is not expected to be 158 slots so basically is like the previous condition does not exists.</p>

<p><br /></p>

<h5 id="322-mobile">3.2.2. Mobile.</h5>

<h6 id="3221-cve-ssbb-bh2021">3.2.2.1. CVE-SSBB-BH2021.</h6>

<p>Samsung cellular modems (basebands) need to parse cellular protocol messages. Session Initiation Protocol (SIP) is one such message type used by 4G and 5G networks. Some SIP message content is encoded in XML.</p>

<p>Thus, a compromised pr malicious carrier, or a fake cellular basestation can send ACID SIP messages that will be parsed by the baseband.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">**</span> <span class="nf">find_tag_end</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_char</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">result</span> <span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cur_char</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur_char</span> <span class="o">&lt;=</span> <span class="mh">0xD</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cur_char</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2601</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// \0 \t \n \r</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">cur_char</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_C0008001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// space / &gt; ?</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">IMSPL_XmlGetNextTagName</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
  <span class="c1">// The cut code will:</span>
  <span class="c1">// 1. Skip space characters</span>
  <span class="c1">// 2. Find the beginning mark '&lt;'</span>
  <span class="c1">// 3. Skip comments</span>
  <span class="c1">// ...</span>
  <span class="kt">char</span> <span class="o">*</span> <span class="n">v8</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span> <span class="n">v13</span><span class="p">;</span>
  <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
  <span class="n">find_tag_end</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">v13</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">v8</span> <span class="o">!=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v8</span><span class="p">);</span>
    <span class="n">dst</span><span class="p">[</span><span class="n">v9</span> <span class="o">-</span> <span class="n">v8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">V12</span> <span class="o">=</span> <span class="mi">10601</span><span class="p">;</span>
    <span class="c1">// IMSPL_XmiGetNextTagName: Tag name</span>
    <span class="n">v11</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">log_struct_437f227c</span><span class="p">;</span>
    <span class="n">Logs</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v11</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dst</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">20071784</span><span class="p">);</span>
    <span class="o">*</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">**</span><span class="p">)</span><span class="n">src</span> <span class="o">=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">LOBYTE</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">IMSPL_XmlParser_ContactLstDecode</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span>
  <span class="n">log_info_s</span> <span class="o">*</span><span class="n">v7</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">v8</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">v10</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">v11</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span>

  <span class="n">bzero</span><span class="p">(</span><span class="n">v11</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
  <span class="n">v10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">a1</span><span class="p">;</span>
  <span class="n">v8</span> <span class="o">=</span> <span class="mi">10597</span><span class="p">;</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="c1">// ----------%s----------</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">log_struct_4380937c</span><span class="p">;</span>
  <span class="n">log_0x418ffa6c</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v7</span><span class="p">,</span> <span class="s">"IMSPL_XmlParser_ContactLstDecode"</span><span class="p">,</span> <span class="o">-</span><span class="mi">20071784</span><span class="p">)</span> <span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IMSPL_XmlGetNextTagName</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span><span class="p">,</span> <span class="n">v11</span><span class="p">)</span> <span class="o">!</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nl">LABEL_8:</span>
    <span class="o">*</span><span class="n">a1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v9</span><span class="p">;</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="mi">10597</span><span class="p">;</span>
    <span class="c1">// Function END</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">log_struct_43809448</span><span class="p">;</span>
    <span class="n">log_0x418ffa6c</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v7</span><span class="p">,</span> <span class="o">-</span><span class="mi">20071784</span><span class="p">)</span> <span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can see that the flow of the code is as follows:</p>

<pre><code class="language-less">IMSPL_XmlParser_ContactLstDecode() --&gt; IMSPL_XmlGetNextTagName() --&gt; find_tag_end()
</code></pre>

<p>Lets consider carefully the code above. Considering <em>a1</em> and <em>a2</em> are user controlled and a buffer is declared at <em>IMSPL_XmlParser_ContactLstDecode()</em>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">IMSPL_XmlParser_ContactLstDecode</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="kt">char</span> <span class="n">v11</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span>
  <span class="c1">//...</span>
</code></pre></div></div>

<p>Then, we dereference <em>a1</em> pointer and cast his contents as a pointer to <em>unsigned __int8</em> assigning it to <em>v4</em> and it to <em>v9</em> and this one is getting called along with the buffer in <em>IMSPL_XmlGetNextTagName()</em> a pointer to char:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">IMSPL_XmlParser_ContactLstDecode</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span>
  <span class="c1">//...</span>
  <span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="n">v9</span><span class="p">;</span>
  <span class="c1">//...</span>
  <span class="kt">char</span> <span class="n">v11</span><span class="p">[</span><span class="mi">136</span><span class="p">];</span>
  <span class="c1">//...</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">a1</span><span class="p">;</span>
  <span class="c1">//...</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
  <span class="c1">//...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IMSPL_XmlGetNextTagName</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v9</span><span class="p">,</span> <span class="n">v11</span><span class="p">)</span> <span class="o">!</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>IMSPL_XmlGetNextTagName()</em> accepts two parameters as pointers; <em>src</em> and <em>dst</em> (source and destiny), this defines something like a copy data function. On it, <em>src</em> is assigned <em>ptr</em> and then <em>v8</em> is defined as an advanced pointer that pointers to the next byte of <em>ptr</em>, also, <em>v13</em> is defined as a pointer to a pointer to a char and <em>v13[0]</em> (this is the first pointer v13 points at) is <em>v8</em>, then some operation is performed with <em>v13</em> using <em>find_tag_end()</em> function. Later, <em>memcpy()</em> over <em>dst</em> (our local buffer) an undeterminated number of bytes (<em>v13[0] - v8</em>) from <em>ptr + 1</em> (our <em>a1</em> user controlled parameter).</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">IMSPL_XmlGetNextTagName</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span> <span class="n">v8</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span> <span class="n">v13</span><span class="p">;</span>
  <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v8</span><span class="p">;</span>
  <span class="n">find_tag_end</span><span class="p">((</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">v13</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">v8</span> <span class="o">!=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v8</span><span class="p">);</span>
    <span class="c1">//...</span>
  <span class="p">}</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This essentially means that if <em>v13[0] - v8</em> is big enough, the <em>memcpy</em> operation would lead to a stack buffer overflow. Let’s check what <em>find_tag_end</em> does.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">char</span> <span class="o">**</span> <span class="nf">find_tag_end</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v2</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cur_char</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">result</span> <span class="p">;</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cur_char</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int8</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur_char</span> <span class="o">&lt;=</span> <span class="mh">0xD</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cur_char</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2601</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// \0 \t \n \r</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">cur_char</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&lt;=</span> <span class="mh">0x1F</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">unk_C0008001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// space / &gt; ?</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The find_tag_end function return the address to the tag end of the XML string, so if you introduce a string big enough, the offset returned (V13[0] - v8) would be big enough to provoke an overflow.</p>

<p>We could prevent this including in the if statement the following condition:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">IMSPL_XmlGetNextTagName</span><span class="p">(){</span>
  <span class="c1">//...</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">v8</span> <span class="o">!=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">v13</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">v8</span> <span class="o">&lt;=</span> <span class="mi">136</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//...</span>
  <span class="p">}</span>
  <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="33-kernel-preparallel-to-os">3.3. Kernel (pre/parallel-to-OS).</h4>

<h5 id="331-server">3.3.1. Server.</h5>

<h6 id="3311-cve-2022-0435">3.3.1.1. CVE-2022-0435.</h6>

<p>Transparent Inter-Process Communication (TIPC) protocol is designed for IPC over the network within a multi-system computing cluster (comprised of “nodes” and “links”).</p>

<p>There is a “monitoring framework” that is used by nodes to exchange information “domain records” about their view of the topology within the cluster. Is a specialized network protocol designed for high-performance communication in clustered computing environments. Unlike traditional networking protocols that focus on wide-area networks, TIPC is optimized for tightly-coupled systems that need to work together as a single computational unit.</p>

<p>The last received domain record is stored in <em>tipc_peer-&gt;domain</em>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* struct tipc_peer: state of a peer node and its domain
 * @addr: tipc node identity of peer
 * @head_map: shows which other nodes currently consider peer 'up'
 * @domain: most recent domain record from peer
 * @hash: position in hashed lookup list
 * @list: position in linked list, in circular ascending order by 'addr'
 * @applied: number of reported domain members applied on this monitor list
 * @is_up: peer is up as seen from this node
 * @is_head: peer is assigned domain head as seen from this node
 * @is_local: peer is in local domain and should be continuously monitored
 * @down_cnt: - numbers of other peers which have reported this on lost
 */</span>
<span class="k">struct</span> <span class="n">tipc_peer</span> <span class="p">{</span>
  <span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="o">*</span><span class="n">domain</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">hlist_node</span> <span class="n">hash</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">applied</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">down_cnt</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">is_up</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">is_head</span><span class="p">;</span>
  <span class="n">bool</span> <span class="n">is_local</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* struct tipc_mon_domain: domain record to be transferred between peers
 * @len: actual size of domain record
 * @gen: current generation of sender's domain
 * @ack_gen: most recent generation of self's domain acked by peer
 * @member_cnt: number of domain member nodes described in this record
 * @up_map: bit map indicating which of the members the sender considers up
 * @members: identity of the domain members
 */</span>
<span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="p">{</span>
  <span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">gen</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">ack_gen</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">member_cnt</span><span class="p">;</span>
  <span class="n">u64</span> <span class="n">up_map</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">members</span><span class="p">[</span><span class="n">MAX_MON_DOMAIN</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define MAX_MON_DOMAIN       64
</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dom_rec_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="o">*</span><span class="n">dom</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mcnt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// 16 + 4·mcnt</span>
  <span class="k">return</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">members</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dom</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mcnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* tipc_mon_rcv - process monitor domain event message
 */</span>
<span class="c1">// ACID: *data, dlen</span>
<span class="kt">void</span> <span class="nf">tipc_mon_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span>
      <span class="k">struct</span> <span class="n">tipc_mon_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bearer_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">tipc_monitor</span> <span class="o">*</span><span class="n">mon</span> <span class="o">=</span> <span class="n">tipc_monitor</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">bearer_id</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="o">*</span><span class="n">arrv_dom</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="n">dom_bef</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="o">*</span><span class="n">dom</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">tipc_peer</span> <span class="o">*</span><span class="n">peer</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">new_member_cnt</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">member_cnt</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">new_dlen</span> <span class="o">=</span> <span class="n">dom_rec_len</span><span class="p">(</span><span class="n">arrv_dom</span><span class="p">,</span> <span class="n">new_member_cnt</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">new_gen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">acked_gen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">ack_gen</span><span class="p">);</span>
  <span class="n">bool</span> <span class="n">probing</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">probing</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">applied_bef</span><span class="p">;</span>

  <span class="n">state</span><span class="o">-&gt;</span><span class="n">probing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="cm">/* Sanity check received domain record */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="n">dom_rec_len</span><span class="p">(</span><span class="n">arrv_dom</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="n">dom_rec_len</span><span class="p">(</span><span class="n">arrv_dom</span><span class="p">,</span> <span class="n">new_member_cnt</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="n">new_dlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">new_dlen</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="cm">/* Synch generation numbers with peer if link just came up */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">synched</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">peer_gen</span> <span class="o">=</span> <span class="n">new_gen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">acked_gen</span> <span class="o">=</span> <span class="n">acked_gen</span><span class="p">;</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">synched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">more</span><span class="p">(</span><span class="n">acked_gen</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">acked_gen</span><span class="p">))</span>
    <span class="n">state</span><span class="o">-&gt;</span><span class="n">acked_gen</span> <span class="o">=</span> <span class="n">acked_gen</span><span class="p">;</span>

  <span class="cm">/* Drop duplicate unless we are waiting for a probe response */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">more</span><span class="p">(</span><span class="n">new_gen</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">peer_gen</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">probing</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mon</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  <span class="n">peer</span> <span class="o">=</span> <span class="n">get_peer</span><span class="p">(</span><span class="n">mon</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peer</span> <span class="o">||</span> <span class="o">!</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">is_up</span><span class="p">)</span>
    <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

  <span class="cm">/* Peer is confirmed, stop any ongoing probing */</span>
  <span class="n">peer</span><span class="o">-&gt;</span><span class="n">down_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Task is done for duplicate record */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">more</span><span class="p">(</span><span class="n">new_gen</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">peer_gen</span><span class="p">))</span>
    <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

  <span class="n">state</span><span class="o">-&gt;</span><span class="n">peer_gen</span> <span class="o">=</span> <span class="n">new_gen</span><span class="p">;</span>

  <span class="cm">/* Cache current domain record for later use */</span>
  <span class="n">dom_bef</span><span class="p">.</span><span class="n">member_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">dom</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dom</span><span class="p">)</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dom_bef</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

  <span class="cm">/* Transform and store received domain record */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom</span> <span class="o">||</span> <span class="p">(</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">new_dlen</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">dom</span><span class="p">);</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">new_dlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    <span class="n">peer</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">dom</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom</span><span class="p">)</span>
      <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">new_dlen</span><span class="p">;</span>
  <span class="n">dom</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">=</span> <span class="n">new_gen</span><span class="p">;</span>
  <span class="n">dom</span><span class="o">-&gt;</span><span class="n">member_cnt</span> <span class="o">=</span> <span class="n">new_member_cnt</span><span class="p">;</span>
  <span class="n">dom</span><span class="o">-&gt;</span><span class="n">up_map</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">up_map</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">new_member_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">dom</span><span class="o">-&gt;</span><span class="n">members</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">members</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

  <span class="cm">/* Update peers affected by this domain record */</span>
  <span class="n">applied_bef</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">applied</span><span class="p">;</span>
  <span class="n">mon_apply_domain</span><span class="p">(</span><span class="n">mon</span><span class="p">,</span> <span class="n">peer</span><span class="p">);</span>
  <span class="n">mon_identify_lost_members</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dom_bef</span><span class="p">,</span> <span class="n">applied_bef</span><span class="p">);</span>
  <span class="n">mon_assign_roles</span><span class="p">(</span><span class="n">mon</span><span class="p">,</span> <span class="n">peer_head</span><span class="p">(</span><span class="n">peer</span><span class="p">));</span>
<span class="nl">exit:</span>
  <span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mon</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At a first glance we can validate that this code is vulnerable to a heap buffer overflow.</p>

<p>First, consider that the code introduces the user-controlled pointer <em>data</em> to <em>arrv_dom</em> and then set up some variables:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">tipc_mon_rcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tipc_mon_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bearer_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">tipc_monitor</span> <span class="o">*</span><span class="n">mon</span> <span class="o">=</span> <span class="n">tipc_monitor</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">bearer_id</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="o">*</span><span class="n">arrv_dom</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
  <span class="c1">//...</span>
  <span class="n">u16</span> <span class="n">new_member_cnt</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">member_cnt</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">new_dlen</span> <span class="o">=</span> <span class="n">dom_rec_len</span><span class="p">(</span><span class="n">arrv_dom</span><span class="p">,</span> <span class="n">new_member_cnt</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">new_gen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">acked_gen</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">ack_gen</span><span class="p">);</span>
</code></pre></div></div>

<p>All of this variables are used-controled data. Then it performs some sanitization over the received domain:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="n">dom_rec_len</span><span class="p">(</span><span class="n">arrv_dom</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
  <span class="k">return</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">!=</span> <span class="n">dom_rec_len</span><span class="p">(</span><span class="n">arrv_dom</span><span class="p">,</span> <span class="n">new_member_cnt</span><span class="p">))</span>
  <span class="k">return</span><span class="p">;</span>
<span class="k">if</span> <span class="p">((</span><span class="n">dlen</span> <span class="o">&lt;</span> <span class="n">new_dlen</span><span class="p">)</span> <span class="o">||</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">new_dlen</span><span class="p">)</span>
  <span class="k">return</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>The first condition checks if the provided length of the domain is at least bigger than the domain record without the members array.</p>
  </li>
  <li>
    <p>The second condition verifies that <em>dlen</em> is equal than the domain record with the array members.</p>
  </li>
  <li>
    <p>The third verifies that dlen is at least equal than new_dlen.</p>
  </li>
</ul>

<p>This conditions are just small sanity checks that we always pass since dlen is user-controlled.</p>

<p>After a few operations that do not affect to the variables we control we finally get over a for loop:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">new_member_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
  <span class="n">dom</span><span class="o">-&gt;</span><span class="n">members</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">members</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</code></pre></div></div>

<p><em>dom</em> struct is defined just above:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dom</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">dom</span><span class="p">)</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dom_bef</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

<span class="cm">/* Transform and store received domain record */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom</span> <span class="o">||</span> <span class="p">(</span><span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">new_dlen</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">dom</span><span class="p">);</span>
  <span class="n">dom</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">new_dlen</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
  <span class="n">peer</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">dom</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dom</span><span class="p">)</span>
    <span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">new_dlen</span><span class="p">;</span>
<span class="n">dom</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">=</span> <span class="n">new_gen</span><span class="p">;</span>
<span class="n">dom</span><span class="o">-&gt;</span><span class="n">member_cnt</span> <span class="o">=</span> <span class="n">new_member_cnt</span><span class="p">;</span>
<span class="n">dom</span><span class="o">-&gt;</span><span class="n">up_map</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">arrv_dom</span><span class="o">-&gt;</span><span class="n">up_map</span><span class="p">);</span>
</code></pre></div></div>

<p>We remember that peer-&gt;domain contains the information of the domain received before, so here the program take two paths:</p>

<ul>
  <li>
    <p>If it is the first domain of the iteration, then peer-&gt;domain is empty or better to say, NULL, thus the pointer contents gets alloced in the heap and the struct contents gets stored in the heap.</p>
  </li>
  <li>
    <p>If is not the first domain, !dom is false and (as long as dom-&gt;len &lt; new_dlen) the allocation does not get triggered and the structure and his contents gets defined in the stack.</p>
  </li>
</ul>

<p>Thus, lets check the loop, since the constraint condition is user controlled, and the array size is 64, then this loop could lead to a buffer overflow, however, the variable which is being assigned is also fixed since we are assigning from other 64 slots array. Thus, despite the for loop iterations are user controlled, the data copy operation is limited.</p>

<p>How ever, we know that in the following iterations after the first one, dom is a structure defined on the stack, and a memcpy() operation takes place:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dom</span> <span class="o">=</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">dom</span><span class="p">)</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dom_bef</span><span class="p">,</span> <span class="n">dom</span><span class="p">,</span> <span class="n">dom</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</code></pre></div></div>

<p>What is getting copied is user-controlled data <em>dom</em>, the previous domain and the destiny is a local-define structure:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">tipc_mon_domain</span> <span class="n">dom_bef</span><span class="p">;</span>
</code></pre></div></div>

<p>So is a contiguos memory region in the stack of the function and the memcpy operation is a linear stack buffer overflow.</p>

<p><br /></p>

<h3 id="4-detection">4. Detection.</h3>

<p>There are some mechanisms and tools that can help to detect Linear Stack Buffer Overflows.</p>

<p><br /></p>

<h4 id="41-fortify_source">4.1. FORTIFY_SOURCE.</h4>

<h5 id="411-definition">4.1.1. Definition.</h5>

<p>FORTIFY_SOURCE is a compile-time and runtime protection mechanism in GCC and Clang compilers that helps detect buffer overflows and other memory safety issues in C/C++ programs. It provides lightweight support for detecting buffer overflows in various functions that perform operations on memory and strings by replacing standard library functions that are prone to buffer overflows with <em>wrapper functions</em> that add bounds checking to dangerous libc functions: <strong>memcpy, mempcpy, memmove, memset, strcpy, stpcpy, strncpy, strcat, strncat, sprintf, vsprintf, snprintf, vsnprintf, gets.</strong></p>

<p>Not all types of buffer overflows can be detected with this macro, but it does provide an extra level of validation for some functions that are potentially a source of buffer overflow flaws.</p>

<p>To use FORTIFY_SOURCE, you must also compile with optimization enabled (-O1 or higher, -g -O2), because it relies on compiler analysis to determine buffer sizes.</p>

<p>This mechanism is implemented as a macro and can be used in three levels of detection:</p>

<ul>
  <li><strong>D_FORTIFY_SOURCE=1</strong>: Enables compile-time and runtime checks that shouldn’t change program behavior.</li>
  <li><strong>D_FORTIFY_SOURCE=2</strong>: More aggressive checking, including some cases that might cause false positives.</li>
  <li><strong>D_FORTIFY_SOURCE=3</strong>: (newer) Even more checks, including dynamic bounds checking.</li>
</ul>

<p><br /></p>

<h5 id="412-example">4.1.2. Example.</h5>

<p>Consider the following vulnerable code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="c1"> //Imports strcpy from libc header file.</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">(</span><span class="s">"Buffer Contains: %s , Size Of Buffer is %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">printf</span> <span class="p">(</span><span class="s">"Buffer Contains: %s , Size Of Buffer is %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This codes uses the unsafe <em>strcpy()</em> function to pass user-controlled cli first parameter to a stack-buffer. Thus, this code is vulnerable to stack buffer overflow. Note that we are including string.h libc header file.</p>

<p>We can compile it with the following command of GCC:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gcc <span class="nt">-D_FORTIFY_SOURCE</span><span class="o">=</span>1 <span class="nt">-Wall</span> <span class="nt">-g</span> <span class="nt">-O2</span> fortify_test.c <span class="nt">-o</span> fortify_test
</code></pre></div></div>

<ul>
  <li><em>-D_FORTIFY_SOURCE=1</em>, check-level 1 of FORTIFY_SOURCE.</li>
  <li><em>-Wall</em>, enable most warning messages.</li>
  <li><em>-g</em>, Generate debug information in default format.</li>
  <li><em>-O2</em>, Level 2 of optimization (Turning on optimization flags makes the compiler attempt to improve the performance and/or code size at the expense of compilation time and possibly the ability to debug the program. Necesary to call the frotify macro).</li>
</ul>

<p>The preprocessor macro D_FORTIFY_SOURCE=1 strcpy() enables wrapper substitution, this can be checked obtaining the dissasembly of the code:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>objdump <span class="nt">-d</span> fortify_test

<span class="c">###[...]</span>

00000000000010a0 &lt;main&gt;:
    10a0:       f3 0f 1e fa             endbr64
    10a4:       41 54                   push   %r12
    10a6:       4c 8d 25 5b 0f 00 00    lea    0xf5b<span class="o">(</span>%rip<span class="o">)</span>,%r12        <span class="c"># 2008 &lt;_IO_stdin_used+0x8&gt;</span>
    10ad:       ba 05 00 00 00          mov    <span class="nv">$0x5</span>,%edx
    10b2:       55                      push   %rbp
    10b3:       4c 89 e7                mov    %r12,%rdi
    10b6:       48 89 f5                mov    %rsi,%rbp
    10b9:       53                      push   %rbx
    10ba:       48 83 ec 10             sub    <span class="nv">$0x10</span>,%rsp
    10be:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax
    10c5:       00 00
    10c7:       48 89 44 24 08          mov    %rax,0x8<span class="o">(</span>%rsp<span class="o">)</span>
    10cc:       31 c0                   xor    %eax,%eax
    10ce:       48 8d 5c 24 03          lea    0x3<span class="o">(</span>%rsp<span class="o">)</span>,%rbx
    10d3:       48 89 de                mov    %rbx,%rsi
    10d6:       e8 a5 ff ff ff          call   1080 &lt;<span class="nb">printf</span>@plt&gt;
    10db:       48 8b 75 08             mov    0x8<span class="o">(</span>%rbp<span class="o">)</span>,%rsi
    10df:       ba 05 00 00 00          mov    <span class="nv">$0x5</span>,%edx
    10e4:       48 89 <span class="nb">df                </span>mov    %rbx,%rdi
    10e7:       e8 a4 ff ff ff          call   1090 &lt;__strcpy_chk@plt&gt; <span class="c"># strcpy_chk is called instead of simply strcpy.</span>
    10ec:       31 c0                   xor    %eax,%eax
    10ee:       ba 05 00 00 00          mov    <span class="nv">$0x5</span>,%edx
    10f3:       48 89 de                mov    %rbx,%rsi
    10f6:       4c 89 e7                mov    %r12,%rdi
    10f9:       e8 82 ff ff ff          call   1080 &lt;<span class="nb">printf</span>@plt&gt;
    10fe:       48 8b 44 24 08          mov    0x8<span class="o">(</span>%rsp<span class="o">)</span>,%rax
    1103:       64 48 2b 04 25 28 00    sub    %fs:0x28,%rax
    110a:       00 00
    110c:       75 0b                   jne    1119 &lt;main+0x79&gt;
    110e:       48 83 c4 10             add    <span class="nv">$0x10</span>,%rsp
    1112:       31 c0                   xor    %eax,%eax
    1114:       5b                      pop    %rbx
    1115:       5d                      pop    %rbp
    1116:       41 5c                   pop    %r12
    1118:       c3                      ret
    1119:       e8 52 ff ff ff          call   1070 &lt;__stack_chk_fail@plt&gt;
    111e:       66 90                   xchg   %ax,%ax
  <span class="c">###[...]</span>
</code></pre></div></div>

<p><br /></p>

<h5 id="413-buffer-overflow-detection">4.1.3. Buffer Overflow detection.</h5>

<p>In the example provided above, we are passing a cli-argument parameter to the vulnerable function, which only gets defined at runtime and have no impact at compile-time, thus, this potential danger remains undetected despite the use of the fortified wrapper. This is a good example of how some LBO cannot be detected with this mechanism.</p>

<p>FORTIFY_SOURCE provides a runtime detection level, D_FORTIFY_SOURCE=3, which warns about buffer overflow in execution time:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gcc <span class="nt">-D_FORTIFY_SOURCE</span><span class="o">=</span>3 <span class="nt">-Wall</span> <span class="nt">-g</span> <span class="nt">-O2</span> test.c <span class="nt">-o</span> <span class="nb">test</span>
<span class="nv">$ </span>./test AAA
Buffer Contains:  , Size Of Buffer is 5
Buffer Contains: AAA , Size Of Buffer is 5
<span class="nv">$ </span>./test AAAAAA
Buffer Contains:  , Size Of Buffer is 5
<span class="k">***</span> buffer overflow detected <span class="k">***</span>: terminated
Aborted <span class="o">(</span>core dumped<span class="o">)</span>
</code></pre></div></div>

<p>But the reality is that betweem this and provoke a crash there is not much difference.</p>

<p>However, if we change the code to, instead of passing to strcpy a runtime-defined value, a hardcoded string:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="c1"> //Imports strcpy from libc header file.</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="n">printf</span> <span class="p">(</span><span class="s">"Buffer Contains: %s , Size Of Buffer is %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">"THIS WILL BE OVERFLOW, BEWARE!"</span><span class="p">);</span>
<span class="n">printf</span> <span class="p">(</span><span class="s">"Buffer Contains: %s , Size Of Buffer is %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And compile the code, we will find a warning in the compile attempt:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gcc <span class="nt">-D_FORTIFY_SOURCE</span><span class="o">=</span>2 <span class="nt">-Wall</span> <span class="nt">-g</span> <span class="nt">-O2</span> test.c <span class="nt">-o</span> <span class="nb">test
</span>test.c: In <span class="k">function</span> ‘main’:
<span class="c">#...</span>
In <span class="k">function</span> ‘strcpy’,
    inlined from ‘main’ at test.c:7:1:
/usr/include/x86_64-linux-gnu/bits/string_fortified.h:79:10: warning: ‘__builtin___memcpy_chk’ forming offset <span class="o">[</span>5, 30] is out of the bounds <span class="o">[</span>0, 5] of object ‘buffer’ with <span class="nb">type</span> ‘char[5]’ <span class="o">[</span><span class="nt">-Warray-bounds</span><span class="o">=]</span>
   79 |   <span class="k">return </span>__builtin___strcpy_chk <span class="o">(</span>__dest, __src, __glibc_objsize <span class="o">(</span>__dest<span class="o">))</span><span class="p">;</span>
      |          ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
test.c: In <span class="k">function</span> ‘main’:
test.c:5:6: note: ‘buffer’ declared here
    5 | char buffer[5]<span class="p">;</span>
      |      ^~~~~~
</code></pre></div></div>

<p>So this tool is useful to compile code in order to see if there is any potential overflow latent within the program.</p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#csoft">csoft</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=%28Linear%29+Stack+Buffer+Overflow.&url=http%3A%2F%2Flocalhost%3A4000%2F2025-11-06-LSBO%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2025-11-06-LSBO%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2025-11-06-LSBO%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2025-08-11-Text-Editor/" data-toggle="tooltip" data-placement="top" title="Text Editor.">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2025-11-07-CVE-2021-20294/" data-toggle="tooltip" data-placement="top" title="CVE-2021-20294.">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/Qv1nTv5" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/Qvintvs1" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/german-sanmillan-68b308229/" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        German
        &nbsp;&bull;&nbsp;
      
      2026

      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>


  
  
    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
