<!DOCTYPE html>
<html lang="en">
<!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>(Linear) Heap Buffer Overflow.</title>

  
  <meta name="author" content="German">
  

  <meta name="description" content="Notes from Heap Buffer Overflow course from OST2.">

  

  

  
  <link rel="alternate" type="application/rss+xml" title="Home" href="http://localhost:4000/feed.xml">
  

  

  

  

  


  
    
      
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  
    
      <link rel="stylesheet" href="/assets/css/custom-dark.css">
    
  

  
  
  

  

  
  <meta property="og:site_name" content="Home">
  <meta property="og:title" content="(Linear) Heap Buffer Overflow.">
  <meta property="og:description" content="Notes from Heap Buffer Overflow course from OST2.">

  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="German">
  <meta property="og:article:published_time" content="2025-11-18T00:00:00-05:00">
  <meta property="og:url" content="http://localhost:4000/2025-11-18-HBO/">
  <link rel="canonical" href="http://localhost:4000/2025-11-18-HBO/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@Qvintvs1">
  <meta name="twitter:creator" content="@Qvintvs1">

  <meta property="twitter:title" content="(Linear) Heap Buffer Overflow.">
  <meta property="twitter:description" content="Notes from Heap Buffer Overflow course from OST2.">

  

  

  <script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };

  window.addEventListener('load', (event) => {
    document.querySelectorAll("script[type='math/tex; mode=display']").forEach(function(el) {
      el.outerHTML = "\\[" + el.textContent + "\\]";
    });
    document.querySelectorAll("script[type='math/tex']").forEach(function(el) {
      el.outerHTML = "\\(" + el.textContent + "\\)";
    });
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
    script.async = true;
    document.head.appendChild(script);
  });
</script>


  

  

</head>


<body>

  


  <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><a class="navbar-brand" href="http://localhost:4000/">Home</a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Program</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/Cpage">C</a>
                  <a class="dropdown-item" href="/DHARMApage">Dharma</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Web2</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/BURPSUITEpage">Burp</a>
                  <a class="dropdown-item" href="/THMpage">Thm</a>
                  <a class="dropdown-item" href="/HackTheBoxpage">Htb</a>
                  <a class="dropdown-item" href="/PEN200page">BasicPentesting</a>
                  <a class="dropdown-item" href="/REDTEAMBASICSpage">RedTeam</a>
                  <a class="dropdown-item" href="/BLUETEAMBASICSpage">Blueteam</a>
                  <a class="dropdown-item" href="/REDESpage">Net</a>
                  <a class="dropdown-item" href="/2022-11-17-GitBasics">Git</a>
                  <a class="dropdown-item" href="/CSOFTpage">MemCorrupt</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">ZKP</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/MATHpage">Math</a>
                  <a class="dropdown-item" href="/RUSTpage">Rust</a>
                  <a class="dropdown-item" href="/NOIRpage">Noir</a>
            </div>
          </li>
        
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Assembly</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="/ASSEMpage">x86</a>
            </div>
          </li>
        
        <li class="nav-item">
          <a class="nav-link" id="nav-search-link" href="#" title="Search">
            <span id="nav-search-icon" class="fa fa-search"></span>
            <span id="nav-search-text">Search</span>
          </a>
        </li></ul>
  </div>

  

  

</nav>



<div id="beautifuljekyll-search-overlay">

  <div id="nav-search-exit" title="Exit search">✕</div>
  <input type="text" id="nav-search-input" placeholder="Search">
  <ul id="search-results-container"></ul>
  
  <script src="https://unpkg.com/simple-jekyll-search@latest/dest/simple-jekyll-search.min.js"></script>
  <script>
    var searchjson = '[ \
       \
        { \
          "title"    : "P vs NP.", \
          "category" : "math", \
          "url"      : "/2026-01-11-PvsNP/", \
          "date"     : "January 11, 2026" \
        }, \
       \
        { \
          "title"    : "Race Conditions.", \
          "category" : "csoft", \
          "url"      : "/2025-12-28-RaceCondition/", \
          "date"     : "December 28, 2025" \
        }, \
       \
        { \
          "title"    : "Introducción al Cálculo", \
          "category" : "matemáticas", \
          "url"      : "/2025-12-25-MathTest/", \
          "date"     : "December 25, 2025" \
        }, \
       \
        { \
          "title"    : "Uninitialize Data Access.", \
          "category" : "csoft", \
          "url"      : "/2025-12-23-UDA/", \
          "date"     : "December 23, 2025" \
        }, \
       \
        { \
          "title"    : "Control Flow.", \
          "category" : "assem", \
          "url"      : "/2025-12-12-ControlFlow/", \
          "date"     : "December 12, 2025" \
        }, \
       \
        { \
          "title"    : "Other Integer Issues.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-OtherIntegerIssues/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Integer Overflow/Underflow.", \
          "category" : "csoft", \
          "url"      : "/2025-12-05-IntegerOverflow-Underflow/", \
          "date"     : "December  5, 2025" \
        }, \
       \
        { \
          "title"    : "Passing Parameters.", \
          "category" : "assem", \
          "url"      : "/2025-12-04-Passing-Parameters/", \
          "date"     : "December  4, 2025" \
        }, \
       \
        { \
          "title"    : "Stackframe; Local variables, Arrays and Structures.", \
          "category" : "assem", \
          "url"      : "/2025-12-01-LocalVars_Arrays_structs/", \
          "date"     : "December  1, 2025" \
        }, \
       \
        { \
          "title"    : "Out-Of-Bounds Write.", \
          "category" : "csoft", \
          "url"      : "/2025-11-26-Out-Of-Bounds-Write/", \
          "date"     : "November 26, 2025" \
        }, \
       \
        { \
          "title"    : "Calling Functions.", \
          "category" : "assem", \
          "url"      : "/2025-11-21-CallingFunctions/", \
          "date"     : "November 21, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Heap Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-18-HBO/", \
          "date"     : "November 18, 2025" \
        }, \
       \
        { \
          "title"    : "Basic Instructions.", \
          "category" : "assem", \
          "url"      : "/2025-11-17-AssemblyBasicRegisters/", \
          "date"     : "November 17, 2025" \
        }, \
       \
        { \
          "title"    : "Computer Registers.", \
          "category" : "assem", \
          "url"      : "/2025-11-08-ComputerRegisters/", \
          "date"     : "November  8, 2025" \
        }, \
       \
        { \
          "title"    : "CVE-2021-20294.", \
          "category" : "csoft", \
          "url"      : "/2025-11-07-CVE-2021-20294/", \
          "date"     : "November  7, 2025" \
        }, \
       \
        { \
          "title"    : "(Linear) Stack Buffer Overflow.", \
          "category" : "csoft", \
          "url"      : "/2025-11-06-LSBO/", \
          "date"     : "November  6, 2025" \
        }, \
       \
        { \
          "title"    : "Text Editor.", \
          "category" : "C", \
          "url"      : "/2025-08-11-Text-Editor/", \
          "date"     : "August 11, 2025" \
        }, \
       \
        { \
          "title"    : "Garbage Collector.", \
          "category" : "C", \
          "url"      : "/2025-07-11-GarbageCollector/", \
          "date"     : "July 11, 2025" \
        }, \
       \
        { \
          "title"    : "Hashtables.", \
          "category" : "C", \
          "url"      : "/2025-06-13-HashTable/", \
          "date"     : "June 13, 2025" \
        }, \
       \
        { \
          "title"    : "Building my own malloc in C.", \
          "category" : "C", \
          "url"      : "/2025-06-09-BuildingOwnMalloc/", \
          "date"     : "June  9, 2025" \
        }, \
       \
        { \
          "title"    : "Malloc Tutorial", \
          "category" : "C", \
          "url"      : "/2025-06-06-MallocTutorial/", \
          "date"     : "June  6, 2025" \
        }, \
       \
        { \
          "title"    : "SharedLibraries&amp;FunctionHooking", \
          "category" : "C", \
          "url"      : "/2025-04-26-SharedLibraries&FunctionHooking/", \
          "date"     : "April 26, 2025" \
        }, \
       \
        { \
          "title"    : "File Descritors", \
          "category" : "C", \
          "url"      : "/2025-03-04-FileDescriptors/", \
          "date"     : "March  4, 2025" \
        }, \
       \
        { \
          "title"    : "Network Programming", \
          "category" : "C", \
          "url"      : "/2025-02-22-Network_Programming/", \
          "date"     : "February 22, 2025" \
        }, \
       \
        { \
          "title"    : "2. Constants and Literals in C.", \
          "category" : "C", \
          "url"      : "/2024-12-10-2.ConstantsinC-copy/", \
          "date"     : "December 10, 2024" \
        }, \
       \
        { \
          "title"    : "1. Basics of C", \
          "category" : "C", \
          "url"      : "/2024-12-02-1.BasicsOfC/", \
          "date"     : "December  2, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "DHA", \
          "url"      : "/2024-09-24-Dharma_Tutorial/", \
          "date"     : "September 24, 2024" \
        }, \
       \
        { \
          "title"    : "Gramáticas en Dharma", \
          "category" : "fuzz", \
          "url"      : "/2024-03-22-Dharma_Tutorial-copy/", \
          "date"     : "March 22, 2024" \
        }, \
       \
        { \
          "title"    : "Mi experiencia con el OSCP", \
          "category" : "pen", \
          "url"      : "/2023-11-19-PEN200_Experience/", \
          "date"     : "November 19, 2023" \
        }, \
       \
        { \
          "title"    : "Client Side", \
          "category" : "pen", \
          "url"      : "/2023-11-17-17.Client_Side_Attacks/", \
          "date"     : "November 17, 2023" \
        }, \
       \
        { \
          "title"    : "Deep Packet Tunneling", \
          "category" : "pen", \
          "url"      : "/2023-11-16-16.Tunneling_Through_Deep_Packet_Inspection/", \
          "date"     : "November 16, 2023" \
        }, \
       \
        { \
          "title"    : "Report", \
          "category" : "pen", \
          "url"      : "/2023-11-15-15.Making_Reports/", \
          "date"     : "November 15, 2023" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "pen", \
          "url"      : "/2023-11-14-14.Metasploit/", \
          "date"     : "November 14, 2023" \
        }, \
       \
        { \
          "title"    : "Password Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-13-13.Password_Attacks/", \
          "date"     : "November 13, 2023" \
        }, \
       \
        { \
          "title"    : "Active Directory Attacks", \
          "category" : "pen", \
          "url"      : "/2023-11-12-12.Active_Directory_Attacks/", \
          "date"     : "November 12, 2023" \
        }, \
       \
        { \
          "title"    : "Port Forwarding", \
          "category" : "pen", \
          "url"      : "/2023-11-11-11.Port_Forwarding/", \
          "date"     : "November 11, 2023" \
        }, \
       \
        { \
          "title"    : "Privilege Escalation", \
          "category" : "pen", \
          "url"      : "/2023-11-10-10.Privilege_Escalation/", \
          "date"     : "November 10, 2023" \
        }, \
       \
        { \
          "title"    : "File Transfers", \
          "category" : "pen", \
          "url"      : "/2023-11-09-9.File_Tranfers/", \
          "date"     : "November  9, 2023" \
        }, \
       \
        { \
          "title"    : "Buffer Overflows", \
          "category" : "pen", \
          "url"      : "/2023-11-08-8.Buffer_Overflows/", \
          "date"     : "November  8, 2023" \
        }, \
       \
        { \
          "title"    : "Vulnerability Scanning.", \
          "category" : "pen", \
          "url"      : "/2023-11-07-7.Vulnerability_Scanning/", \
          "date"     : "November  7, 2023" \
        }, \
       \
        { \
          "title"    : "Information Gathering", \
          "category" : "pen", \
          "url"      : "/2023-11-06-6.Active_Information_Gathering/", \
          "date"     : "November  6, 2023" \
        }, \
       \
        { \
          "title"    : "Windows", \
          "category" : "pen", \
          "url"      : "/2023-11-05-5.Windows/", \
          "date"     : "November  5, 2023" \
        }, \
       \
        { \
          "title"    : "Networking", \
          "category" : "pen", \
          "url"      : "/2023-11-04-4.Networking/", \
          "date"     : "November  4, 2023" \
        }, \
       \
        { \
          "title"    : "Scripting", \
          "category" : "pen", \
          "url"      : "/2023-11-03-3.Scripting/", \
          "date"     : "November  3, 2023" \
        }, \
       \
        { \
          "title"    : "Practical Tools", \
          "category" : "pen", \
          "url"      : "/2023-11-02-2.PracticalTools/", \
          "date"     : "November  2, 2023" \
        }, \
       \
        { \
          "title"    : "Linux", \
          "category" : "pen", \
          "url"      : "/2023-11-01-1.Linux/", \
          "date"     : "November  1, 2023" \
        }, \
       \
        { \
          "title"    : "Easy", \
          "category" : "hack", \
          "url"      : "/2022-12-01-Easy/", \
          "date"     : "December  1, 2022" \
        }, \
       \
        { \
          "title"    : "Git Basics", \
          "category" : "", \
          "url"      : "/2022-11-17-GitBasics/", \
          "date"     : "November 17, 2022" \
        }, \
       \
        { \
          "title"    : "Tier I", \
          "category" : "hack", \
          "url"      : "/2022-11-10-Tier_1/", \
          "date"     : "November 10, 2022" \
        }, \
       \
        { \
          "title"    : "Tier 0", \
          "category" : "hack", \
          "url"      : "/2022-11-09-Tier_0/", \
          "date"     : "November  9, 2022" \
        }, \
       \
        { \
          "title"    : "7.BufferOverflow.", \
          "category" : "thm", \
          "url"      : "/2022-11-02-7.BufferOverflow/", \
          "date"     : "November  2, 2022" \
        }, \
       \
        { \
          "title"    : "6.Offensive Pentesting", \
          "category" : "thm", \
          "url"      : "/2022-11-01-6.OffensivePentesting/", \
          "date"     : "November  1, 2022" \
        }, \
       \
        { \
          "title"    : "5.RedTeam", \
          "category" : "thm", \
          "url"      : "/2022-10-30-5.RedTeam/", \
          "date"     : "October 30, 2022" \
        }, \
       \
        { \
          "title"    : "4.Windows", \
          "category" : "thm", \
          "url"      : "/2022-10-22-4.Windows/", \
          "date"     : "October 22, 2022" \
        }, \
       \
        { \
          "title"    : "3.Junior Penetrationtester path", \
          "category" : "thm", \
          "url"      : "/2022-09-02-3.JRPenetrationTester/", \
          "date"     : "September  2, 2022" \
        }, \
       \
        { \
          "title"    : "2.Complete Begginer path.", \
          "category" : "thm", \
          "url"      : "/2022-08-07-2.CompleteBegginer/", \
          "date"     : "August  7, 2022" \
        }, \
       \
        { \
          "title"    : "1.Pre-Security path.", \
          "category" : "thm", \
          "url"      : "/2022-07-11-1Pre-Security/", \
          "date"     : "July 11, 2022" \
        }, \
       \
        { \
          "title"    : "0.Scripting for pentesters.", \
          "category" : "thm", \
          "url"      : "/2022-07-10-0.Scripting_for_pentesters/", \
          "date"     : "July 10, 2022" \
        }, \
       \
        { \
          "title"    : "Burp Certified Practitioner Practice Exam.", \
          "category" : "burp", \
          "url"      : "/2022-03-30-PracticeExam/", \
          "date"     : "March 30, 2022" \
        }, \
       \
        { \
          "title"    : "22. OAuth Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-27-22.OAuth_authentication/", \
          "date"     : "March 27, 2022" \
        }, \
       \
        { \
          "title"    : "21. HTTP Request Smuggling.", \
          "category" : "burp", \
          "url"      : "/2022-03-26-21.HTTP_request_smuggling/", \
          "date"     : "March 26, 2022" \
        }, \
       \
        { \
          "title"    : "20. HTTP Host Header Attacks.", \
          "category" : "burp", \
          "url"      : "/2022-03-25-20.HTTP_Host_header_attacks/", \
          "date"     : "March 25, 2022" \
        }, \
       \
        { \
          "title"    : "19. Web Cache Poisoning.", \
          "category" : "burp", \
          "url"      : "/2022-03-24-19.Web_cache_poisoning/", \
          "date"     : "March 24, 2022" \
        }, \
       \
        { \
          "title"    : "18. Server-Side Template Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-23-18.Serve-side_template_injection/", \
          "date"     : "March 23, 2022" \
        }, \
       \
        { \
          "title"    : "17. Insecure Deserialization.", \
          "category" : "burp", \
          "url"      : "/2022-03-22-17.Insecure_deserialization/", \
          "date"     : "March 22, 2022" \
        }, \
       \
        { \
          "title"    : "16. WebSockets.", \
          "category" : "burp", \
          "url"      : "/2022-03-21-16.WebSockets/", \
          "date"     : "March 21, 2022" \
        }, \
       \
        { \
          "title"    : "15.DOM-based XSS vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-20-15-DOM-based_vulnerabilities/", \
          "date"     : "March 20, 2022" \
        }, \
       \
        { \
          "title"    : "14. Clickjacking.", \
          "category" : "burp", \
          "url"      : "/2022-03-19-14.Clickjacking/", \
          "date"     : "March 19, 2022" \
        }, \
       \
        { \
          "title"    : "13. Cross-Origin Resource Sharing.", \
          "category" : "burp", \
          "url"      : "/2022-03-18-13.Cross-origin_resource_sharing_(CORS)/", \
          "date"     : "March 18, 2022" \
        }, \
       \
        { \
          "title"    : "12. Cross-Site Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-17-12.Cross-site_request_forgery_(CSRF)/", \
          "date"     : "March 17, 2022" \
        }, \
       \
        { \
          "title"    : "11. Cross-Site Scripting.", \
          "category" : "burp", \
          "url"      : "/2022-03-16-11.Cross-site_scripting_(XSS)/", \
          "date"     : "March 16, 2022" \
        }, \
       \
        { \
          "title"    : "10. XXE Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-15-10.XXE_injection/", \
          "date"     : "March 15, 2022" \
        }, \
       \
        { \
          "title"    : "9. Server-Side Request Forgery.", \
          "category" : "burp", \
          "url"      : "/2022-03-14-9.Server-side_request_forgery/", \
          "date"     : "March 14, 2022" \
        }, \
       \
        { \
          "title"    : "8. File Upload.", \
          "category" : "burp", \
          "url"      : "/2022-03-13-8.File_upload_vulnerabilities/", \
          "date"     : "March 13, 2022" \
        }, \
       \
        { \
          "title"    : "7. Access Control.", \
          "category" : "burp", \
          "url"      : "/2022-03-12-7.Access_control/", \
          "date"     : "March 12, 2022" \
        }, \
       \
        { \
          "title"    : "6. Information Disclosure.", \
          "category" : "burp", \
          "url"      : "/2022-03-11-6.Information_disclosure/", \
          "date"     : "March 11, 2022" \
        }, \
       \
        { \
          "title"    : "5. Bussiness Logic Vulnerabilities.", \
          "category" : "burp", \
          "url"      : "/2022-03-10-5.Business_logic_vulnerabilities/", \
          "date"     : "March 10, 2022" \
        }, \
       \
        { \
          "title"    : "4. Command Injection.", \
          "category" : "burp", \
          "url"      : "/2022-03-09-4.Command_Injection/", \
          "date"     : "March  9, 2022" \
        }, \
       \
        { \
          "title"    : "3. Directory Traversal.", \
          "category" : "burp", \
          "url"      : "/2022-03-08-3.Directory_Traversal/", \
          "date"     : "March  8, 2022" \
        }, \
       \
        { \
          "title"    : "2. Authentication.", \
          "category" : "burp", \
          "url"      : "/2022-03-07-2.Authentication/", \
          "date"     : "March  7, 2022" \
        }, \
       \
        { \
          "title"    : "1. SQLInjection", \
          "category" : "burp", \
          "url"      : "/2022-03-06-1.SQLInjection/", \
          "date"     : "March  6, 2022" \
        }, \
       \
        { \
          "title"    : "Seguridad Perimetral", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Seguridad_Perimetral/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Hardening de sistemas", \
          "category" : "blueteam", \
          "url"      : "/2022-02-09-Hardening_de_sistemas/", \
          "date"     : "February  9, 2022" \
        }, \
       \
        { \
          "title"    : "Bandit", \
          "category" : "otw", \
          "url"      : "/2022-02-08-Bandit/", \
          "date"     : "February  8, 2022" \
        }, \
       \
        { \
          "title"    : "Proxy", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Proxys/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Protocolos Relevantes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Protocolos_Importantes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Curso Básico Redes", \
          "category" : "redes", \
          "url"      : "/2022-02-07-Precurso_Redes/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "IPs", \
          "category" : "redes", \
          "url"      : "/2022-02-07-IPs/", \
          "date"     : "February  7, 2022" \
        }, \
       \
        { \
          "title"    : "Movimientos Laterales", \
          "category" : "redteam", \
          "url"      : "/2022-02-06-Introducci%C3%B3n_a_movimientos_laterales/", \
          "date"     : "February  6, 2022" \
        }, \
       \
        { \
          "title"    : "Evasión de Defensas", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Evasi%C3%B3n_de_Defensas/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Escalada de privilegios", \
          "category" : "redteam", \
          "url"      : "/2022-02-05-Escalada_de_privilegios/", \
          "date"     : "February  5, 2022" \
        }, \
       \
        { \
          "title"    : "Metasploit", \
          "category" : "redteam", \
          "url"      : "/2022-02-04-Metasploit_B%C3%A1sico/", \
          "date"     : "February  4, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a aplicaciones Android", \
          "category" : "redteam", \
          "url"      : "/2022-02-03-Ataques_aplicaciones_android/", \
          "date"     : "February  3, 2022" \
        }, \
       \
        { \
          "title"    : "Ataque a aplicaciones web.", \
          "category" : "redteam", \
          "url"      : "/2022-02-02-Ataques_a_aplicaciones_web/", \
          "date"     : "February  2, 2022" \
        }, \
       \
        { \
          "title"    : "Ataques a Infraestructuras y Redes", \
          "category" : "redteam", \
          "url"      : "/2022-02-01-Ataques_a_Infraestructuras_y_Redes/", \
          "date"     : "February  1, 2022" \
        }, \
       \
        { \
          "title"    : "Análisis de Objetivos", \
          "category" : "redteam", \
          "url"      : "/2022-01-28-An%C3%A1lisis_de_Objetivos/", \
          "date"     : "January 28, 2022" \
        }, \
       \
       \
        { \
          "title"    : "Assembly and Architecture Introduction.", \
          "category" : "page", \
          "url"      : "/ASSEMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Blueteam Basics", \
          "category" : "page", \
          "url"      : "/BLUETEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PortSwigger BurpSuite Course", \
          "category" : "page", \
          "url"      : "/BURPSUITEpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C-Family Software Memory Corruption Vulnerabilities", \
          "category" : "page", \
          "url"      : "/CSOFTpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "C &amp; Systems Fundamentals.", \
          "category" : "page", \
          "url"      : "/Cpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Dharma Fuzzer language", \
          "category" : "page", \
          "url"      : "/DHARMApage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Exploiting &amp; Reversing", \
          "category" : "page", \
          "url"      : "/EXPREVpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Fuzzing JavaScript Engine", \
          "category" : "page", \
          "url"      : "/Fuzzpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "HackTheBox", \
          "category" : "page", \
          "url"      : "/HackTheBoxpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/MATHpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "PEN200 notes", \
          "category" : "page", \
          "url"      : "/PEN200page/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Proyectos", \
          "category" : "page", \
          "url"      : "/PROJECTSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Networking Basics", \
          "category" : "page", \
          "url"      : "/REDESpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "RedTeam Basics", \
          "category" : "page", \
          "url"      : "/REDTEAMBASICSpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Retired Machines", \
          "category" : "page", \
          "url"      : "/RetiredMachinespage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "TryHackMe", \
          "category" : "page", \
          "url"      : "/THMpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "About me", \
          "category" : "page", \
          "url"      : "/aboutme/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "THM", \
          "category" : "page", \
          "url"      : "/preOSCPpage/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "Tag Index", \
          "category" : "page", \
          "url"      : "/tags/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page2/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page3/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page4/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page5/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page6/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page7/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page8/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page9/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page10/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page11/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page12/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page13/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page14/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page15/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page16/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page17/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page18/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page19/", \
          "date"     : "January 1, 1970" \
        }, \
       \
        { \
          "title"    : "", \
          "category" : "page", \
          "url"      : "/page20/", \
          "date"     : "January 1, 1970" \
        } \
       \
    ]';
    searchjson = JSON.parse(searchjson);

    var sjs = SimpleJekyllSearch({
      searchInput: document.getElementById('nav-search-input'),
      resultsContainer: document.getElementById('search-results-container'),
      json: searchjson
    });
  </script>
</div>





  <!-- TODO this file has become a mess, refactor it -->







<header class="header-section ">

<div class="intro-header no-img">
  <div class="container-md">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
        <div class="post-heading">
          <h1>(Linear) Heap Buffer Overflow.</h1>
          
            
              <h2 class="post-subheading">Notes from Heap Buffer Overflow course from OST2.</h2>
            
          

          
            <span class="post-meta">Posted on November 18, 2025</span>
            
            
          
        </div>
      </div>
    </div>
  </div>
</div>
</header>





<div class=" container-md ">
  <div class="row">
    <div class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 ">

      

      

      <article role="main" class="blog-post">
        <h3 id="1-definition">1. Definition.</h3>

<p>A linear heap buffer overflow (LHBO), similar to an LSBO, occurs when an huge amount of data gets written in a heap-allocated buffer. By huge we mean an amount of data large enough to exceed the buffer size resulting in adyacents memory structures to be overwritten.</p>

<p>A tipical example in C code is a weakly-bounded function copy user-controlled data (content and size) into a heap-alloced buffer:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">user_src</span><span class="p">,</span> <span class="n">user_len</span><span class="p">);</span>
</code></pre></div></div>

<p>Another typical example would be sequential data writes within a loop with user-controlled counter or exit condition.</p>

<p><br /></p>

<h3 id="2-exercises">2. Exercises.</h3>

<h4 id="21-cve-2019-7287-ios-buffer-overflow-in-provinfoiokituserclient">2.1. CVE-2019-7287: iOS Buffer Overflow in ProvInfoIOKitUserClient.</h4>

<p>A heap buffer overflow in an external method of an IOKit user client. In the driver pseudocode below the attacker controls the contents of the buffer pointed to by struct_in.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ACID: struct_in</span>
<span class="n">IOReturn</span> <span class="n">ProvInfoIOKitUserClient</span><span class="o">::</span><span class="n">ucEncryptSUInfo</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">struct_in</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">struct_out</span><span class="p">){</span>
  <span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">struct_out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">struct_in</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">struct_in</span><span class="p">[</span><span class="mh">0x7d4</span><span class="p">]);</span>
  <span class="c1">//...</span>
</code></pre></div></div>

<p>Thus we have a memory copy operation from user-controlled data source and counter to a heap buffer.</p>

<p>In the Apple XNU kernel, “external methods” are a way for kernel extensiones to provide a custom interface from userspace applications. Data comming from userspace should be treated as potential attacker-controlled data.</p>

<p><br /></p>

<h4 id="22-cve-2020-0917">2.2. CVE-2020-0917.</h4>

<p>Microsoft VBS (Virtualization Based Security) is a security feature that creates an ultra-secure, isolated environment within Windows by leveraging your CPU’s virtualization capabilities. Is like a “vault within the device”.</p>

<p>The Windows kernel is the core of the operating system that has complete control over everything. VBS splits this into two parts:</p>

<ul>
  <li>Normal kernel: Runs regular Windows operations.</li>
  <li>Secure kernel: A protected version that handles sensitive security operations (Hypervisor).</li>
</ul>

<p>Running in virtualization-isolated memory is a crucial security benefit. The secure kernel runs in a special memory area that is completely isolated from the normal Windows environment, protected by the CPU’s hypervisor, inaccessible even to the normal kernel or administrator-level malware.</p>

<p>A minor clarification; VBS doesn’t virtualize part of the existing kernel. Instead, it:</p>

<ul>
  <li>Creates a NEW secure kernel (called the “Secure Kernel” or runs in “Virtual Secure Mode”).</li>
  <li>Demotes normal Windows to run as a “guest” under the hypervisor.</li>
  <li>The hypervisor enforces isolation between these two environments.</li>
</ul>

<p>In this terms, the kernel it self runs at VTL0 (Virtual Trust Level; is a hierarchy of privilege/trust levels created by the hypervisor when VBS is enabled) and the secure kernel runs in VTL1 (note that the formal kernel runs in a lower number;0 and is the least trusted). This vulnerability refers on user-controlled data sended in the secure call between the kernel and the secure kernel.</p>

<pre><code class="language-less">┌─────────────────────────────────────────┐
│  VTL 1 (Higher Trust)                   │  ← Secure Kernel
│  - Most privileged                      │  - Can access everything
│  - Can see VTL 0 memory                 │  - Trusted
│  - Cannot be accessed by VTL 0          │
├─────────────────────────────────────────┤
│         Hypervisor                      │  ← Enforces VTL isolation
├─────────────────────────────────────────┤
│  VTL 0 (Lower Trust)                    │  ← Normal Windows Kernel
│  - Less privileged                      │  - Vulnerable to malware
│  - Cannot see VTL 1 memory              │  - LEAST trusted
│  - Blocked from secure resources        │
└─────────────────────────────────────────┘
</code></pre>

<p>Let’s check the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// XENO: This struct is not officially documented</span>
<span class="c1">// XENO: But this is what people have reverse engineered</span>
<span class="k">struct</span> <span class="n">_MDL</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">_MDL</span>      <span class="o">*</span><span class="n">Next</span><span class="p">;</span>
  <span class="n">CSHORT</span>           <span class="n">Size</span><span class="p">;</span>
  <span class="n">CSHORT</span>           <span class="n">MdlFlags</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_EPROCESS</span> <span class="o">*</span><span class="n">Process</span><span class="p">;</span>
  <span class="n">PVOID</span>            <span class="n">MappedSystemVa</span><span class="p">;</span>
  <span class="n">PVOID</span>            <span class="n">StartVa</span><span class="p">;</span>
  <span class="n">ULONG</span>            <span class="n">ByteCount</span><span class="p">;</span>
  <span class="n">ULONG</span>            <span class="n">ByteOffset</span><span class="p">;</span> 
<span class="p">}</span> <span class="n">MDL</span><span class="p">,</span> <span class="o">*</span><span class="n">PMDL</span><span class="p">;</span>
<span class="c1">// XENO: Struct is followed by a variable-length array</span>
<span class="c1">// XENO: Of physical-address (frame) pointers</span>

<span class="cp">#define MmInitializeMdl	(_MemoryDescriptorList,
</span>                         <span class="n">_BaseVa</span><span class="p">,</span>
                         <span class="n">_Length</span> 
<span class="p">)</span>
<span class="p">{</span> \
  <span class="p">(</span><span class="n">_MemoryDescriptorList</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Next</span> <span class="o">=</span> <span class="p">(</span><span class="n">PMDL</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span> \
  <span class="p">(</span><span class="n">_MemoryDescriptorList</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="p">(</span><span class="n">CSHORT</span><span class="p">)</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">MDL</span><span class="p">)</span> <span class="o">+</span> \
    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PFN_NUMBER</span><span class="p">)</span> <span class="o">*</span> <span class="n">ADDRESS_AND_SIZE_TO_SPAN_PAGES</span><span class="p">(</span><span class="n">_BaseVa</span><span class="p">,</span> <span class="n">_Length</span><span class="p">)));</span> \
  <span class="p">(</span><span class="n">_MemoryDescriptorList</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">MdlFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> \
  <span class="p">(</span><span class="n">_MemoryDescriptorList</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">StartVa</span> <span class="o">=</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">_BaseVa</span><span class="p">);</span> \
  <span class="p">(</span><span class="n">_MemoryDescriptorList</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ByteOffset</span> <span class="o">=</span> <span class="n">BYTE_OFFSET</span><span class="p">(</span><span class="n">_BaseVa</span><span class="p">);</span> \
  <span class="p">(</span><span class="n">_MemoryDescriptorList</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ByteCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">ULONG</span><span class="p">)</span> <span class="n">_Length</span><span class="p">;</span> \
<span class="p">}</span>

<span class="n">PMDL</span> <span class="n">TransferMdl</span><span class="p">;</span>
<span class="n">NTSTATUS</span> <span class="n">Status</span><span class="p">;</span>
<span class="n">PMDL</span> <span class="n">UndoMdl</span><span class="p">;</span>

<span class="c1">// Obtain a mapping to the undo MDL.</span>

<span class="n">Status</span> <span class="o">=</span> <span class="n">SkmmMapDataTransfer</span><span class="p">(</span><span class="n">DataMdl</span><span class="p">,</span> <span class="c1">//XENO: DataMdl ACID in</span>
                              <span class="n">TransferPfn</span><span class="p">,</span>
                              <span class="n">SkmmMapRead</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">TransferMdl</span><span class="p">,</span> <span class="c1">//XENO: TransferMdl ACID out</span>
                              <span class="nb">NULL</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">NT_SUCCESS</span><span class="p">(</span><span class="n">Status</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">Status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">UndoMdl</span> <span class="o">=</span> <span class="n">SkAllocatePool</span><span class="p">(</span><span class="n">NonPagedPoolNx</span><span class="p">,</span> <span class="n">TransferMdl</span><span class="o">-&gt;</span><span class="n">ByteCount</span><span class="p">,</span> <span class="err">'</span><span class="n">ldmM</span><span class="err">'</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="n">UndoMdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
	<span class="k">goto</span> <span class="n">CleanupAndExit</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">OriginalUndoMdl</span> <span class="o">=</span> <span class="n">TransferMdl</span><span class="o">-&gt;</span><span class="n">MappedSystemVa</span><span class="p">;</span> <span class="c1">//XENO: Attacker controls data at address, not address itself</span>
<span class="n">MmInitializeMdl</span><span class="p">(</span><span class="n">UndoMdl</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">OriginalUndoMdl</span><span class="o">-&gt;</span><span class="n">ByteOffset</span><span class="p">,</span> <span class="n">OriginalUndoMdl</span><span class="o">-&gt;</span><span class="n">ByteCount</span><span class="p">);</span>
</code></pre></div></div>

<p>So first, there is an amount of bytes allocated through a variable controlled by the user:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UndoMdl</span> <span class="o">=</span> <span class="n">SkAllocatePool</span><span class="p">(</span><span class="n">NonPagedPoolNx</span><span class="p">,</span> <span class="n">TransferMdl</span><span class="o">-&gt;</span><span class="n">ByteCount</span><span class="p">,</span> <span class="err">'</span><span class="n">ldmM</span><span class="err">'</span><span class="p">);</span>
</code></pre></div></div>

<p>Then, the program calls MmInitializeMdl() in which assigns several variables with user-controlled data in the memory region alloced previously.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">OriginalUndoMdl</span> <span class="o">=</span> <span class="n">TransferMdl</span><span class="o">-&gt;</span><span class="n">MappedSystemVa</span><span class="p">;</span> <span class="c1">//XENO: Attacker controls data at address, not address itself</span>
<span class="n">MmInitializeMdl</span><span class="p">(</span><span class="n">UndoMdl</span><span class="p">,</span> <span class="p">(</span><span class="n">PVOID</span><span class="p">)</span><span class="n">OriginalUndoMdl</span><span class="o">-&gt;</span><span class="n">ByteOffset</span><span class="p">,</span> <span class="n">OriginalUndoMdl</span><span class="o">-&gt;</span><span class="n">ByteCount</span><span class="p">);</span>
</code></pre></div></div>

<p>In consecuence, since the amount of data allocated for the MDL structure is attacker-controlled, an insufficent amount of data for MDL struct can be allocated resulting in the overwritting of adyacent memory region in the execution of MmInitializeMdl() macro resulting in a heap buffer overflow.</p>

<p>In order to fix this vulnerability we have to validate that the allocated space is at least as the size of MDL struct.</p>

<p><br /></p>

<h4 id="23-cve-2020-11901-heap-overflow-in-dns-hostname-parsing">2.3. CVE-2020-11901. Heap-overflow in DNS hostname parsing.</h4>

<p>CVE-2020-11901 is in fact 4 vulnerability in one. Is essentially a heap buffer overflow through hostname parsing in DNS packets.</p>

<p>DNS packets have a formatting for hostname strings that breaks it into “labels”, that are prefixed by a label length byte. So for example, if we have the following hostname in a DNS packet: “www.example.com”, then that string would appear like:</p>

<pre><code class="language-less">3www7example3com0
</code></pre>

<p>The string have been tear apart in substrings in each dot and each substring is preceeded by the substring length. The 0 at the end of the hostname is indicating the end of the whole string.</p>

<p>The DNS spec states that the max label length should be 63 and the hostname length should be 255 bytes.</p>

<p>There is also a compression technique in which in the label in which should appear the substring there is a compression pointer that indicates the offset of the beginning of the label in other part of the DNS packet.</p>

<p>More specifically, acording to the documentation; in order to reduce the size of messages, the domain system utilizes a compression scheme which eliminates the repetition of domain names in a message. In it, an entire domain name or a lsit of lahbels at the end of a domain name is replaced with a pointer to a prior occurance of the same name. The pointer take the form of two octet sequence.</p>

<p>(A compression pointer in DNS is exactly 2 bytes (16 bits) with a specific structure. The first two bits are 11, the remaining 14 bits are the offset from the start of the DNS packet)</p>

<p>This basically means that if we receive “foo.example.com” then, on the DNS packet we would get something like:</p>

<pre><code class="language-less">3foo0xC016
</code></pre>

<p>Instead of</p>

<pre><code class="language-less">3foo7example3com0
</code></pre>

<p>Where 0xC016 is compressed pointer two 22 bytes from the start of the DNS packet or byte 22 of the DNS packet.</p>

<p>Lets observe that, because of design choice, a label cannot occupie more than one byte and since the first two bits are unused to represent the name there 6 bits left, then there is a maximum label length of 2^6-1 = 63.</p>

<p>So, lets check the code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">//ACID: RDLENGTH, resourceRecordAfterNamePtr, dnsHeaderPtr</span>
<span class="k">if</span> <span class="p">(</span><span class="n">RDLENGTH</span> <span class="o">&lt;=</span> <span class="n">remaining_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* compute the next resource record pointer based on the RDLENGTH */</span>
	<span class="n">labelEndPtr</span> <span class="o">=</span> <span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">RDLENGTH</span><span class="p">;</span>
	<span class="cm">/* type: MX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cacheEntryQueryType</span> <span class="o">==</span> <span class="n">DNS_TYPE_MX</span> <span class="o">&amp;&amp;</span> <span class="n">rrtype</span> <span class="o">==</span> <span class="n">DNS_TYPE_MX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_info</span> <span class="o">=</span> <span class="n">tfDnsAllocAddrInfo</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_info</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">RDLENGTH</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy preference value of MX record */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_info</span><span class="o">-&gt;</span><span class="n">ai_mxpref</span><span class="p">,</span><span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="cm">/* compute the length of the MX hostname */</span>
			<span class="n">labelLength</span> <span class="o">=</span> <span class="n">tfDnsExpLabelLength</span><span class="p">(</span><span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">dnsHeaderPtr</span><span class="p">,</span> <span class="n">labelEndPtr</span><span class="p">);</span>
			<span class="n">addr_info</span><span class="o">-&gt;</span><span class="n">ai_mxhostname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">labelLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* allocate buffer for the expanded name */</span>
				<span class="n">asciiPtr</span> <span class="o">=</span> <span class="n">tfGetRawBuffer</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">labelLength</span><span class="p">);</span>
				<span class="n">addr_info</span><span class="o">-&gt;</span><span class="n">ai_mxhostname</span> <span class="o">=</span> <span class="n">asciiPtr</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">asciiPtr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* copy MX hostname to `asciiPtr` as ASCII */</span>
					<span class="n">tfDnsLabelToAscii</span><span class="p">(</span><span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">asciiPtr</span><span class="p">,</span> <span class="n">dnsHeaderPtr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="cm">/* ... */</span>
				<span class="p">}</span>
				<span class="cm">/* ... */</span>
			<span class="p">}</span>
			<span class="cm">/* ... */</span>
		<span class="p">}</span>
	<span class="cm">/* ... */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">tt16Bit</span> <span class="nf">tfDnsExpLabelLength</span><span class="p">(</span><span class="n">tt8BitPtr</span> <span class="n">labelPtr</span><span class="p">,</span> <span class="n">tt8BitPtr</span> <span class="n">pktDataPtr</span><span class="p">,</span> <span class="n">tt8BitPtr</span> <span class="n">labelEndPtr</span><span class="p">){</span>
	<span class="n">tt8Bit</span> <span class="n">currLabelLength</span><span class="p">;</span>
	<span class="n">tt16Bit</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">totalLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tt8BitPtr</span> <span class="n">newLabelPtr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">labelPtr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">labelEndPtr</span> <span class="o">&amp;&amp;</span> <span class="n">labelPtr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">currLabelLength</span> <span class="o">=</span> <span class="n">labelPtr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">currLabelLength</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">totalLength</span> <span class="o">+=</span> <span class="n">currLabelLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">currLabelLength</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">labelPtr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">labelEndPtr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">newLabelPtr</span> <span class="o">=</span> <span class="n">pktDataPtr</span> <span class="o">+</span> <span class="p">(((</span><span class="n">currLabelLength</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">labelPtr</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">newLabelPtr</span> <span class="o">&lt;</span> <span class="n">labelPtr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">labelPtr</span> <span class="o">=</span> <span class="n">newLabelPtr</span><span class="p">;</span>
					<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">totalLength</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At first, our eyes lies down the line:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">addr_info</span> <span class="o">=</span> <span class="n">tfDnsAllocAddrInfo</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">addr_info</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">RDLENGTH</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* copy preference value of MX record */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr_info</span><span class="o">-&gt;</span><span class="n">ai_mxpref</span><span class="p">,</span><span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="c1">//...</span>
</code></pre></div></div>

<p>But, since we are only copy two bytes from source this cannot be considered exploitable so this is not what we are looing for.</p>

<p>Below we can see that there is a memory allocation for <em>addr_info</em></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">addr_info</span> <span class="o">=</span> <span class="n">tfDnsAllocAddrInfo</span><span class="p">();</span>
</code></pre></div></div>

<p>Below, a buffer is allocated with the value stored in <em>labelLength</em> which is formed in <em>tfDnsExpLabelLength()</em> with user-controlled parameters:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">labelLength</span> <span class="o">=</span> <span class="n">tfDnsExpLabelLength</span><span class="p">(</span><span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">dnsHeaderPtr</span><span class="p">,</span> <span class="n">labelEndPtr</span><span class="p">);</span>
<span class="n">addr_info</span><span class="o">-&gt;</span><span class="n">ai_mxhostname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">labelLength</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* allocate buffer for the expanded name */</span>
	<span class="n">asciiPtr</span> <span class="o">=</span> <span class="n">tfGetRawBuffer</span><span class="p">((</span><span class="n">uint</span><span class="p">)</span><span class="n">labelLength</span><span class="p">);</span>
</code></pre></div></div>

<p>Then, this allocated buffer is assigned to a field of addr_info heap-struct and then used in a function in which again performs operations with user-controlled data. Thus, since <em>tfDnsExpLabelLength()</em> is user-controlled, and there is no checks about the size of the allocated buffer, this could be a small one and then the operations performed on this buffer could result in an overflow:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">asciiPtr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* copy MX hostname to `asciiPtr` as ASCII */</span>
	<span class="n">tfDnsLabelToAscii</span><span class="p">(</span><span class="n">resourceRecordAfterNamePtr</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span> <span class="n">asciiPtr</span><span class="p">,</span> <span class="n">dnsHeaderPtr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p><br /></p>

<h4 id="24-cve-2020-25111-part-of-amnesia33-grab-bag">2.4. CVE-2020-25111. Part of “Amnesia:33” grab-bag</h4>

<p>The Ethernut Nut/Net TCP/IP stack is used as part of the Nut/OS Real-Time OS (RTOS) which is used on low-powered IoT devices.</p>

<p>DNS packets have a formatting for hostname strings that breaks it into “labels”, that are prefixed by a string length byte as we see in the previous example.</p>

<p>In this case, we gonna focus in the fact that the total hostname string is considered complete when a 0 is found for a label length (\0 aka null terminator byte for strings), consider for example www.example.com, the formating in a DNS packet of this DNS hostname would be:</p>

<pre><code class="language-less">3www7example3com0
</code></pre>

<p>Consider the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">uint16_t</span> <span class="nf">ScanName</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span> <span class="n">cp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">**</span> <span class="n">npp</span><span class="p">){</span>
	<span class="kt">uint8_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">np</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">npp</span><span class="p">){</span>
		<span class="n">free</span><span class="p">(</span><span class="o">*</span><span class="n">npp</span><span class="p">);</span>
		<span class="o">*</span><span class="n">npp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">cp</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">np</span> <span class="o">=</span> <span class="o">*</span><span class="n">npp</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">){</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
			<span class="o">*</span><span class="n">np</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span><span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">np</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this code there exists a while loop in which an assignation is being performed in a heap chunk:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rc</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">cp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">np</span> <span class="o">=</span> <span class="o">*</span><span class="n">npp</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">){</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">np</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">np</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The allocation is dependant of a parameter <em>cp</em> and the break condition of the while loop in which the assignation is taking place is related with the second slot of the cp buffer.</p>

<p>If <em>cp</em> was user-controlled, the user could pass a malicious <em>cp</em> resulting in an small np chunk allocation. Specifically, since <em>strlen()</em> return the number of bytes until the first null terminator byte is found, <em>cp</em> can contain a null terminator byte at the third position (or so on) which will result in a small alocation of bytes in the heap.</p>

<p>Thus, the assignation would overwrite adyacent heap memory regions resulting in a heap buffer overflow.</p>

<p><br /></p>

<h4 id="25-cve-2020-27009-part-of-namewreck-grab-bag">2.5. CVE-2020-27009. Part of “NAME:WRECK” grab-bag.</h4>

<p>This is a continuation from the DNS hostname. Consider the following code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//// No src was given for GET16() but we will assume it behaves as below:</span>
<span class="cp">#define GET16(base, offset) *(unsigned short *)((void *)(base) + offset)
</span>
<span class="c1">////ACID: pkt</span>
<span class="n">STATUS</span> <span class="nf">DNS_Extract_Data</span> <span class="p">(</span><span class="n">DNS_PKT_HEADER</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">UNSIGNED</span> <span class="o">*</span><span class="n">ttl</span><span class="p">,</span> <span class="n">INT</span> <span class="n">type</span><span class="p">){</span>
	<span class="n">DNS_RR</span>			<span class="o">*</span><span class="n">pr_ptr</span><span class="p">;</span>
	<span class="n">INT</span>			<span class="n">name_size</span><span class="p">,</span> <span class="n">n_answers</span><span class="p">,</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="n">UINT16</span>			<span class="n">length</span><span class="p">;</span>
	<span class="n">CHAR</span>			<span class="o">*</span><span class="n">p_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">n_answers</span> <span class="o">=</span> <span class="n">GET16</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">DNS_ANCOUNT_OFFSET</span><span class="p">);</span>
	<span class="c1">// [...]</span>
	<span class="cm">/* If there is at least one reasonable answer and this is a response, process it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">n_answers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET16</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">DNS_FLAGS_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DNS_QR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Point to where the question starts.*/</span>
		<span class="n">p_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Allocate a block of memory to put the name in */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NU_Allocate_Memory</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">System_Memory</span><span class="p">,</span> <span class="p">(</span><span class="n">VOID</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span>
							<span class="n">DNS_MAX_NAME_SIZE</span><span class="p">,</span>
							<span class="n">NU_NO_SUSPEND</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NU_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">NU_NO_MEMORY</span><span class="p">);</span>
		<span class="p">}</span>
	
		<span class="cm">/* Extract the name. */</span>
		<span class="n">name_size</span> <span class="o">=</span> <span class="n">DNS_Unpack_Domain_Name</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>

		<span class="cm">/*	Move the pointer past the name QTYPE and QCLASS to point at the
			answer section of the response. */</span>
		<span class="n">p_ptr</span> <span class="o">+=</span> <span class="n">name_size</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/*	At this point, there may be several answers. We will take the first
			answer section of the response. */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">n_answers</span><span class="o">--</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="cm">/* Extract the name from the answer. */</span>
			<span class="n">name_size</span> <span class="o">=</span> <span class="n">DNS_Unpack_Domain_Name</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
			<span class="cm">/* Move the pointer past the name. */</span>
			<span class="n">p_ptr</span> <span class="o">+=</span> <span class="n">name_size</span><span class="p">;</span>
			<span class="cm">/* Point to the resource record. */</span>
			<span class="n">rr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">DNS_RR</span> <span class="o">*</span><span class="p">)</span><span class="n">p_ptr</span><span class="p">;</span>
			<span class="c1">// [...]</span>
			<span class="cm">/* Copy the length of this answer. */</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">GET16</span><span class="p">(</span><span class="n">rr_ptr</span><span class="p">,</span> <span class="n">DNS_RDLENGTH_OFFSET</span><span class="p">);</span>
			<span class="c1">// [...]</span>
		<span class="p">}</span>
		<span class="c1">// [...]</span>
	<span class="p">}</span>
	<span class="c1">// [...]</span>
<span class="p">}</span>

<span class="c1">////ACID: src</span>
<span class="n">INT</span> <span class="nf">DNS_Unpack_Domain_Name</span><span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">buf_begin</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">INT16</span>		<span class="n">size</span><span class="p">;</span>
	<span class="n">INT</span>		<span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CHAR</span>		<span class="o">*</span><span class="n">savesrc</span><span class="p">;</span>
	
	<span class="n">savesrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">){</span>
		<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">savesrc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf_begin</span><span class="p">[(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="n">src</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">dst</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">src</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">savesrc</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<p>In the code above first we encounter a GET16() macro definition. This macro is used to access a value from the DNS HEADER using a base and an offset reference. It return the contents of the pointer formed by adding the base pointer the offset distance in bytes (void *) base + offset.</p>

<p>Then, we have the function definition and some declarations:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">STATUS</span> <span class="nf">DNS_Extract_Data</span> <span class="p">(</span><span class="n">DNS_PKT_HEADER</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">UNSIGNED</span> <span class="o">*</span><span class="n">ttl</span><span class="p">,</span> <span class="n">INT</span> <span class="n">type</span><span class="p">){</span>
	<span class="n">DNS_RR</span>			<span class="o">*</span><span class="n">pr_ptr</span><span class="p">;</span>
	<span class="n">INT</span>			<span class="n">name_size</span><span class="p">,</span> <span class="n">n_answers</span><span class="p">,</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="n">UINT16</span>			<span class="n">length</span><span class="p">;</span>
	<span class="n">CHAR</span>			<span class="o">*</span><span class="n">p_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</code></pre></div></div>

<p>Then, after some asignations and constraints, we get that the user-controlled parameter gets assigned to p_ptr:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n_answers</span> <span class="o">=</span> <span class="n">GET16</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">DNS_ANCOUNT_OFFSET</span><span class="p">);</span>
	<span class="c1">// [...]</span>
	<span class="cm">/* If there is at least one reasonable answer and this is a response, process it */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">n_answers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">GET16</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">DNS_FLAGS_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DNS_QR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Point to where the question starts.*/</span>
		<span class="n">p_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div></div>

<p>Then, an alocation is performed to a heap chunk to store the hostname and then the hostname gets extracted from ther DNS header:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Allocate a block of memory to put the name in */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">NU_Allocate_Memory</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">System_Memory</span><span class="p">,</span> <span class="p">(</span><span class="n">VOID</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">DNS_MAX_NAME_SIZE</span><span class="p">,</span> <span class="n">NU_NO_SUSPEND</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NU_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">NU_NO_MEMORY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Extract the name. */</span>
<span class="n">name_size</span> <span class="o">=</span> <span class="n">DNS_Unpack_Domain_Name</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="p">);</span>
</code></pre></div></div>

<p>In order to understand how the hostname is extracted let’s jump opver the <em>DNS_Unpack_Domain_Name()</em> function:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INT</span> <span class="nf">DNS_Unpack_Domain_Name</span><span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">buf_begin</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">INT16</span>		<span class="n">size</span><span class="p">;</span>
	<span class="n">INT</span>		<span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CHAR</span>		<span class="o">*</span><span class="n">savesrc</span><span class="p">;</span>
	
	<span class="n">savesrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">){</span>
		<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">savesrc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf_begin</span><span class="p">[(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="n">src</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span><span class="o">++</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="o">--</span><span class="n">dst</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">src</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">savesrc</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="p">(</span><span class="n">retval</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Consider that, in this call, src and buf_begin are user-controlled (they are respectively p_p5tr and pkt). Thus, first, they perform some declarations and definitions:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INT</span> <span class="nf">DNS_Unpack_Domain_Name</span><span class="p">(</span><span class="n">CHAR</span> <span class="o">*</span> <span class="n">dst</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">CHAR</span> <span class="o">*</span><span class="n">buf_begin</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">INT16</span>		<span class="n">size</span><span class="p">;</span>
	<span class="n">INT</span>		<span class="n">i</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">CHAR</span>		<span class="o">*</span><span class="n">savesrc</span><span class="p">;</span>
	
	<span class="n">savesrc</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
</code></pre></div></div>

<p>Then, enter in the while loop which have as break condition that src contains a null terminator, then the loop proceeds as follows:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">){</span>
	<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xC0</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">src</span> <span class="o">-</span> <span class="n">savesrc</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf_begin</span><span class="p">[(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="o">*</span><span class="n">src</span><span class="p">];</span>
		<span class="n">size</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">src</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
	<span class="c1">//...</span>
</code></pre></div></div>

<p>Here we can see that the within the loop an asignation over the buffer is performed in a for loop which constraint is user-controlled via <em>buf_begin</em>. If we look closely, the for loop iterations can be as much as big as 0x3f + 1 (64) but since the while loop would iterate as long as a null terminator is found in src and src is user-controlled, this for loop could be repeated as necesary to provoke an overflow of the dst allocated chunk resulting in a heap buffer overflow.</p>

<p>Is worth to mention that dst is the name pointer previously allocated in the heap.</p>

<p><br /></p>

<h4 id="26-cve-2021-42739">2.6. CVE-2021-42739.</h4>

<p>This CVE corresponds to a CVE in the Linux Kernel. The IOCTL (Linux Input-Output Control) serve as an interface between userspace and kernel. There is an optional module that exposes an IOCTL interface for controlling a Firewire digital TV (fdtv), thus, user-controlled input can be sended from user-space to kernel via IOCTL.</p>

<p>Lets check the code:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ca_msg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">};</span>

<span class="c1">////ACID: arg</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fdtv_ca_pmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ca_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">data_pos</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">data_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">data_pos</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">avc_ca_pmt</span><span class="p">(</span><span class="n">fdtv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">data_pos</span><span class="p">],</span> <span class="n">data_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctype</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">subunit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">operand</span><span class="p">[</span><span class="mi">509</span><span class="p">];</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">avc_ca_pmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">list_management</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">program_info_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmt_cmd_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">es_info_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crc32_csum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">avc_debug</span> <span class="o">&amp;</span> <span class="n">AVC_DEBUG_APPLICATION_PMT</span><span class="p">))</span>
		<span class="n">debug_pmt</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">ctype</span>   <span class="o">=</span> <span class="n">AVC_CTYPE_CONTROL</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">subunit</span> <span class="o">=</span> <span class="n">AVC_SUBUNIT_TYPE_TUNER</span> <span class="o">|</span> <span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">subunit</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">opcode</span>  <span class="o">=</span> <span class="n">AVC_OPCODE_VENDOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">EN50221_LIST_MANAGEMENT_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">"forcing list_management to ONLY</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">EN50221_LIST_MANAGEMENT_ONLY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We take the cmd_id from the programme level only! */</span>
	<span class="n">list_management</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">program_info_length</span> <span class="o">=</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">program_info_length</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* Remove pmt_cmd_id */</span>
	<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_0</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_1</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_DE_COMPANYID_2</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_OPCODE_HOST2CA</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* slot */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">SFE_VENDOR_TAG_CA_PMT</span><span class="p">;</span> <span class="cm">/* ca tag */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* more/last */</span>
	<span class="cm">/* Use three bytes for length field in case length &gt; 127 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_management</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* pmt_cmd=OK_descramble */</span>

	<span class="cm">/* TS program map table */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* Table id=2 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* Section syntax + length */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* Program number */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* Version number and current/next */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Section number=0 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Last section number=0 */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="cm">/* PCR_PID=1FFF */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span> <span class="cm">/* Program info length */</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* CA descriptors at programme level */</span>
	<span class="n">read_pos</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">write_pos</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
				<span class="s">"invalid pmt_cmd_id %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pmt_cmd_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">program_info_length</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">write_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="p">],</span>
		       <span class="n">program_info_length</span><span class="p">);</span>
		<span class="n">read_pos</span> <span class="o">+=</span> <span class="n">program_info_length</span><span class="p">;</span>
		<span class="n">write_pos</span> <span class="o">+=</span> <span class="n">program_info_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">read_pos</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
		<span class="n">es_info_length</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">read_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">es_info_length</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* Remove pmt_cmd_id */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">es_info_length</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">es_info_length</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">es_info_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pmt_cmd_id</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">"invalid pmt_cmd_id %d at stream level</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
					<span class="n">pmt_cmd_id</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">es_info_length</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span>
					     <span class="n">write_pos</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="p">],</span> <span class="n">es_info_length</span><span class="p">);</span>
			<span class="n">read_pos</span> <span class="o">+=</span> <span class="n">es_info_length</span><span class="p">;</span>
			<span class="n">write_pos</span> <span class="o">+=</span> <span class="n">es_info_length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* CRC */</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_pos</span> <span class="o">-</span> <span class="mi">15</span><span class="p">;</span>

	<span class="n">crc32_csum</span> <span class="o">=</span> <span class="n">crc32_be</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc32_csum</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">pad_operands</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">write_pos</span><span class="p">);</span>

	<span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data_length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">write_pos</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">avc_write</span><span class="p">(</span><span class="n">fdtv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">!=</span> <span class="n">AVC_RESPONSE_ACCEPTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
			<span class="s">"CA PMT failed with response 0x%x</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At a first glance, we don’t manage to see an obvious flaw. Then, lets recheck the code slowly:</p>

<p>First, the main function is <em>fdtv_ca_pmt()</em> in which some user-controlled data gets introduced; <em>arg</em>. Inside the function, <em>arg</em> gets assgined to a pointer to a <em>ca_msg</em> struct. On the other hand there is also other variable <em>data_length</em> which gets filled with user-controlled data, lets see how:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">data_length</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="n">data_pos</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> 
<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">data_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="n">data_pos</span><span class="o">++</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">data_length</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code flow ends up with a if statement in which the boolean condition:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span>
</code></pre></div></div>

<p>Gets evaluated as true or false, note that we got the following conversion:</p>

<pre><code class="language-less">0x80 = 8*16^1 + 0*16^0 = 128
128/2 = 64 + 0, 64/2 = 32 + 0, 32/2 = 16, 16/2 = 8, 8/2 = 4, 4/2 = 2, 2/2 = 1 + 0, 1/2 = 0 + 1 =&gt; 128 = 2*64 = 2*2*32 = 2*2*2*16 = 2*2*2*2*8 = 2*2*2*2*2*4 = 2*2*2*2*2*2*2 = 2^7; 
128 = 1*2^7 + 0*2^6 + 0*2^5 + 0*2^4 + 0*2^3 + 0*2^2 + 0*2^1 + 0*2^0 = 01000000b
</code></pre>

<p>This means that, applying <em>msg-&gt;msg[3] &amp; 0x80</em> we are in fact verificating with the AND bitwise operator if the 7th bit of <em>msg[3]</em> value is up for reasons we dont understand yet. In base of this decision, <em>data_length</em> take two values, in both case, it ends up with user-controlled data so <em>data_length</em> can be considered also attacker controlled along with <em>msg</em>. Also, the shift operation <em>data_length « 8</em> is just forming a big endian byte. Then, ultimately, the function returns the return value of the <em>avc_ca_pmt()</em> function in which introduces both msg and data_length. So we now go on to analyze <em>avc_ca_pmt()</em> function behaviour.</p>

<p>In the <em>avc_ca_pmt()</em> function, there are declarations and then a few definitions:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">avc_ca_pmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">firedtv</span> <span class="o">*</span><span class="n">fdtv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">avc_command_frame</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">avc_response_frame</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fdtv</span><span class="o">-&gt;</span><span class="n">avc_data</span><span class="p">;</span>
	<span class="c1">//...</span>
</code></pre></div></div>

<p>As a general rule, pointers are living-in-the-stack which holds (points to) heap memory address, so we can safely assume that both <em>c</em> and <em>r</em> contents are in the stack. Also, <em>c</em> is a pointer to a <em>avc_command_frame</em> struct which have an <em>operand[509]</em> array, this buffer potentially could overflow in a miscalculated assignation process.</p>

<p>Tracking user-controlled flow within this function, we can tick a few variables:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">read_pos</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">write_pos</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
<span class="c1">//...</span>
<span class="n">list_management</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="n">program_info_length</span> <span class="o">=</span> <span class="p">((</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="n">pmt_cmd_id</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="c1">//...</span>
<span class="n">read_pos</span> <span class="o">+=</span> <span class="n">program_info_length</span><span class="p">;</span>
<span class="n">write_pos</span> <span class="o">+=</span> <span class="n">program_info_length</span><span class="p">;</span>
</code></pre></div></div>

<p>Then, we enter in a while loop with a break-condition controlled by the user since read_pos and length is user-controlled.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">read_pos</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">operand</span><span class="p">[</span><span class="n">write_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">read_pos</span><span class="o">++</span><span class="p">];</span>
	<span class="c1">//...</span>
</code></pre></div></div>

<p>Thus, the while loop can iterate until  <em>write_pos++</em> is greater than 508 and that will result in a buffer overflow.</p>

      </article>

      
        <div class="blog-tags">
          <span>Tags:</span>
          
            <a href="/tags#csoft">csoft</a>
          
        </div>
      

      

      
        <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=%28Linear%29+Heap+Buffer+Overflow.&url=http%3A%2F%2Flocalhost%3A4000%2F2025-11-18-HBO%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2F2025-11-18-HBO%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2F2025-11-18-HBO%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

  

</section>



      

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a class="page-link" href="/2025-11-17-AssemblyBasicRegisters/" data-toggle="tooltip" data-placement="top" title="Basic Instructions.">&larr; Previous Post</a>
        </li>
        
        
        <li class="page-item next">
          <a class="page-link" href="/2025-11-21-CallingFunctions/" data-toggle="tooltip" data-placement="top" title="Calling Functions.">Next Post &rarr;</a>
        </li>
        
      </ul>
      
  
  
  

  


  



    </div>
  </div>
</div>


  <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/Qv1nTv5" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/Qvintvs1" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://linkedin.com/in/german-sanmillan-68b308229/" title="LinkedIn">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">LinkedIn</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
        German
        &nbsp;&bull;&nbsp;
      
      2026

      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>


  
  
    
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  









</body>
</html>
